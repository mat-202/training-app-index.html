<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙØ±Ø¯ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ (Ù…Ø­Ø¯Ø«)</title>
    <style>
        /* -------------------------------------------
        ** 1. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø·
        ** ------------------------------------------- */
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            margin: 0;
            padding-top: 20px; /* Ù…Ø³Ø§Ø­Ø© Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© */
            background-color: #f4f4f9;
            min-height: 100vh;
        }
        
        /* -------------------------------------------
        ** 2. ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
        ** ------------------------------------------- */
        .initiative-header {
            margin: 15px auto 25px auto;
            padding: 15px 15px;
            background-color: #f7f9fc;
            border: 1px solid #ddd;
            border-left: 8px solid #007BFF;
            border-radius: 6px;
            max-width: 95%; /* Ø¬Ø¹Ù„Ù‡Ø§ Ù…Ø±Ù†Ø© */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        .initiative-header .title-line {
            font-size: 1.3em; /* ØªØµØºÙŠØ± Ù‚Ù„ÙŠÙ„ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
            font-weight: bold;
            color: #007BFF;
            margin: 0;
        }
        .main-content {
            display: flex;
            justify-content: center;
            max-width: 100%;
            padding: 0 10px; /* Ù…Ø³Ø§ÙØ© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„Ù‡ÙˆØ§ØªÙ */
            margin: auto;
        }
        .container {
            width: 100%; /* Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø¬ÙˆØ§Ù„ */
            max-width: 600px; /* Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± */
            padding: 20px 15px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ */
            border: 5px solid #28a745;
            border-radius: 15px;
            background-color: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin: 0;
        }

        h1 {
            color: #28a745;
            font-size: 1.8em; /* ØªØ­Ø³ÙŠÙ† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
            margin-bottom: 20px;
        }

        /* -------------------------------------------
        ** 3. Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        ** ------------------------------------------- */
        .names-input-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            display: flex;
            flex-direction: column; /* ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
            align-items: stretch;
            gap: 10px;
        }
        #student-name-input {
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #28a745;
            border-radius: 6px;
            width: auto; /* Ø¹Ø±Ø¶ Ù…Ø±Ù† */
            text-align: center; /* Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ù†Øµ Ù„Ù„ÙˆØ³Ø· ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
        }
        
        .round-setup {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 1fr; /* Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ù„Ù„Ø¬ÙˆØ§Ù„ */
            gap: 15px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        }
        .round-setup label {
            font-weight: bold;
            font-size: 1.1em;
            display: block; /* Ù„Ø¶Ù…Ø§Ù† Ø£Ø®Ø° Ø§Ù„Ø³Ø·Ø± ÙƒØ§Ù…Ù„Ø§Ù‹ */
            text-align: right;
        }
        .round-setup select, #activate-training-btn, .nav-btn {
            padding: 12px; /* Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ¹Ù†Ø§ØµØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
            font-size: 1.2em;
            border-radius: 8px;
            width: 100%; /* Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ */
            box-sizing: border-box; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø±Ø¶ */
        }
        
        /* Ø¥Ø¹Ø§Ø¯Ø© ØªØ®Ø·ÙŠØ· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø© */
        #level-navigation {
            display: none;
            flex-direction: column; /* Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¶ØºØ· */
            gap: 15px;
            width: 100%;
        }

        /* -------------------------------------------
        ** 4. Ù‚Ø³Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ù…Ø¤Ù‚Øª
        ** ------------------------------------------- */
        .header-section {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 3px solid #eee;
            padding-bottom: 10px;
        }
        #timer-display {
            font-size: 2.5em; /* ØªØµØºÙŠØ± Ø§Ù„Ù…Ø¤Ù‚Øª Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            font-weight: bold;
            color: #333;
            padding: 5px 15px;
            border: 3px dashed #FFC107;
            border-radius: 10px;
            min-width: 120px;
        }
        #turn-indicator {
            font-size: 1.1em;
            text-align: right;
            flex-grow: 1;
            padding-left: 10px;
        }

        #question {
            font-size: 3.5em; /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© */
            margin: 20px auto;
            color: #333;
            min-height: 120px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø§Ø±ØªÙØ§Ø¹ */
            width: 100%;
            text-align: center;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* -------------------------------------------
        ** 5. ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø±Ø£Ø³ÙŠØ© (Ù…Ù‡Ù… Ù„Ù„Ø¢ÙŠÙÙˆÙ†)
        ** ------------------------------------------- */
        .q-line { 
             display: flex; 
             justify-content: flex-end; 
             direction: rtl; 
             padding-bottom: 3px; 
             max-width: 300px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
             margin: 0 auto; 
             font-size: 0.8em; /* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ */
        }
        /* Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø· Ø£Ø­Ø§Ø¯ÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ© */
        .vertical-aligned-number {
             direction: ltr; 
             display: inline-block; 
             font-family: monospace, 'Courier New', monospace; 
             white-space: pre; 
             text-align: right; 
             align-self: flex-end;
        }
        #q-line-separator { 
            width: 80%; /* Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø· Ø§Ù„ÙØ§ØµÙ„ */
            max-width: 300px;
            height: 3px; 
            background-color: #333; 
            margin: 5px auto 10px auto; 
        }
        #q-op2 { 
            font-size: 0.8em;
            margin-left: 5px; 
        } 
        #expression-display {
             font-size: 0.4em; /* ØªØµØºÙŠØ± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        }
        
        /* -------------------------------------------
        ** 6. Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©) - ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§
        ** ------------------------------------------- */
        #answer-choices {
            /* ğŸ’¥ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ø´Ø¨ÙƒØ© 2x2 */
            display: grid; 
            grid-template-columns: 1fr 1fr; /* Ø¹Ù…ÙˆØ¯Ø§Ù† Ù…ØªØ³Ø§ÙˆÙŠØ§Ù† */
            grid-gap: 10px; /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø®Ù„Ø§ÙŠØ§ */
            margin-top: 20px;
            justify-content: center; /* Ù„Ù„Ù…Ø±Ø§ÙƒØ²Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø±Ø¶ Ø£ØµØºØ± Ù…Ù† max-width */
        }
        .choice-btn {
            padding: 15px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´Ùˆ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© */
            font-size: 1.8em; /* Ø®Ø· ÙƒØ¨ÙŠØ± Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù„Ù…Ø³ */
            /* âŒ ØªÙ… Ø­Ø°Ù: width: 48%; */
            min-height: 80px; /* Ø­Ø¯ Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¶ØºØ· */
            border: 3px solid #007BFF;
            border-radius: 12px;
            background-color: #e9f4ff;
            color: #007BFF;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: bold;
            box-sizing: border-box;
        }
        .choice-btn:active {
            transform: translateY(0); /* Ø¥Ù„ØºØ§Ø¡ Ø­Ø±ÙƒØ© Ø§Ù„Ù€ hover Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            box-shadow: none;
        }
        .correct, .wrong { 
            font-size: 1.5em; /* ØªØµØºÙŠØ± Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
        }

        /* -------------------------------------------
        ** 7. Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø©
        ** ------------------------------------------- */
        .score-boards {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border-top: 1px solid #ddd;
            font-size: 0.9em;
            text-align: center;
        }
        
        /* -------------------------------------------
        ** 8. ØªØ®ØµÙŠØµ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£ÙƒØ¨Ø± (> 600px)
        ** ------------------------------------------- */
        @media (min-width: 600px) {
            .names-input-section {
                flex-direction: row; /* Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø£ÙÙ‚ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
                justify-content: center;
            }
            #student-name-input {
                width: 350px;
                text-align: right;
            }
            .round-setup {
                grid-template-columns: repeat(4, auto); /* Ø¥Ø¹Ø§Ø¯Ø© ØªØ®Ø·ÙŠØ· Ø§Ù„Ø´Ø¨ÙƒØ© */
                justify-content: center;
            }
            .round-setup select {
                width: auto;
            }
            #activate-training-btn {
                grid-column: span 4;
            }
            #level-navigation {
                flex-direction: row;
                justify-content: center;
                gap: 20px;
            }
            .choice-btn {
                width: auto; /* ØªØ±Ùƒ Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù€ Grid */
                padding: 25px 35px;
                font-size: 2.2em;
            }
            .choice-btn:hover { /* Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­ÙˆÙŠÙ… Ù„Ù„Ù…Ø§ÙˆØ³ */
                background-color: #cce0ff; 
                transform: translateY(-3px); 
                box-shadow: 0 5px 10px rgba(0, 123, 255, 0.3);
            }
        }
        
    </style>
</head>
<body> 

<div class="initiative-header">
    <p class="title-line">Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙØ±Ø¯ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ</p>
</div>
<div class="main-content">
    <div class="container" id="game-container">
        <h1>Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
        
        <div class="names-input-section" id="names-input-section">
             <label for="student-name-input">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</label>
             <input type="text" id="student-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">
        </div> 

        <div class="round-setup" id="training-setup">
            
            <label for="initial-level-select">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„ÙŠ:</label>
            <select id="initial-level-select">
                <option value="1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</option>
                <option value="2">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2</option>
                <option value="3">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3</option>
                <option value="4">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4</option>
                <option value="5">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5</option>
            </select>
            
            <label for="operation-select">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
            <select id="operation-select">
                <option value="+">Ø¬Ù…Ø¹</option>
                <option value="-">Ø·Ø±Ø­</option>
                <option value="*">Ø¶Ø±Ø¨</option>
                <option value="/">Ù‚Ø³Ù…Ø©</option>
                <option value="R">ØªÙ‚Ø±ÙŠØ¨</option>
                <option value="EVAL">ØªÙ‚ÙˆÙŠÙ… (20 Ø³Ø¤Ø§Ù„)</option>
            </select> 

            <label for="time-limit-select">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©:</label>
            <select id="time-limit-select">
                <option value="30">30 Ø«Ø§Ù†ÙŠØ©</option>
                <option value="60">Ø¯Ù‚ÙŠÙ‚Ø©</option>
                <option value="90">Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ†ØµÙ</option>
                <option value="120">Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†</option>
            </select>
            
            <button id="activate-training-btn" onclick="initializeGame()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</button> 
            
            <div id="level-navigation">
                <button id="next-level-btn" class="nav-btn" onclick="startNewLevel(true)">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button id="repeat-level-btn" class="nav-btn" onclick="startNewLevel(false)">Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
            </div>
        </div> 

        <div class="header-section">
            <div id="turn-indicator">
                Ø§Ù„Ù…ØªØ¯Ø±Ø¨: <span id="current-player" class="player-turn">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</span>
            </div>
            <div id="timer-display">30 Ø«ÙˆØ§Ù†Ù</div> 
        </div> 

        <div id="question">
             <div id="expression-display">Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
             
             <div class="q-line" id="q-line-1" style="display: none;">
                 <span id="q-num1"></span>
                 <span id="q-op"></span> 
             </div>
             <div class="q-line" id="q-line-2" style="display: none;">
                 <span id="q-op2"></span>
                 <span id="q-num2"></span>
             </div>
             <div id="q-line-separator" style="display: none;"></div>
        </div> 
        
        <div id="answer-choices">
        </div> 

        <div id="feedback"></div> 

        <div class="score-boards">
             <div id="progress-display"></div>
        </div>
    </div> 

</div> 

<div class="footer">
    Ø¥Ø¹Ø¯Ø§Ø¯: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø­Ø¬ÙŠÙ„ÙŠ
</div> 
<script>
    let correctAnswer = 0;
    let isProcessing = false;
    let gameStarted = false; 

    let currentStudent = ""; 
    let globalScores = {}; 

    let TIME_LIMIT = 30; 
    let timeRemaining = TIME_LIMIT;
    let timerInterval; 

    const ARABIC_LOCALE = 'ar-SA'; 
    
    const TRAINING_MASTER_THRESHOLD = 13; // 
    
    const LEVEL_QUESTIONS = {
        1: 15, 
        2: 15, 
        3: 15, 
        4: 15, 
        5: 15  
    }; 

    const EVALUATION_QUESTIONS_TOTAL = 20; 
    const EVALUATION_OPS = ['+', '-', '*', '/', 'R']; 
    const OPS_SEQUENCE = ['+', '-', '*', '/', 'R']; 
    let evaluationQuestionsQueue = []; 
    
    let currentLevel = 1; 
    let levelCorrectAnswers = 0;
    let levelQuestionsAnswered = 0;
    
    let currentQuestionQueue = []; 
    
    const encouragingPhrases = [
        "Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù…ØªØ§Ø²Ø©! Ø£Ù†Øª Ø¹Ø¨Ù‚Ø±ÙŠ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨! ğŸš€",
        "Ù…Ø°Ù‡Ù„! Ù‡Ø°Ù‡ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„ØµÙ…ÙŠÙ…! âœ¨",
        "Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙ…ÙŠØ². ğŸ’ª",
        "Ø¥ØªÙ‚Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ! Ø£Ù†Øª Ø³Ø±ÙŠØ¹ ÙˆØ°ÙƒÙŠ. ğŸ§ ",
        "ÙŠØ§ Ù„Ù‡ Ù…Ù† ØªØ±ÙƒÙŠØ²! Ø¥Ø¬Ø§Ø¨ØªÙƒ ØµØ­ÙŠØ­Ø© 100%. âœ…",
        "Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹! Ø®Ø·ÙˆØ§ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ø¥ØªÙ‚Ø§Ù† Ø«Ø§Ø¨ØªØ©. ğŸŒŸ",
        "Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©ØŒ ØªÙ‚Ø¯Ù… Ù…Ù…ØªØ§Ø²! ğŸ‘",
        "Ø£Ø¯Ø§Ø¡ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¥Ø´Ø§Ø¯Ø©! Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù‚Ù…Ø©. ğŸ†"
    ]; 

    function getRandomEncouragingPhrase() {
        const index = Math.floor(Math.random() * encouragingPhrases.length);
        return encouragingPhrases[index];
    } 

    function saveGlobalScores() {
        try {
            localStorage.setItem('mathHeroesTrainingScores', JSON.stringify(globalScores));
            localStorage.setItem('mathHeroesCurrentStudentName', document.getElementById('student-name-input').value); 
        } catch (e) {
            console.error("Could not save scores to localStorage", e);
        }
    } 

    function loadGlobalScores() {
        try {
            const savedScores = localStorage.getItem('mathHeroesTrainingScores');
            if (savedScores) {
                globalScores = JSON.parse(savedScores);
            } else {
                globalScores = {};
            }
            
            const savedName = localStorage.getItem('mathHeroesCurrentStudentName');
            if (savedName) {
                document.getElementById('student-name-input').value = savedName;
                currentStudent = savedName; 
            }
        } catch (e) {
            console.error("Could not load scores from localStorage", e);
            globalScores = {}; 
        }
    }
    
    function clearTimer() {
        clearInterval(timerInterval);
        document.getElementById('timer-display').style.color = '#333';
    }
    
    function handleTimeUp() {
        if (!gameStarted || isProcessing) return; 

        clearTimer();
        isProcessing = true; 
        
        disableChoices(true);
        
        const roundedCorrect = parseFloat(correctAnswer.toFixed(4));
        document.getElementById('feedback').innerHTML = `<span class="wrong">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: **${formatResult(roundedCorrect)}**</span>`;
        
        handleTrainingAnswer(false); 

        isProcessing = false;
    } 

    function startTimer(duration) {
        clearTimer(); 
        timeRemaining = duration;
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.innerHTML = `${timeRemaining.toLocaleString(ARABIC_LOCALE)} Ø«ÙˆØ§Ù†Ù`; 

        timerInterval = setInterval(() => {
            timeRemaining -= 1;
            timerDisplay.innerHTML = `${timeRemaining.toLocaleString(ARABIC_LOCALE)} Ø«ÙˆØ§Ù†Ù`; 

            if (timeRemaining <= 5) { 
                timerDisplay.style.color = 'red';
            } else {
                timerDisplay.style.color = '#333';
            } 

            if (timeRemaining <= 0) {
                handleTimeUp();
            }
        }, 1000); 
    }
    
    function updateTrainingProgressDisplay() {
        const opType = document.getElementById('operation-select').value;
        const totalQuestionsForLevel = LEVEL_QUESTIONS[currentLevel] || 15; 
        
        let details = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: **${currentLevel}**`;
        let thresholdInfo = `(Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¥ØªÙ‚Ø§Ù†: ${TRAINING_MASTER_THRESHOLD.toLocaleString(ARABIC_LOCALE)})`; 

        if (opType === 'EVAL') {
             details = `ØªÙ‚ÙˆÙŠÙ… Ø´Ø§Ù…Ù„`;
             thresholdInfo = `(Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${(EVALUATION_QUESTIONS_TOTAL - levelQuestionsAnswered).toLocaleString(ARABIC_LOCALE)})`;
        } else {
             thresholdInfo = `(Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: **${(totalQuestionsForLevel - levelQuestionsAnswered).toLocaleString(ARABIC_LOCALE)}** Ø³Ø¤Ø§Ù„)`;
        } 

        document.getElementById('progress-display').innerHTML = 
            `Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ: **${currentStudent}** | ${details}<br>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${levelCorrectAnswers.toLocaleString(ARABIC_LOCALE)} / ${levelQuestionsAnswered.toLocaleString(ARABIC_LOCALE)}<br>
             ${thresholdInfo}<br>
             Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©: **${(globalScores[currentStudent] || 0).toLocaleString(ARABIC_LOCALE)}**`;
    }
    
    function getNextOperation(currentOp) {
        const currentIndex = OPS_SEQUENCE.indexOf(currentOp);
        if (currentIndex === -1 || currentIndex === OPS_SEQUENCE.length - 1) {
            return null; 
        }
        return OPS_SEQUENCE[currentIndex + 1];
    }


    function handleTrainingAnswer(isCorrect) {
        levelQuestionsAnswered++;
        if (isCorrect) {
            levelCorrectAnswers++;
            globalScores[currentStudent] = (globalScores[currentStudent] || 0) + 1; 
            saveGlobalScores();
        } 

        updateTrainingProgressDisplay();
        
        const opType = document.getElementById('operation-select').value;
        const totalQuestions = LEVEL_QUESTIONS[currentLevel] || 15; 

        if (opType === 'EVAL') {
             if (levelQuestionsAnswered >= EVALUATION_QUESTIONS_TOTAL) {
                processEvaluationEnd();
             } else {
                setTimeout(generateQuestion, 2000); 
             }
        } else {
             if (levelQuestionsAnswered >= totalQuestions) {
                processTrainingLevelEnd();
             } else {
                setTimeout(generateQuestion, 2000); 
             }
        }
    }
    
    function processEvaluationEnd() {
        clearTimer(); 
        disableChoices(true);
        document.getElementById('level-navigation').style.display = 'flex';
        document.getElementById('next-level-btn').textContent = `Ø§Ø¨Ø¯Ø£ Ù…Ø³ØªÙˆÙ‰ ØªØ¯Ø±ÙŠØ¨ Ø¬Ø¯ÙŠØ¯`;
        document.getElementById('repeat-level-btn').textContent = `Ø£Ø¹Ø¯ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…`;
        document.getElementById('repeat-level-btn').style.display = 'inline-block';
        
        const percentage = (levelCorrectAnswers / EVALUATION_QUESTIONS_TOTAL) * 100;
        
        let message = `<h1>âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…! Ù†ØªØ§Ø¦Ø¬ **${currentStudent}** Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</h1>
                         <h2>Ø§Ù„Ù†ØªÙŠØ¬Ø©: **${levelCorrectAnswers.toLocaleString(ARABIC_LOCALE)}/${EVALUATION_QUESTIONS_TOTAL.toLocaleString(ARABIC_LOCALE)}** (${percentage.toFixed(1).toLocaleString(ARABIC_LOCALE)}%)</h2>`;
        
        document.getElementById('feedback').innerHTML = message;
        document.getElementById('expression-display').textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©...';
    } 

    function processTrainingLevelEnd() {
        clearTimer(); 
        const totalQuestions = LEVEL_QUESTIONS[currentLevel] || 15; 
        const mastered = levelCorrectAnswers >= TRAINING_MASTER_THRESHOLD;
        const currentOp = document.getElementById('operation-select').value;
        
        document.getElementById('level-navigation').style.display = 'flex';
        disableChoices(true);
        
        if (mastered) {
             
             if (currentLevel >= 5) {
                const nextOp = getNextOperation(currentOp);
                
                if (nextOp) {
                     document.getElementById('feedback').innerHTML = `<h1>ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ØªÙ‚Ù†Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${currentLevel}** Ù„Ø¹Ù…Ù„ÙŠØ© ${currentOp === 'R' ? 'Ø§Ù„ØªÙ‚Ø±ÙŠØ¨' : currentOp} !</h1>
                                                                     <h2>ØªÙ†ØªÙ‚Ù„ Ø§Ù„Ø¢Ù† Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1 Ù„Ø¹Ù…Ù„ÙŠØ© ${nextOp === 'R' ? 'Ø§Ù„ØªÙ‚Ø±ÙŠØ¨' : nextOp}.</h2>`;
                     document.getElementById('next-level-btn').textContent = `âœ… Ø§Ø¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© ${nextOp === 'R' ? 'Ø§Ù„ØªÙ‚Ø±ÙŠØ¨' : nextOp} - Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1`;
                     document.getElementById('repeat-level-btn').style.display = 'none'; 
                } else {
                     document.getElementById('feedback').innerHTML = `<h1>ğŸ† ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ØªÙ‚Ù†Øª Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª!</h1>`;
                     resetGameDisplay();
                     document.getElementById('activate-training-btn').style.display = 'block';
                     return;
                }
             } else {
                 document.getElementById('feedback').innerHTML = `<h1>ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ØªÙ‚Ù†Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${currentLevel}**! ğŸ‰</h1>`;
                 const nextLevel = currentLevel + 1;
                 document.getElementById('next-level-btn').textContent = `âœ… Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${nextLevel}`;
                 document.getElementById('repeat-level-btn').textContent = `ğŸ”„ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel}`;
             } 

             document.getElementById('next-level-btn').style.display = 'inline-block'; 
             document.getElementById('repeat-level-btn').style.display = 'inline-block'; 
             
        } else {
             document.getElementById('feedback').innerHTML = `<h1>ğŸ¤” Ù„Ù… ØªØªÙ‚Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${currentLevel}** ( ${levelCorrectAnswers}/${totalQuestions} ).</h1>`;
             
             document.getElementById('next-level-btn').style.display = 'none'; 
             document.getElementById('repeat-level-btn').textContent = `ğŸ”„ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel}`;
             document.getElementById('repeat-level-btn').style.display = 'inline-block';
        }
        
        document.getElementById('expression-display').textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©...';
    }
    
    function initializeEvaluationQueue(level) {
        evaluationQuestionsQueue = [];
        const questionsPerOp = EVALUATION_QUESTIONS_TOTAL / EVALUATION_OPS.length; 
        
        EVALUATION_OPS.forEach(op => {
            for (let i = 0; i < questionsPerOp; i++) {
                evaluationQuestionsQueue.push(op);
            }
        });
        
        for (let i = evaluationQuestionsQueue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [evaluationQuestionsQueue[i], evaluationQuestionsQueue[j]] = [evaluationQuestionsQueue[j], evaluationQuestionsQueue[i]];
        }
    }
    
    function generateTableQuestionQueue(level, op) {
        let queue = [];
        
        const ranges = {
            1: [1, 2, 3], 
            2: [4, 5, 6], 
            3: [7, 8, 9, 10]
        }; 

        const fixedNumbers = ranges[level]; 
        
        fixedNumbers.forEach(fixedNum => {
            for (let i = 1; i <= 10; i++) { 
                if (op === '*') {
                    queue.push({ n1: fixedNum, n2: i, op: '*' }); 
                } else if (op === '/') {
                    const n2 = fixedNum;
                    const result = i;
                    const n1 = fixedNum * i;
                    queue.push({ n1: n1, n2: n2, op: '/' });
                }
            }
        }); 

        for (let i = queue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [queue[i], queue[j]] = [queue[j], queue[i]];
        }
        
        return queue;
    }
    
    function startNewLevel(moveToNext = false) {
        let opType = document.getElementById('operation-select').value;
        const initialSelectedLevel = parseInt(document.getElementById('initial-level-select').value); 
        TIME_LIMIT = parseInt(document.getElementById('time-limit-select').value);
        
        if (moveToNext && opType !== 'EVAL' && currentLevel >= 5 && levelCorrectAnswers >= TRAINING_MASTER_THRESHOLD) {
             const nextOp = getNextOperation(opType);
             if (nextOp) {
                document.getElementById('operation-select').value = nextOp;
                document.getElementById('initial-level-select').value = 1;
                currentLevel = 1;
                opType = nextOp; 
             } else {
                 return;
             }
        } 

        if (opType !== 'EVAL') {
             if (moveToNext && levelQuestionsAnswered > 0) {
                currentLevel++; 
             } else if (levelQuestionsAnswered === 0 || opType !== document.getElementById('operation-select').value) { 
                currentLevel = parseInt(document.getElementById('initial-level-select').value);
             } 
             
             if (currentLevel > 5) {
                return; 
             }
             
             if (currentLevel <= 3 && (opType === '*' || opType === '/')) {
                currentQuestionQueue = generateTableQuestionQueue(currentLevel, opType);
             } else {
                currentQuestionQueue = []; 
             }
             
             document.getElementById('initial-level-select').value = currentLevel; 
        } else {
             currentLevel = initialSelectedLevel;
             initializeEvaluationQueue(currentLevel);
        }
        
        document.getElementById('level-navigation').style.display = 'none'; 

        document.getElementById('current-player').innerHTML = `**${currentStudent}** (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel})`;
        document.getElementById('current-player').style.color = '#28a745';
        
        levelCorrectAnswers = 0;
        levelQuestionsAnswered = 0;
        
        disableChoices(false);
        updateTrainingProgressDisplay(); 
        
        document.getElementById('feedback').innerHTML = `<span class="correct">Ø¨Ø¯Ø¡ ${opType === 'EVAL' ? 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø´Ø§Ù…Ù„' : `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${currentLevel}**`} Ù„Ù€ **${currentStudent}**... Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚!</span>`;
        
        setTimeout(generateQuestion, 500); 
    }
    
    function resetGameDisplay() {
        clearTimer();
        gameStarted = false;
        
        document.getElementById('activate-training-btn').style.display = 'block'; 
        document.getElementById('level-navigation').style.display = 'none'; 
        
        document.getElementById('names-input-section').style.display = 'flex';
        disableChoices(true);
        
        document.getElementById('current-player').innerHTML = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ';
        document.getElementById('current-player').style.color = '#333';
        
        const selectedTime = document.getElementById('time-limit-select').value;
        TIME_LIMIT = parseInt(selectedTime);
        document.getElementById('timer-display').innerHTML = `${TIME_LIMIT.toLocaleString(ARABIC_LOCALE)} Ø«ÙˆØ§Ù†Ù`;
        
        document.getElementById('feedback').innerHTML = '';
        document.getElementById('progress-display').innerHTML = '';
        
        document.getElementById('expression-display').textContent = 'Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
        
        currentQuestionQueue = []; 

        currentLevel = 1; 
    } 

    function initializeGame() { 
        
        const nameInput = document.getElementById('student-name-input').value.trim();
        
        if (nameInput.length === 0) { 
            document.getElementById('feedback').innerHTML = `<span class="wrong">âŒ Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ **Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨** Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨.</span>`;
            document.getElementById('activate-training-btn').style.display = 'block'; 
            return;
        }
        
        currentStudent = nameInput;
        
        if (globalScores[currentStudent] === undefined) {
             globalScores[currentStudent] = 0;
        }
        saveGlobalScores(); 
        
        gameStarted = true;
        currentLevel = parseInt(document.getElementById('initial-level-select').value); 
        TIME_LIMIT = parseInt(document.getElementById('time-limit-select').value); 

        document.getElementById('activate-training-btn').style.display = 'none'; 
        document.getElementById('level-navigation').style.display = 'flex'; 
        
        const opType = document.getElementById('operation-select').value;
        if (opType === 'EVAL') {
             document.getElementById('next-level-btn').textContent = `âœ… Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…`;
             document.getElementById('repeat-level-btn').style.display = 'none';
        } else {
             document.getElementById('next-level-btn').textContent = `âœ… Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel}`;
             document.getElementById('repeat-level-btn').style.display = 'none';
        } 

        document.getElementById('names-input-section').style.display = 'none';
        
        document.getElementById('current-player').innerHTML = 'Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
        document.getElementById('current-player').style.color = '#007BFF';
        
        updateTrainingProgressDisplay(); 

        let startMessage = `âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù€ **${currentStudent}**. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± **Ø§Ù„Ø¨Ø¯Ø¡**!`;
        document.getElementById('feedback').innerHTML = `<span class="correct">${startMessage}</span>`;
    } 

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function getRandomElement(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }
    
    function alignVertical(n1, n2) {
        const space = ' '; 
        
        const n1String = formatResult(n1, false); 
        const n2String = formatResult(n2, false); 
        
        const length1 = n1String.replace(/,/g, '').length;
        const length2 = n2String.replace(/,/g, '').length;
        
        const maxLength = Math.max(length1, length2);
        
        const padFormattedNumber = (numStr, targetLength) => {
            const currentLength = numStr.replace(/,/g, '').length;
            const paddingNeeded = targetLength - currentLength;
            
            let paddedString = numStr;
            for (let i = 0; i < paddingNeeded; i++) {
                paddedString = space + paddedString;
            }
            return paddedString;
        }; 

        const padded_final1 = padFormattedNumber(n1String, maxLength);
        const padded_final2 = padFormattedNumber(n2String, maxLength); 

        const style = ``; 

        return {
            n1Display: `<span class="vertical-aligned-number" style="${style}">${padded_final1}</span>`,
            n2Display: `<span class="vertical-aligned-number" style="${style}">${padded_final2}</span>`, 
        };
    }
    
    function generateNumberWithDigits(maxDigits, maxDecimals = 0) {
        if (maxDigits <= 0) return 0;
        
        let integerDigits = maxDigits; 
        
        let decimalDigits = 0;
        if (maxDecimals > 0) {
            const remainingDigits = Math.max(0, maxDigits - integerDigits);
            decimalDigits = getRandomInt(0, Math.min(maxDecimals, remainingDigits));
        } 

        let minInt = (integerDigits === 1) ? 1 : Math.pow(10, integerDigits - 1);
        let maxInt = Math.pow(10, integerDigits) - 1;
        
        if (maxInt > 99999) maxInt = 99999; 
        
        let number = Math.floor(Math.random() * (maxInt - minInt + 1)) + minInt;
        
        if (decimalDigits > 0) {
            let decimalPart = Math.random();
            number = parseFloat((number + decimalPart).toFixed(decimalDigits));
        }
        
        return number;
    }
    
    function getNumberBounds(level, op) {
        const MAX_TOTAL_DIGITS = 5; 
        
        switch (op) {
            case '+': 
            case '-':
                const numDigits = Math.min(level, MAX_TOTAL_DIGITS);
                // **ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯:** ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ù†Ø§Ø²Ù„ Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ø¥Ù„Ù‰ ØµÙØ± (0)
                const dec = 0; 
                return { d1: numDigits, d2: numDigits, dec: dec }; 
                
            case '*':
                if (level <= 3) return { d1: 1, d2: 1, dec: 0 }; 
                if (level === 4) return { d1: getRandomInt(2, 3), d2: 1, dec: 0 }; 
                if (level === 5) return { d1: getRandomInt(2, 4), d2: 2, dec: 0 };
                break;
                
            case '/':
                if (level <= 3) return { d1: 1, d2: 1, dec: 0 }; 
                if (level === 4) return { d1: getRandomInt(2, 3), d2: 1, dec: 0 }; 
                if (level === 5) return { d1: getRandomInt(2, 4), d2: 2, dec: 0 };
                break;
        }
        return { d1: 1, d2: 1, dec: 0 };
    }
    
    function generateOperationQuestion(level, op) {
        const bounds = getNumberBounds(level, op);
        let n1, n2, result;
        
        const maxDigits1 = bounds.d1;
        const maxDigits2 = bounds.d2;
        const maxDecimals = bounds.dec || 0; 
        
        let attempts = 0;
        const maxAttempts = 20; 

        do {
            attempts++;
            
            n1 = generateNumberWithDigits(maxDigits1, maxDecimals);
            n2 = generateNumberWithDigits(maxDigits2, maxDecimals);
            
            if ((op === '*' || op === '/') && (n1 < n2)) {
                [n1, n2] = [n2, n1]; 
            }
            
            if (op === '/') {
                if (n2 === 0) continue; 
                
                let factor = Math.abs(Math.round(n1 / n2));
                if (factor === 0) factor = 1; 
                n1 = factor * Math.abs(n2); 
                n2 = Math.abs(n2);
                result = factor;
                
            } else if (op === '*') {
                result = n1 * n2;
            } else if (op === '-') {
                 if (n1 <= n2) {
                     let tempN1, tempN2;
                     do {
                         tempN1 = generateNumberWithDigits(bounds.d1, maxDecimals);
                         tempN2 = generateNumberWithDigits(bounds.d2, maxDecimals);
                     } while (tempN1 <= tempN2);
                     n1 = tempN1;
                     n2 = tempN2;
                 }
                 result = (maxDecimals === 0) ? Math.round(n1 - n2) : n1 - n2;
            } else { 
                result = (maxDecimals === 0) ? Math.round(n1 + n2) : n1 + n2;
            }
            
        } while (attempts < maxAttempts && op !== 'R' && (result <= 0 || (op === '*' && result === 0) ));


        if (op === '*' && level === 5) result = parseFloat(result.toFixed(4));
        // ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ø®Ø§Øµ Ù…Ø¹ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø´Ø±ÙŠØ© Ù‡Ù†Ø§ Ù„Ù€ (+) Ùˆ (-) Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ getNumberBounds
        if (op === '+' || op === '-') {
             result = Math.round(result); // Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù†Ø§ØªØ¬ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­
        } 

        return { n1, n2, result };
    } 

    function generateOperationQuestionFromParams(n1, n2, op) {
         let result;
         if (op === '*') {
             result = n1 * n2;
         } else if (op === '/') {
             result = n1 / n2;
         }
         return { n1, n2, result: Math.round(result) };
    }
    
    function generateRoundingQuestion(level) {
        let numberToRound;
        let roundingPlaceKey;
        let correctAnswerValue;
        
        const generateNumberForRounding = (maxIntDigits, minDecimals, maxDecimals) => {
             const totalDigitsAvailable = 5; 
             
             const actualMaxIntDigits = Math.min(maxIntDigits, totalDigitsAvailable - minDecimals);
             
             if (actualMaxIntDigits <= 0) {
                 const num = Math.random();
                 return parseFloat(num.toFixed(maxDecimals));
             } 

             const maxInt = Math.pow(10, actualMaxIntDigits) - 1;
             const minInt = (actualMaxIntDigits === 1) ? 1 : Math.pow(10, actualMaxIntDigits - 1);
             
             const integerPart = getRandomInt(minInt, maxInt);
             
             let decimalPart = Math.random();
             let number = parseFloat((integerPart + decimalPart).toFixed(maxDecimals)); 

             let numStr = number.toFixed(maxDecimals);
             
             return parseFloat(numStr); 
        };
        
        const MAX_TOTAL_DIGITS = 5; 
        
        if (level === 1) {
            const options = ['Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©', 'Ø£Ù‚Ø±Ø¨ Ù…Ø¦Ø©'];
            roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
            
            let maxDigits;
            if (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©') maxDigits = 4; 
            else maxDigits = 5; 
            
            numberToRound = Math.floor(Math.random() * (Math.pow(10, maxDigits) - 10) + 10); 
            
            const value = (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©') ? 10 : 100;
            correctAnswerValue = Math.round(numberToRound / value) * value; 

        } else if (level === 2) {
             const options = ['Ø£Ù‚Ø±Ø¨ Ø£Ù„Ù', 'Ø£Ù‚Ø±Ø¨ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­'];
             roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
             
             if (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­') {
                 const maxIntDigits = MAX_TOTAL_DIGITS - 1; 
                 numberToRound = generateNumberForRounding(maxIntDigits, 1, 2); 
                 correctAnswerValue = Math.round(numberToRound);
             } else {
                 numberToRound = Math.floor(Math.random() * (99999 - 1000) + 1000); 
                 correctAnswerValue = Math.round(numberToRound / 1000) * 1000;
             }
        
        } else if (level === 3) {
             const options = ['Ø£Ù‚Ø±Ø¨ Ø¬Ø²Ø¡ Ù…Ù† Ø¹Ø´Ø±Ø©', 'Ø£Ù‚Ø±Ø¨ Ø¬Ø²Ø¡ Ù…Ù† Ù…Ø¦Ø©'];
             roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
             
             if (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ø¬Ø²Ø¡ Ù…Ù† Ø¹Ø´Ø±Ø©') {
                 const minDecimals = 2;
                 const maxIntDigits = MAX_TOTAL_DIGITS - minDecimals; 
                 numberToRound = generateNumberForRounding(maxIntDigits, minDecimals, 3);
                 correctAnswerValue = parseFloat(numberToRound.toFixed(1));
             } else { 
                 const minDecimals = 3;
                 const maxIntDigits = MAX_TOTAL_DIGITS - minDecimals; 
                 numberToRound = generateNumberForRounding(maxIntDigits, minDecimals, 4); 
                 correctAnswerValue = parseFloat(numberToRound.toFixed(2));
             }
        
        } else if (level === 4) {
            // âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4 Ù„Ù„ØªÙ‚Ø±ÙŠØ¨
            const options = ['Ø£Ù‚Ø±Ø¨ Ø¬Ø²Ø¡ Ù…Ù† Ø£Ù„Ù', 'Ø£Ù‚Ø±Ø¨ Ù…Ø¦Ø© Ø£Ù„Ù'];
            roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
            
            if (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ø¬Ø²Ø¡ Ù…Ù† Ø£Ù„Ù') {
                const minDecimals = 4;
                const maxIntDigits = MAX_TOTAL_DIGITS - minDecimals; 
                // ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¨Ø£Ø±Ø¨Ø¹ Ù…Ù†Ø§Ø²Ù„ Ø¹Ø´Ø±ÙŠØ© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ ÙˆÙ…Ù†Ø²Ù„ ØµØ­ÙŠØ­ ÙˆØ§Ø­Ø¯ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
                numberToRound = generateNumberForRounding(maxIntDigits, minDecimals, 5); 
                correctAnswerValue = parseFloat(numberToRound.toFixed(3)); // Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¥Ù„Ù‰ 3 Ù…Ù†Ø§Ø²Ù„
            } else { 
                // Ø£Ù‚Ø±Ø¨ Ù…Ø¦Ø© Ø£Ù„Ù
                numberToRound = getRandomInt(100000, 999999); // Ø±Ù‚Ù… Ø¨Ù€ 6 Ø®Ø§Ù†Ø§Øª
                correctAnswerValue = Math.round(numberToRound / 100000) * 100000;
            }
        
        } else if (level === 5) {
            // âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5 Ù„Ù„ØªÙ‚Ø±ÙŠØ¨ (Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¥Ù„Ù‰ Ø®Ø§Ù†Ø© Ø¹Ø´Ø±ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©)
            const options = ['Ø£Ù‚Ø±Ø¨ Ù…Ù„ÙŠÙˆÙ†', 'ØªÙ‚Ø±ÙŠØ¨ Ø¥Ù„Ù‰ Ù…Ù†Ø²Ù„Ø© Ø¹Ø´Ø±ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© (1-4)'];
            roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
            
            if (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ù…Ù„ÙŠÙˆÙ†') {
                numberToRound = getRandomInt(1000000, 9999999); // Ø±Ù‚Ù… Ø¨Ù€ 7 Ø®Ø§Ù†Ø§Øª
                correctAnswerValue = Math.round(numberToRound / 1000000) * 1000000;
            } else {
                const decimalPlaces = getRandomInt(1, 4); // Ù…Ù† 1 Ø¥Ù„Ù‰ 4 Ù…Ù†Ø§Ø²Ù„ Ø¹Ø´Ø±ÙŠØ©
                roundingPlaceKey = `Ø£Ù‚Ø±Ø¨ Ø¬Ø²Ø¡ Ù…Ù† ${Math.pow(10, decimalPlaces).toLocaleString(ARABIC_LOCALE)}`;
                
                const minDecimals = decimalPlaces + 1;
                const maxIntDigits = MAX_TOTAL_DIGITS - minDecimals; 
                // ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¨Ø®Ø§Ù†Ø§Øª Ø¹Ø´Ø±ÙŠØ© Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¥Ù„ÙŠÙ‡
                numberToRound = generateNumberForRounding(maxIntDigits, minDecimals, minDecimals + 1); 
                correctAnswerValue = parseFloat(numberToRound.toFixed(decimalPlaces)); 
            }
        }
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ø§ ØªÙØ¹Ø±Ø¶ Ø¨Ø´ÙƒÙ„ ÙƒØ³Ø±ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµÙØ± Ø£Ùˆ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­
        if (correctAnswerValue === 0 || Number.isInteger(correctAnswerValue)) {
            correctAnswerValue = Math.round(correctAnswerValue);
        }
        
        return { n1: numberToRound, n2: roundingPlaceKey, result: correctAnswerValue };
    }
    
    function generateQuestion() {
        if (!gameStarted || isProcessing) return;

        clearTimer();
        isProcessing = true;
        
        document.getElementById('feedback').innerHTML = '';
        disableChoices(false);
        
        let n1, n2, op;
        let questionData;
        const opType = document.getElementById('operation-select').value;
        
        if (opType === 'EVAL') {
             op = evaluationQuestionsQueue.shift();
             if (!op) { 
                processEvaluationEnd();
                return;
             }
        } else {
             op = opType;
        }

        const isTableQuestion = (op === '*' || op === '/') && currentLevel <= 3 && currentQuestionQueue.length > 0;
        
        if (op === 'R') {
            questionData = generateRoundingQuestion(currentLevel);
            n1 = questionData.n1;
            n2 = questionData.n2; 
        } else if (isTableQuestion) {
             const q = currentQuestionQueue.shift();
             questionData = generateOperationQuestionFromParams(q.n1, q.n2, op);
             n1 = q.n1; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
             n2 = q.n2;
        } else {
            questionData = generateOperationQuestion(currentLevel, op);
            n1 = questionData.n1;
            n2 = questionData.n2;
        }
        
        correctAnswer = questionData.result;
        
        // 1. Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø£ÙÙ‚ÙŠØ§Ù‹ Ø£Ùˆ Ø±Ø£Ø³ÙŠØ§Ù‹)
        const expressionDisplay = document.getElementById('expression-display');
        const qLine1 = document.getElementById('q-line-1');
        const qLine2 = document.getElementById('q-line-2');
        const qSeparator = document.getElementById('q-line-separator');
        const qNum1 = document.getElementById('q-num1');
        const qNum2 = document.getElementById('q-num2');
        const qOp = document.getElementById('q-op');
        const qOp2 = document.getElementById('q-op2');

        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø£Ø³ÙŠ Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
        qLine1.style.display = 'none';
        qLine2.style.display = 'none';
        qSeparator.style.display = 'none';
        qOp.style.display = 'none'; 
        qOp2.style.display = 'none'; 
        
        if (op === 'R') {
            expressionDisplay.innerHTML = `**Ù‚ÙØ±Ù‘ÙØ¨ Ø§Ù„Ø¹Ø¯Ø¯:** <span style="font-size: 1.5em; color: #dc3545;">${formatResult(n1, true)}</span> <br>Ø¥Ù„Ù‰: <span style="font-size: 1.2em; color: #007BFF;">${n2}</span>`;
            expressionDisplay.style.display = 'block';
        } else if (op === '+' || op === '-' || op === '*') {
            // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø£Ø³ÙŠ Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠØ©
            const alignedNumbers = alignVertical(n1, n2);
            qNum1.innerHTML = alignedNumbers.n1Display;
            qNum2.innerHTML = alignedNumbers.n2Display;
            qOp2.innerHTML = op;
            
            expressionDisplay.style.display = 'none';
            qLine1.style.display = 'flex';
            qLine2.style.display = 'flex';
            qSeparator.style.display = 'block';
            qOp2.style.display = 'block'; 
        } else {
            // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙÙ‚ÙŠ Ù„Ù„Ù‚Ø³Ù…Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªØ§Ø¬ Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ø¹Ù‚Ø¯Ø©
            expressionDisplay.innerHTML = `<span style="font-size: 1.5em; color: #dc3545;">${formatResult(n1)}</span> ${op} <span style="font-size: 1.5em; color: #007BFF;">${formatResult(n2)}</span> = ?`;
            expressionDisplay.style.display = 'block';
        }

        // 2. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
        generateChoices(correctAnswer);
        
        // 3. Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
        startTimer(TIME_LIMIT);

        isProcessing = false;
    }
    
    // ----------------------------------------------------
    // ğŸ’¥ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ø¶Ù…Ø§Ù† ØªÙˆÙ„ÙŠØ¯ 4 Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø®ØªÙ„ÙØ© Ø¯Ø§Ø¦Ù…Ù‹Ø§
    // ----------------------------------------------------
    function generateChoices(correctAnswer) {
        const opType = document.getElementById('operation-select').value;
        const choices = [correctAnswer];
        let attempts = 0;
        const maxAttempts = 100;

        // **âœ… 1. Ù…Ù†Ø·Ù‚ Ø®Ø§Øµ Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø©**
        if (opType === 'R') {
            const correctStr = correctAnswer.toString();
            let roundValue = 1; 
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¥Ù„ÙŠÙ‡Ø§ (Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­Ø©)
            if (Number.isInteger(correctAnswer) && correctAnswer !== 0) {
                 const zeros = correctStr.match(/0+$/) ? correctStr.match(/0+$/)[0].length : 0;
                 roundValue = Math.pow(10, zeros > 0 ? zeros : 1); // Ù†Ø¶Ù…Ù† 10 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªÙ†ØªØ§Ø¬ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ø¥Ù„ÙŠÙ‡Ø§ (Ù„Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø´Ø±ÙŠØ©)
            } else if (!Number.isInteger(correctAnswer)) {
                 const decimals = correctStr.split('.')[1] ? correctStr.split('.')[1].length : 0;
                 roundValue = Math.pow(10, -decimals); 
            }

            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø© Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© Ø§Ù„Ù…Ø¬Ø§ÙˆØ±Ø© ÙˆØ§Ù„Ø®Ø·Ø£ Ø§Ù„Ø¨Ø³ÙŠØ·)
            const nearFakes = [
                correctAnswer + roundValue,             // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙÙ‚Ø±Ø¨Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹ 22000)
                correctAnswer - roundValue,             // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙÙ‚Ø±Ø¨Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø«Ù„Ø§Ù‹ 20000)
                correctAnswer + roundValue * 0.1,       // Ø®Ø·Ø£ ØµØºÙŠØ± ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ (Ù…Ø«Ù„Ø§Ù‹ 21100)
                correctAnswer - roundValue * 0.1,       // Ø®Ø·Ø£ ØµØºÙŠØ± ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ (Ù…Ø«Ù„Ø§Ù‹ 20900)
                correctAnswer + roundValue * 0.5,       // Ø®Ø·Ø£ Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚ (Ù…Ø«Ù„Ø§Ù‹ 21500)
            ].filter(c => c !== correctAnswer);

            // Ø¥Ø¶Ø§ÙØ© 3 Ø®ÙŠØ§Ø±Ø§Øª Ø®Ø§Ø·Ø¦Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®ØµØµØ©
            while (choices.length < 4 && nearFakes.length > 0) {
                // Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†ÙˆØ¹
                const randomIndex = Math.floor(Math.random() * nearFakes.length);
                const fake = nearFakes.splice(randomIndex, 1)[0]; 
                
                if (fake !== correctAnswer && !choices.some(c => parseFloat(c.toFixed(4)) === parseFloat(fake.toFixed(4)))) {
                    choices.push(parseFloat(fake.toFixed(4)));
                }
            }
        }

        // **âœ… 2. Ù…Ù†Ø·Ù‚ Ø¹Ø§Ù… Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© (ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©)**
        while (choices.length < 4 && attempts < maxAttempts) {
            let fakeAnswer;
            
            // ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø£ Ø´Ø§Ø¦Ø¹/Ù‚Ø±ÙŠØ¨ (Ø®Ø·Ø£ ÙÙŠ Ù…Ù†Ø²Ù„Ø© Ù…Ø¹ÙŠÙ†Ø©)
            if (attempts < 60 && correctAnswer !== 0) { 
                let offset;
                
                if (Number.isInteger(correctAnswer) && Math.abs(correctAnswer) >= 10) {
                    // ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø£ ÙÙŠ Ù…Ù†Ø²Ù„Ø© Ù…Ø­Ø¯Ø¯Ø© (Ø¢Ø­Ø§Ø¯ØŒ Ø¹Ø´Ø±Ø§ØªØŒ Ù…Ø¦Ø§ØªØŒ Ø¥Ù„Ø®)
                    const correctLength = correctAnswer.toString().replace('-', '').length;
                    const minPower = (correctLength > 1) ? 0 : 0;
                    const maxPower = Math.min(correctLength - 1, 3); // Ø­ØªÙ‰ Ù…Ù†Ø²Ù„Ø© Ø§Ù„Ø¢Ù„Ø§Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø®Ø·Ø£ Ø§Ù„Ø´Ø§Ø¦Ø¹
                    
                    // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚ÙˆØ© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø§Ù„Ø®Ø·Ø£ ÙÙŠÙ‡Ø§ (10^0ØŒ 10^1ØŒ 10^2ØŒ Ø¥Ù„Ø®)
                    const power = Math.pow(10, getRandomInt(minPower, maxPower));
                    
                    // Ø§Ù„Ø¥Ø²Ø§Ø­Ø© Ù‡ÙŠ Ù…Ø¶Ø§Ø¹Ù Ù„Ù„Ù‚ÙˆØ©
                    offset = getRandomElement([-1, 1]) * power * getRandomElement([1, 2, 5]); 
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø§ØªØ¬ ØµØºÙŠØ±Ø§Ù‹ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¥Ø²Ø§Ø­Ø© ØµØºÙŠØ±Ø© (1-5)
                } else { 
                     offset = getRandomElement([-1, -2, 1, 2, -5, 5]); 
                }

                fakeAnswer = parseFloat((correctAnswer + offset).toFixed(4));
            
            // ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø£ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø£Ø¨Ø¹Ø¯ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚Ø±ÙŠØ¨
            } else {
                const range = Math.max(15, Math.abs(correctAnswer) * 0.75);
                const randomOffset = getRandomInt(-range, range);
                fakeAnswer = correctAnswer + randomOffset;
            }

            // Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ³Ø§ÙˆÙŠ ÙÙŠ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¯Ø¯
            fakeAnswer = parseFloat(fakeAnswer.toFixed(4));
            
            if (Number.isInteger(correctAnswer) || (opType === '+' || opType === '-')) {
                 fakeAnswer = Math.round(fakeAnswer);
            } 
            
            if (fakeAnswer !== correctAnswer && !choices.some(c => parseFloat(c.toFixed(4)) === parseFloat(fakeAnswer.toFixed(4)))) {
                choices.push(fakeAnswer);
            }
            attempts++;
        }
        
        // Ø®Ù„Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
        for (let i = choices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [choices[i], choices[j]] = [choices[j], choices[i]];
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
        const choicesDiv = document.getElementById('answer-choices');
        choicesDiv.innerHTML = choices.map(choice => 
            `<button class="choice-btn" onclick="checkAnswer(${choice})">${formatResult(choice)}</button>`
        ).join('');
    }
    // ----------------------------------------------------
    
    function formatResult(number, forceDecimal = false) {
         if (typeof number !== 'number') return number; // Ù„Ù„ØªÙ‚Ø±ÙŠØ¨ (n2)
         
         if (!forceDecimal && (number === 0 || Number.isInteger(number))) {
             return Math.round(number).toLocaleString(ARABIC_LOCALE);
         }
         
         const formatted = number.toLocaleString(ARABIC_LOCALE, {
             maximumFractionDigits: 4,
             useGrouping: true 
         });
         
         return formatted.replace(/\s/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³Ø§ÙØ§Øª Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
    }

    function checkAnswer(selectedAnswer) {
        if (isProcessing) return;
        isProcessing = true;
        clearTimer();
        
        disableChoices(true);
        
        const feedbackDiv = document.getElementById('feedback');
        
        // Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø¨Ø¶Ø¨Ø· Ø§Ù„Ø¯Ù‚Ø© Ø¥Ù„Ù‰ 4 Ù…Ù†Ø§Ø²Ù„ Ø¹Ø´Ø±ÙŠØ©)
        const roundedCorrect = parseFloat(correctAnswer.toFixed(4));
        const roundedSelected = parseFloat(selectedAnswer.toFixed(4));

        if (roundedSelected === roundedCorrect) {
            feedbackDiv.innerHTML = `<span class="correct">${getRandomEncouragingPhrase()}</span>`;
            handleTrainingAnswer(true);
        } else {
            feedbackDiv.innerHTML = `<span class="wrong">Ø®Ø·Ø£! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: **${formatResult(roundedCorrect)}**</span>`;
            handleTrainingAnswer(false);
        }

        isProcessing = false;
    }

    function disableChoices(disabled) {
        document.querySelectorAll('.choice-btn').forEach(button => {
            button.disabled = disabled;
        });
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = () => {
        loadGlobalScores();
        resetGameDisplay();
    };

</script>
</body>
</html>
