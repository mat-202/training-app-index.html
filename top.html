<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© (ØªØ®ØµÙŠØµ Ø¶Ø±Ø¨/Ù‚Ø³Ù…Ø©/ØªÙ‚Ø±ÙŠØ¨) Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</title>
    <style>
        body { font-family: 'Arial', sans-serif; text-align: center; margin-top: 30px; background-color: #f4f4f9; }
        
        .main-content { 
            display: flex; 
            justify-content: center;
            max-width: 1000px;
            margin: auto; 
        }
        .container { 
            width: 100%;
            padding: 20px; 
            border: 5px solid #007BFF;
            border-radius: 15px; 
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        h1 { color: #007BFF; margin-bottom: 20px; }
        
        /* Ù‚Ø³Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª */
        .names-input-section { margin-bottom: 20px; padding: 15px; border: 1px dashed #ccc; border-radius: 8px; display: flex; justify-content: space-between; gap: 10px; }
        .folder { width: 33%; text-align: right; }
        .folder-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .folder label { font-weight: bold; color: #dc3545; display: inline-block; }
        .folder input[type="text"] { width: 60%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 0.9em; }
        .folder textarea { 
            width: 98%; height: 120px; padding: 10px; font-size: 1em; border: 1px solid #007BFF; border-radius: 4px; resize: vertical; box-sizing: border-box; 
        }

        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø© */
        .round-setup { margin-bottom: 20px; padding: 15px; background-color: #e9ecef; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; }
        .round-setup label { font-weight: bold; }
        .round-setup select { padding: 8px; font-size: 1em; border-radius: 5px; border: 1px solid #FFC107; }
        
        /* Ø¥Ø®ÙØ§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ */
        .op-level-control { 
            transition: opacity 0.5s; 
        }
        .hide-op-level .op-level-control {
            opacity: 0.2;
            pointer-events: none;
        }

        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #turn-indicator { font-size: 1.5em; }
        #timer-display { font-size: 2em; font-weight: bold; color: #333; padding: 5px 15px; border: 3px dashed #FFC107; border-radius: 8px; min-width: 120px; }

        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„ÙŠØµØ¨Ø­ Ø¹Ù…ÙˆØ¯ÙŠÙ‹Ø§ */
        #question { 
            font-size: 3em; 
            margin: 30px auto; 
            color: #333; 
            min-height: 150px; 
            width: 350px; 
            text-align: right; 
        }
        .q-line {
            display: flex;
            justify-content: flex-end; 
            font-size: 1em;
            height: 1.2em;
            line-height: 1.2em;
            flex-wrap: wrap;
        }
        #q-num1, #q-num2 {
            min-width: 150px; 
            text-align: right;
            padding-right: 5px;
            white-space: nowrap; 
        }
        #q-op2 {
             min-width: 120px; 
             text-align: center;
             font-size: 0.8em; 
             font-weight: bold;
             padding-right: 5px;
        }
        #q-line-separator {
            border-bottom: 5px solid #000;
            margin: 5px 0 10px 0;
            width: 100%;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© */
        #answer-options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px auto;
            max-width: 600px;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .answer-btn { 
            background-color: #007BFF; 
            color: white; 
            padding: 15px 10px; 
            font-size: 1.5em; 
            border: none; 
            cursor: pointer; 
            border-radius: 8px; 
            transition: background-color 0.3s, transform 0.1s; 
            box-shadow: 0 4px #0056b3; 
            min-height: 60px;
        }
        .answer-btn:hover:not(:disabled) { 
            background-color: #0056b3; 
            transform: translateY(2px);
            box-shadow: 0 2px #004085;
        }
        .answer-btn:disabled { 
            cursor: not-allowed; 
            opacity: 0.6;
            box-shadow: none;
        }
        .correct-answer { background-color: #28a745 !important; box-shadow: 0 4px #1e7e34 !important; }
        .wrong-answer { background-color: #dc3545 !important; box-shadow: 0 4px #a71d2a !important; }

        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø®Ø±Ù‰ */
        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        #start-btn, #next-round-btn { padding: 12px 25px; font-size: 1.4em; color: white; border: none; cursor: pointer; border-radius: 8px; transition: background-color 0.3s; }
        #start-btn { background-color: #28a745; }
        #next-round-btn { background-color: #007BFF; display: none; } 

        /* Ù†Ù…Ø· Ù„Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© */
        .correct { color: #28a745; font-weight: bold; }
        .wrong { color: #dc3545; font-weight: bold; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .footer-text {
            margin-top: 40px;
            padding: 10px 0;
            font-size: 1.1em;
            color: #555;
            text-align: center;
            border-top: 1px solid #ccc;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>

<div class="main-content">
    <div class="container">
        <h1>Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©</h1>
        
        <div class="names-input-section" id="names-section">
            <div class="folder">
                <div class="folder-header">
                    <label for="folder-a-name-input">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯:</label>
                    <input type="text" id="folder-a-name-input" value="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£">
                </div>
                <textarea id="folder-a-names" placeholder="Ø§Ø³Ù…1&#10;Ø§Ø³Ù…2&#10;Ø§Ø³Ù…3&#10;..."></textarea>
            </div>
            <div class="folder">
                <div class="folder-header">
                    <label for="folder-b-name-input">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯:</label>
                    <input type="text" id="folder-b-name-input" value="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨">
                </div>
                <textarea id="folder-b-names" placeholder="Ø§Ø³Ù…4&#10;Ø§Ø³Ù…5&#10;Ø§Ø³Ù…6&#10;..."></textarea>
            </div>
            <div class="folder">
                <div class="folder-header">
                    <label for="folder-c-name-input">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯:</label>
                    <input type="text" id="folder-c-name-input" value="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬">
                </div>
                <textarea id="folder-c-names" placeholder="Ø§Ø³Ù…7&#10;Ø§Ø³Ù…8&#10;Ø§Ø³Ù…9&#10;..."></textarea>
            </div>
        </div>

        <div class="round-setup" id="round-setup">
            <label for="folder-select">Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©:</label>
            <select id="folder-select">
                <option value="A">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£</option>
                <option value="B">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨</option>
                <option value="C">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬</option>
            </select>
            
            <div class="op-level-control">
                <label for="operation-select">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
                <select id="operation-select">
                    <option value="+">Ø¬Ù…Ø¹</option>
                    <option value="-">Ø·Ø±Ø­</option>
                    <option value="*">Ø¶Ø±Ø¨</option>
                    <option value="/">Ù‚Ø³Ù…Ø©</option>
                    <option value="R">ØªÙ‚Ø±ÙŠØ¨</option> 
                </select>
            </div>
            
            <div class="op-level-control">
                <label for="level-select">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</label>
                <select id="level-select">
                    <option value="1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</option>
                    <option value="2">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2</option>
                    <option value="3">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3</option>
                    <option value="4">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4</option>
                    <option value="5">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5</option>
                </select>
            </div>
            
            <label for="mode-select">Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©:</label>
            <select id="mode-select" onchange="toggleOpLevelControls()">
                <option value="elimination4">Ù…Ø³Ø§Ø¨Ù‚Ø© ØµÙ Ø«Ø§Ù„Ø« (ØªØµØ§Ø¹Ø¯ÙŠ Ø´Ø§Ù…Ù„ - Ø­Ø¯ Ø£Ù‚ØµÙ‰ 3)</option>
                <option value="elimination5">Ù…Ø³Ø§Ø¨Ù‚Ø© ØµÙ Ø±Ø§Ø¨Ø¹ (ØªØµØ§Ø¹Ø¯ÙŠ Ø´Ø§Ù…Ù„ - Ø­Ø¯ Ø£Ù‚ØµÙ‰ 4)</option>
                <option value="elimination3">Ù…Ø³Ø§Ø¨Ù‚Ø© ØµÙ Ø®Ø§Ù…Ø³ ÙØ£Ø¹Ù„Ù‰ (ØªØµØ§Ø¹Ø¯ÙŠ Ø´Ø§Ù…Ù„ - Ø­Ø¯ Ø£Ù‚ØµÙ‰ 5)</option>
                <option value="elimination1">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¹Ø§Ù…Ø© (Ù‚Ø³Ù… ÙˆÙ…Ø³ØªÙˆÙ‰ Ø«Ø§Ø¨Øª)</option>
                <option value="elimination2">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¹Ø§Ù…Ø© (Ù‚Ø³Ù… Ø«Ø§Ø¨Øª ÙˆÙ…Ø³ØªÙˆÙ‰ ØªØµØ§Ø¹Ø¯ÙŠ)</option>
            </select>
            
            <button id="start-btn" onclick="startGame()">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button> 
            <button id="next-round-btn" onclick="startNewRound()" style="display: none;">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>

        <div class="header-section">
            <div id="turn-indicator">
                Ø§Ù„Ø¯ÙˆØ±: <span id="current-player" class="player-turn">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</span>
            </div>
            <div id="timer-display">30 Ø«ÙˆØ§Ù†Ù</div> 
        </div>

        <div id="question">
             <div class="q-line" id="q-line-1">
                 <span id="q-op"></span>
                 <span id="q-num1">Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</span>
             </div>
             <div class="q-line" id="q-line-2">
                 <span id="q-op2"></span>
                 <span id="q-num2"></span>
             </div>
             <div id="q-line-separator"></div>
        </div> 
        
        <div id="answer-options-container">
            </div>

        <div id="feedback"></div>

        <div class="score-boards">
            <div id="score1-display" class="score">Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ 1: 0</div>
            <div id="score2-display" class="score">Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ 2: 0</div>
        </div>
    </div>
    
    </div>

<p class="footer-text" dir="rtl">Ø¥Ø¹Ø¯Ø§Ø¯: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø­Ø¬ÙŠÙ„ÙŠ</p>

<script>
    let num1, num2, correctAnswerValue; 
    let correctAnswerDisplay; 
    let score1 = 0; 
    let score2 = 0; 
    let currentPlayer = 1; 
    let isProcessing = false;
    let gameStarted = false; 

    let playerName1 = "Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ 1";
    let playerName2 = "Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ 2";
    let currentFolderKey = ''; 
    
    let allStudentsByFolder = { A: [], B: [], C: [] }; 
    let folderNames = { A: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£", B: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨", C: "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬" }; 
    let globalScores = {}; 
    let currentRoundingDecimals = 0; 

    const TIME_LIMIT = 30; // ğŸŒŸ ØªÙ… ØªÙˆØ­ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª Ù„Ù€ 30 Ø«Ø§Ù†ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
    let timeRemaining = TIME_LIMIT;
    let timerInterval;

    const ARABIC_LOCALE = 'ar-SA'; 
    
    // --- Ù…ØªØºÙŠØ±Ø§Øª Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…ØºÙ„ÙˆØ¨ ---
    let currentMode = 'elimination1';
    let eliminationQuestionsCount = 0; 
    const MAX_ELIMINATION_QUESTIONS = 2; // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¬ÙŠØ¨ Ø¹Ù†Ù‡Ø§ ÙƒÙ„ Ù…ØªØ³Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ÙØ§ØµÙ„Ø©
    let player1Wins = 0;
    let player2Wins = 0;
    let folderStudentsInPlay = []; 
    let isTieBreaker = false; 
    
    // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØµØ§Ø¹Ø¯ (Elimination 2 & 3 & 4 & 5) ---
    let currentTournamentRound = 0; 
    let tournamentSchedule = []; 
    let fixedOperation = ''; 
    const ALL_OPERATIONS = ['+', '-', '*', '/', 'R']; 
    const MAX_LEVEL = 5; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
    
    // ----------------------------------------------------------------
    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    // ----------------------------------------------------------------
    function toggleOpLevelControls() {
        const mode = document.getElementById('mode-select').value;
        const roundSetup = document.getElementById('round-setup');
        
        // E1 Ùˆ E2: Ø«Ø§Ø¨Øª
        if (mode === 'elimination1' || mode === 'elimination2') {
            roundSetup.classList.remove('hide-op-level');
        } 
        // E3, E4, E5: Ø¹Ø´ÙˆØ§Ø¦ÙŠ/ØªØµØ§Ø¹Ø¯ÙŠ Ø´Ø§Ù…Ù„ (ÙŠØ®ÙÙŠ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ…)
        else if (mode === 'elimination3' || mode === 'elimination4' || mode === 'elimination5') {
            roundSetup.classList.add('hide-op-level');
        }
    }
    document.addEventListener('DOMContentLoaded', toggleOpLevelControls);

    // ----------------------------------------------------------------
    // --- Ø¯ÙˆØ§Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© ---
    // ----------------------------------------------------------------

    function generateNumberWithRange(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateNumberWithDigits(digits, allowDecimals = 0) {
        let number;
        if (digits === 1) { 
             number = Math.floor(Math.random() * 9) + 1;
        } else {
             const min = Math.pow(10, digits - 1);
             const max = Math.pow(10, digits) - 1;
             number = Math.floor(Math.random() * (max - min + 1)) + min;
        }
        if (allowDecimals > 0) {
            const decimalPart = Math.random();
            number = number + decimalPart;
            // Ù†Ø­Ø¯Ø¯ Ø¹Ø¯Ø¯ ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ù†Ø§Ø²Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø© ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            number = parseFloat(number.toFixed(Math.max(allowDecimals + 4, 10))); 
        }
        return number;
    }

    function getNumberBounds(level, op) {
        level = parseInt(level);
        const d = (digits, decimals = 0) => ({ d: digits, dec: decimals });
        const dec = level >= 5 ? 3 : 0; 

        if (op === '+' || op === '-') {
            if (level === 1) return { n1: d(1), n2: d(1) };
            if (level === 2) return { n1: d(2), n2: d(2) };
            if (level === 3) return { n1: d(3), n2: d(3) };
            if (level === 4) return { n1: d(4), n2: d(4) };
            if (level === 5) return { n1: d(5, dec), n2: d(5, dec) };
            return { n1: d(1), n2: d(1) }; 
        } 
        
        if (op === '*' || op === '/') {
             if (level === 1) return { n1: { min: 1, max: 10 }, n2: { min: 1, max: 3 } }; 
             if (level === 2) return { n1: { min: 1, max: 10 }, n2: { min: 4, max: 6 } }; 
             if (level === 3) return { n1: { min: 1, max: 10 }, n2: { min: 7, max: 10 } }; 
             
             if (level === 4) return { 
                 n1: { min: 10, max: 9999 }, 
                 n2: { min: 2, max: 9 } 
             }; 
             
             if (level === 5) return { 
                 n1: { min: 10, max: 9999 }, 
                 n2: { min: 10, max: 99 }
             };
        }
        
        return { n1: d(1), n2: d(1) }; 
    }

    function generateOperationQuestion(level, op) {
        const bounds = getNumberBounds(level, op);
        let n1, n2, result;
        level = parseInt(level);
        let maxDecimals = 0;

        if (op === '+' || op === '-') {
             const dec1 = bounds.n1.dec;
             const dec2 = bounds.n2.dec;
             maxDecimals = Math.max(dec1, dec2);
             
             n1 = generateNumberWithDigits(bounds.n1.d, dec1);
             n2 = generateNumberWithDigits(bounds.n2.d, dec2);

             if (op === '+') {
                result = n1 + n2;
             } else if (op === '-') {
                if (n1 < n2) [n1, n2] = [n2, n1];
                result = n1 - n2;
             }
             
             // Ù…Ù‡Ù…: Ù†Ø³ØªØ®Ø¯Ù… toFixed Ù‡Ù†Ø§ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
             result = parseFloat(result.toFixed(maxDecimals)); 
             return { n1, n2, result, requiredDecimals: maxDecimals };
        }
        
        if (op === '*' || op === '/') {
             let factor1, factor2, product;

             factor1 = generateNumberWithRange(bounds.n1.min, bounds.n1.max);
             factor2 = generateNumberWithRange(bounds.n2.min, bounds.n2.max);
             product = factor1 * factor2;
             
             if (level >= 1 && level <= 3) {
                 if (factor1 < factor2) [factor1, factor2] = [factor2, factor1];
             }
             
             if (op === '*') {
                 n1 = factor1;
                 n2 = factor2;
                 result = product;
             } else if (op === '/') {
                 n1 = product; 
                 n2 = factor2; 
                 result = factor1; 
             }
             
             return { n1, n2, result, requiredDecimals: 0 };
        }
        
        return { n1: 1, n2: 1, result: 2, requiredDecimals: 0 };
    }

    function generateRoundingQuestion(level) {
        let numberToRound;
        let roundingPlaceKey;
        let finalDecimalPlaces = 0;
        let correctAnswerValue;
        level = parseInt(level);

        if (level === 1) {
            roundingPlaceKey = 'Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©';
            numberToRound = Math.floor(Math.random() * (999 - 10) + 10); 
            const roundingValue = 10;
            correctAnswerValue = Math.round(numberToRound / roundingValue) * roundingValue;
        } else if (level === 2) {
            const options = ['Ø£Ù‚Ø±Ø¨ Ù…Ø¦Ø©', 'Ø£Ù‚Ø±Ø¨ Ø£Ù„Ù'];
            roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
            const roundingValue = roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ù…Ø¦Ø©' ? 100 : 1000;
            numberToRound = Math.floor(Math.random() * (99999 - 100) + 100);
            correctAnswerValue = Math.round(numberToRound / roundingValue) * roundingValue;
        } else if (level === 3) {
            const options = { 'Ø¬Ø²Ø¡ Ù…Ù† Ø¹Ø´Ø±Ø©': 1, 'Ø¬Ø²Ø¡ Ù…Ù† Ù…Ø¦Ø©': 2 };
            const keys = Object.keys(options);
            roundingPlaceKey = keys[Math.floor(Math.random() * keys.length)];
            finalDecimalPlaces = options[roundingPlaceKey];
            const decimalPlacesToGenerate = finalDecimalPlaces + 2;
            numberToRound = generateNumberWithDigits(2, decimalPlacesToGenerate); 
            
            const powerOfTen = Math.pow(10, finalDecimalPlaces);
            correctAnswerValue = Math.round(numberToRound * powerOfTen) / powerOfTen;
        } else { // level 4 & 5
            roundingPlaceKey = 'Ø¬Ø²Ø¡ Ù…Ù† Ø£Ù„Ù';
            finalDecimalPlaces = 3; 
            const decimalPlacesToGenerate = 5; 
            numberToRound = generateNumberWithDigits(4, decimalPlacesToGenerate); 
            
            const powerOfTen = Math.pow(10, finalDecimalPlaces);
            correctAnswerValue = Math.round(numberToRound * powerOfTen) / powerOfTen;
        }
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø´ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨
        correctAnswerValue = parseFloat(correctAnswerValue.toFixed(finalDecimalPlaces));

        return {
            n1: numberToRound,
            n2: roundingPlaceKey,
            result: correctAnswerValue,
            roundingDisplayDecimals: finalDecimalPlaces
        };
    }
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© (Ø­Ø°Ù ÙØ§ØµÙ„Ø© Ø§Ù„Ø£Ù„ÙˆÙ)
    function formatNumberDisplay(value, maxDecimals = 0, isRounding = false) {
        if (typeof value === 'string') return value; 
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªÙ‚Ø±ÙŠØ¨ Ø¥Ù„Ù‰ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ (level 1 & 2)
        if (isRounding && maxDecimals === 0) {
            return Math.round(value).toLocaleString(ARABIC_LOCALE, { useGrouping: false, maximumFractionDigits: 0 });
        }
        
        // Ù†Ø³ØªØ®Ø¯Ù… ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¨ÙŠ Ø¨Ø¯ÙˆÙ† ÙØ§ØµÙ„Ø© Ø¢Ù„Ø§Ù (useGrouping: false)
        return value.toLocaleString(ARABIC_LOCALE, {
             useGrouping: false,
             minimumFractionDigits: maxDecimals,
             maximumFractionDigits: maxDecimals 
        });
    }

    
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    
    function generateDistractors(correctAnswer, decimalPlaces) {
        let distractors = new Set();
        // Ù†Ø³ØªØ®Ø¯Ù… toFixed Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
        let correct = parseFloat(correctAnswer.toFixed(decimalPlaces)); 
        let attempts = 0;

        const addDistractor = (val) => {
            val = parseFloat(val.toFixed(decimalPlaces));
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ÙØ±Ù‚ Ø£ÙƒØ¨Ø± Ù…Ù† Ù‚ÙŠÙ…Ø© ØµØºÙŠØ±Ø© Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø©
            if (Math.abs(val - correct) > Math.pow(10, -(decimalPlaces + 1)) && distractors.size < 3) {
                distractors.add(val);
                return true;
            }
            return false;
        };

        let smallOffset = decimalPlaces === 0 ? 1 : Math.pow(10, -decimalPlaces);
        
        // Ø§Ù„ØªØ´ØªÙŠØª Ø¨Ù…Ù‚Ø¯Ø§Ø± Ø¨Ø³ÙŠØ· (Ø£Ø¹Ù„Ù‰ ÙˆØ£Ø¯Ù†Ù‰ Ø±Ù‚Ù… ØµØ­ÙŠØ­/Ø¹Ø´Ø±ÙŠ)
        if (addDistractor(correct + smallOffset)) {}
        if (addDistractor(correct - smallOffset)) {}
        
        // ØªÙˆÙ„ÙŠØ¯ ØªØ´ØªÙŠØª Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        while (distractors.size < 3 && attempts < 20) {
            let deviation = Math.random() * (Math.max(correct / 10, 10)) + smallOffset; 
            let sign = Math.random() < 0.5 ? 1 : -1;
            
            let potentialAnswer = correct + (sign * deviation);
            
            if (potentialAnswer < 0 && correct >= 0) {
                potentialAnswer = Math.abs(potentialAnswer);
            }
            
            if (addDistractor(potentialAnswer)) {}
            attempts++;
        }
        
        // Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§Øº Ø¨Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¹ÙŠØ¯Ø© Ø¥Ù† Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        while (distractors.size < 3) {
             let farNumber = generateNumberWithDigits(5, decimalPlaces);
             addDistractor(farNumber);
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶ (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„ØªØ´ØªÙŠØª)
        return Array.from(distractors).slice(0, 3).map(d => formatNumberDisplay(d, decimalPlaces));
    }


    // ----------------------------------------------------------------
    // --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„Ø© ---
    // ----------------------------------------------------------------

    function saveGlobalScores() {
        try {
            localStorage.setItem('mathHeroesGlobalScores', JSON.stringify(globalScores));
            localStorage.setItem('mathHeroesFolderNames', JSON.stringify(folderNames));
        } catch (e) {
            console.error("Could not save scores to localStorage", e);
        }
    }

    function loadGlobalScores() {
        try {
            const savedScores = localStorage.getItem('mathHeroesGlobalScores');
            const savedFolderNames = localStorage.getItem('mathHeroesFolderNames');
            
            if (savedScores) {
                globalScores = JSON.parse(savedScores);
            } else {
                globalScores = {};
            }

            if (savedFolderNames) {
                const loadedNames = JSON.parse(savedFolderNames);
                folderNames = loadedNames;
                document.getElementById('folder-a-name-input').value = folderNames.A;
                document.getElementById('folder-b-name-input').value = folderNames.B;
                document.getElementById('folder-c-name-input').value = folderNames.C;
            }
            
            const savedNamesA = localStorage.getItem('mathHeroesNamesA');
            const savedNamesB = localStorage.getItem('mathHeroesNamesB');
            const savedNamesC = localStorage.getItem('mathHeroesNamesC');
            
            if (savedNamesA) document.getElementById('folder-a-names').value = savedNamesA;
            if (savedNamesB) document.getElementById('folder-b-names').value = savedNamesB;
            if (savedNamesC) document.getElementById('folder-c-names').value = savedNamesC;
            
        } catch (e) {
            console.error("Could not load scores from localStorage", e);
            globalScores = {}; 
        }
    }

    function clearTimer() {
        clearInterval(timerInterval);
        document.getElementById('timer-display').style.color = '#333';
    }

    function handleTimeUp() {
        clearTimer();
        isProcessing = true; 
        
        document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
        
        const feedbackElement = document.getElementById('feedback');
        feedbackElement.innerHTML = `<span class="wrong">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! (ØµÙØ± ÙÙˆØ² Ù„Ù€ ${currentPlayer === 1 ? playerName1 : playerName2}). Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: ${correctAnswerDisplay}</span>`;
        
        // ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£ÙˆØ¶Ø§Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…ØºÙ„ÙˆØ¨ (1, 2, 3, 4, 5) Ù†Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚
        eliminationQuestionsCount += 1; 
        
        // Ù†Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ø¯ÙˆØ± Ø¨ØºØ¶ Ø§Ù„Ù†Ø¸Ø± Ø¹Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø© 
        currentPlayer = (currentPlayer === 1) ? 2 : 1; 
        
        document.getElementById('score1-display').innerHTML = `${playerName1} (ÙÙˆØ²): ${player1Wins.toLocaleString(ARABIC_LOCALE)}`;
        document.getElementById('score2-display').innerHTML = `${playerName2} (ÙÙˆØ²): ${player2Wins.toLocaleString(ARABIC_LOCALE)}`;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø© Ø£Ùˆ Ø§Ù„ØªØ¹Ø§Ø¯Ù„
        if (isTieBreaker && eliminationQuestionsCount >= 2) {
           processEliminationRoundEnd();
           return;
        }
        if (!isTieBreaker && eliminationQuestionsCount >= MAX_ELIMINATION_QUESTIONS) {
           processEliminationRoundEnd();
           return;
        }

        setTimeout(generateQuestion, 2500); 
    }

    function startTimer(duration) {
        clearTimer(); 
        timeRemaining = duration;
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.innerHTML = `${timeRemaining.toLocaleString(ARABIC_LOCALE)} Ø«ÙˆØ§Ù†Ù`;

        timerInterval = setInterval(() => {
            timeRemaining -= 1;
            timerDisplay.innerHTML = `${timeRemaining.toLocaleString(ARABIC_LOCALE)} Ø«ÙˆØ§Ù†Ù`;

            if (timeRemaining <= 5) { 
                timerDisplay.style.color = 'red';
            } else {
                timerDisplay.style.color = '#333';
            }

            if (timeRemaining <= 0) {
                handleTimeUp();
            }
        }, 1000); 
    }
    
    function selectRandomPlayers(folderKey) {
        let students;
        
        // Ù…Ù†Ø·Ù‚ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…ØºÙ„ÙˆØ¨: Ù†Ø®ØªØ§Ø± ÙÙ‚Ø· Ù…Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù…Ø§ Ø²Ø§Ù„ÙˆØ§ ÙÙŠ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©
        if (folderStudentsInPlay.length <= 1) { 
             folderStudentsInPlay = [...allStudentsByFolder[folderKey]];
        }
        students = folderStudentsInPlay;

        if (students.length < 2) return null;

        const availableStudents = [...students];
         
        const index1 = Math.floor(Math.random() * availableStudents.length);
        const player1 = availableStudents[index1];
         
        availableStudents.splice(index1, 1);
         
        const index2 = Math.floor(Math.random() * availableStudents.length);
        const player2 = availableStudents[index2];
         
        return [player1, player2];
    }
    
    function finishEliminationRound(winnerName, loserName) {
        document.getElementById('feedback').innerHTML = `<span class="correct">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©: ${winnerName} ÙŠÙÙˆØ²!</span> - <span class="wrong">${loserName} ÙŠØ®Ø±Ø¬ Ù…Ù† Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©.</span>`;
        
        folderStudentsInPlay = folderStudentsInPlay.filter(name => name !== loserName);
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø©
        eliminationQuestionsCount = 0;
        player1Wins = 0;
        player2Wins = 0;
        isTieBreaker = false;
        fixedOperation = ''; 
        tournamentSchedule = []; 
        currentTournamentRound = 0;
        
        if (folderStudentsInPlay.length === 1) {
             const champion = folderStudentsInPlay[0];
             document.getElementById('feedback').innerHTML = `<h1>ğŸ† Ø§Ù„Ø¨Ø·Ù„ Ù‡Ùˆ: ${champion}! ğŸ†</h1>`;
             globalScores[champion] = (globalScores[champion] || 0) + 1; 
             saveGlobalScores();
             document.getElementById('next-round-btn').textContent = 'Ø¨Ø¯Ø¡ Ø¨Ø·ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
             document.getElementById('next-round-btn').style.display = 'block';
             document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
        } else {
             document.getElementById('next-round-btn').style.display = 'block';
             document.getElementById('next-round-btn').textContent = 'Ø¬ÙˆÙ„Ø© Ø¥Ù‚ØµØ§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©';
        }
    }
    
    // Ù„ØªÙ‡ÙŠØ¦Ø© ÙˆØ¶Ø¹ Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…ØºÙ„ÙˆØ¨ 3, 4, 5 (ØªØµØ§Ø¹Ø¯ÙŠ Ø´Ø§Ù…Ù„)
    function setupTournamentSchedule() {
        tournamentSchedule = [];
        let availableOps = shuffleArray([...ALL_OPERATIONS]);

        // ğŸŒŸ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        let modeMaxLevel = MAX_LEVEL; 
        const mode = document.getElementById('mode-select').value;
        
        if (mode === 'elimination4') { // Ù…Ø³Ø§Ø¨Ù‚Ø© ØµÙ Ø«Ø§Ù„Ø«
             modeMaxLevel = 3;
        } else if (mode === 'elimination5') { // Ù…Ø³Ø§Ø¨Ù‚Ø© ØµÙ Ø±Ø§Ø¨Ø¹
             modeMaxLevel = 4;
        } // ÙˆØ¥Ù„Ø§ ÙØ¥Ù†Ù‡ ÙŠØ³ØªØ®Ø¯Ù… MAX_LEVEL = 5 Ù„Ù€ elimination3 (ØµÙ Ø®Ø§Ù…Ø³ ÙØ£Ø¹Ù„Ù‰)
        
        // Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„: ØªØµØ§Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø­ØªÙ‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ modeMaxLevel
        for (let i = 1; i <= modeMaxLevel; i++) {
            const op = availableOps.pop() || shuffleArray([...ALL_OPERATIONS]).pop(); 
            tournamentSchedule.push({ level: i, operation: op });
        }

        // Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„ÙŠØ§Øª Ù…ØªØ¨Ù‚ÙŠØ©ØŒ Ù†Ø¶Ø¹Ù‡Ø§ Ø¹Ù„Ù‰ modeMaxLevel
        const remainingOps = availableOps; 
        remainingOps.forEach(op => {
             tournamentSchedule.push({ level: modeMaxLevel, operation: op });
        });
        
        // Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø¯ÙˆÙ„ ÙƒØ§ÙÙ (Ù†ÙƒØ±Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ù†Ø¯ modeMaxLevel)
        let cycleOps = shuffleArray([...ALL_OPERATIONS]);
        while (tournamentSchedule.length < 10) { 
            const op = cycleOps.pop();
            tournamentSchedule.push({ level: modeMaxLevel, operation: op });
            if (cycleOps.length === 0) {
                 cycleOps = shuffleArray([...ALL_OPERATIONS]); 
            }
        }
        
        currentTournamentRound = 0; 
    }
    
    function processEliminationRoundEnd() {
        
        if (player1Wins === player2Wins) {
            
            // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµØ§Ø¹Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø§Ø¯Ù„ (Ù„Ø¬Ù…ÙŠØ¹ Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„ØªØµØ§Ø¹Ø¯)
            if (currentMode === 'elimination2' || currentMode === 'elimination3' || currentMode === 'elimination4' || currentMode === 'elimination5') {
                 currentTournamentRound += 1;
                 
                 let newLevel, opName;
                 
                 if (currentMode === 'elimination2') {
                     newLevel = Math.min(currentTournamentRound + 1, MAX_LEVEL);
                     opName = fixedOperation === 'R' ? 'ØªÙ‚Ø±ÙŠØ¨' : fixedOperation;
                 } else { // E3, E4, E5
                      const nextRound = tournamentSchedule[Math.min(currentTournamentRound, tournamentSchedule.length - 1)];
                      newLevel = nextRound.level;
                      opName = nextRound.operation === 'R' ? 'ØªÙ‚Ø±ÙŠØ¨' : nextRound.operation;
                 }
                 
                 const statusMsg = `<span class="wrong">ØªØ¹Ø§Ø¯Ù„! ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${newLevel.toLocaleString(ARABIC_LOCALE)} ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ©: ${opName}</span>`;
                 document.getElementById('feedback').innerHTML = statusMsg;
            } else { // E1
                document.getElementById('feedback').innerHTML = `<span class="wrong">ØªØ¹Ø§Ø¯Ù„! Ø³Ø¤Ø§Ù„ ÙØ§ØµÙ„ Ø¥Ø¶Ø§ÙÙŠ (Ù„ÙƒÙ„ Ù…ØªØ³Ø§Ø¨Ù‚)...</span>`;
            }
            
            isTieBreaker = true; 
            
            eliminationQuestionsCount = 0; 
            currentPlayer = 1; 
            
            setTimeout(generateQuestion, 2500);
            return; 
        }
        
        if (player1Wins !== player2Wins) {
            const winner = player1Wins > player2Wins ? playerName1 : playerName2;
            const loser = player1Wins > player2Wins ? playerName2 : playerName1;
            finishEliminationRound(winner, loser);
            return;
        }
    }


    function startNewRound() {
        if (!gameStarted) {
             alert('ÙŠØ±Ø¬Ù‰ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡.');
             return;
        }
        
        currentFolderKey = document.getElementById('folder-select').value;
        currentMode = document.getElementById('mode-select').value;
        const selectedFolderName = folderNames[currentFolderKey];
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ ØºÙŠØ± ÙƒØ§ÙÙØŒ Ù†Ø¹ÙŠØ¯ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        if (folderStudentsInPlay.length <= 1) { 
             folderStudentsInPlay = [...allStudentsByFolder[currentFolderKey]];
             if (folderStudentsInPlay.length < 2) {
                 alert(`ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ù…ØªØ³Ø§Ø¨Ù‚Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ ${selectedFolderName} Ù„Ø¨Ø¯Ø¡ Ø¨Ø·ÙˆÙ„Ø© Ø§Ù„Ø¥Ù‚ØµØ§Ø¡.`);
                 document.getElementById('next-round-btn').textContent = 'Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
                 document.getElementById('next-round-btn').style.display = 'block';
                 return;
             }
        }

        const selectedPlayers = selectRandomPlayers(currentFolderKey);
        
        if (!selectedPlayers) {
            const count = allStudentsByFolder[currentFolderKey].length;
            document.getElementById('q-num1').textContent = `ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ø³Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ ${selectedFolderName}. (${count} Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§)`;
            document.getElementById('q-num2').textContent = '';
            document.getElementById('q-op2').textContent = '';
            document.getElementById('next-round-btn').style.display = 'block'; 
            document.getElementById('next-round-btn').textContent = 'Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
            return;
        }

        playerName1 = selectedPlayers[0];
        playerName2 = selectedPlayers[1];
        
        // --- ØªÙ‡ÙŠØ¦Ø© Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
        player1Wins = 0;
        player2Wins = 0;
        eliminationQuestionsCount = 0;
        isTieBreaker = false;
        currentTournamentRound = 0; // ÙŠØ¨Ø¯Ø£ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„
        
        let modeDisplay = document.getElementById('mode-select').options[document.getElementById('mode-select').selectedIndex].text;
        
        if (currentMode === 'elimination2') {
             fixedOperation = document.getElementById('operation-select').value;
             document.getElementById('feedback').innerHTML = `Ø§Ù„Ø¢Ù† ÙŠØªÙ†Ø§ÙØ³: ${playerName1} vs ${playerName2} Ù…Ù† ${selectedFolderName} (${modeDisplay} - Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø«Ø§Ø¨ØªØ©: ${fixedOperation === 'R' ? 'ØªÙ‚Ø±ÙŠØ¨' : fixedOperation})`;
        } else if (currentMode === 'elimination3' || currentMode === 'elimination4' || currentMode === 'elimination5') {
             setupTournamentSchedule(); 
             document.getElementById('feedback').innerHTML = `Ø§Ù„Ø¢Ù† ÙŠØªÙ†Ø§ÙØ³: ${playerName1} vs ${playerName2} Ù…Ù† ${selectedFolderName} (${modeDisplay})`;
        } else { // elimination1
             document.getElementById('feedback').innerHTML = `Ø§Ù„Ø¢Ù† ÙŠØªÙ†Ø§ÙØ³: ${playerName1} vs ${playerName2} Ù…Ù† ${selectedFolderName} (${modeDisplay})`;
        }


        document.getElementById('score1-display').innerHTML = `${playerName1} (ÙÙˆØ²): ${player1Wins.toLocaleString(ARABIC_LOCALE)}`;
        document.getElementById('score2-display').innerHTML = `${playerName2} (ÙÙˆØ²): ${player2Wins.toLocaleString(ARABIC_LOCALE)}`;

        document.getElementById('next-round-btn').style.display = 'none'; 
        
        currentPlayer = 1;
        document.getElementById('answer-options-container').innerHTML = ''; 
        
        setTimeout(generateQuestion, 2000); 
    }


    function startGame() {
        // (ÙƒÙˆØ¯ Ø­ÙØ¸ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶)
        const namesA = document.getElementById('folder-a-names').value;
        const namesB = document.getElementById('folder-b-names').value;
        const namesC = document.getElementById('folder-c-names').value;
        
        localStorage.setItem('mathHeroesNamesA', namesA);
        localStorage.setItem('mathHeroesNamesB', namesB);
        localStorage.setItem('mathHeroesNamesC', namesC);


        const parseNames = (names) => names.split('\n').map(name => name.trim()).filter(name => name.length > 0);

        allStudentsByFolder.A = parseNames(namesA);
        allStudentsByFolder.B = parseNames(namesB);
        allStudentsByFolder.C = parseNames(namesC);

        folderNames.A = document.getElementById('folder-a-name-input').value.trim() || "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£";
        folderNames.B = document.getElementById('folder-b-name-input').value.trim() || "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¨";
        folderNames.C = document.getElementById('folder-c-name-input').value.trim() || "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬";
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†
        currentFolderKey = document.getElementById('folder-select').value;
        if (allStudentsByFolder[currentFolderKey].length < 2) {
             alert(`ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ù…ØªØ³Ø§Ø¨Ù‚Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙÙŠ ${folderNames[currentFolderKey]} Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©.`);
             return;
        }

        // Ø­ÙØ¸ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        saveGlobalScores();
        gameStarted = true;
        document.getElementById('start-btn').textContent = 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø¯Ø¡';
        document.getElementById('next-round-btn').style.display = 'block'; 
        document.getElementById('next-round-btn').textContent = 'Ø¬ÙˆÙ„Ø© Ø¥Ù‚ØµØ§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©';
        document.getElementById('names-section').style.opacity = 0.5; // ØªØ¹ØªÙŠÙ… Ù‚Ø³Ù… Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨ Ù„Ù„Ø¨Ø·ÙˆÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        folderStudentsInPlay = [...allStudentsByFolder[currentFolderKey]];
        
        // Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ startNewRound Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
        document.getElementById('feedback').innerHTML = `ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡. Ø§Ø¶ØºØ· "Ø¬ÙˆÙ„Ø© Ø¥Ù‚ØµØ§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ù„Ø¨Ø¯Ø¡ Ø¨ÙŠÙ† Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠÙŠÙ† Ù…Ù† ${folderNames[currentFolderKey]}.`;
        document.getElementById('q-num1').textContent = 'Ø¬Ø§Ù‡Ø²ÙˆÙ† Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚!';
        document.getElementById('q-num2').textContent = '';
        document.getElementById('q-op2').textContent = '';
        document.getElementById('answer-options-container').innerHTML = ''; 
    }
    
    function generateQuestion() {
        if (!gameStarted) return;
        
        clearTimer();
        isProcessing = false;
        document.getElementById('feedback').innerHTML = '';
        document.getElementById('answer-options-container').innerHTML = ''; 
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ
        let op, level;
        
        // Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø­Ø¯Ø« Ù„ÙŠØ´Ù…Ù„ E3, E4, E5
        if (currentMode === 'elimination3' || currentMode === 'elimination4' || currentMode === 'elimination5') {
             const roundInfo = tournamentSchedule[Math.min(currentTournamentRound, tournamentSchedule.length - 1)];
             op = roundInfo.operation;
             level = roundInfo.level;
             
             // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„ØªØµØ§Ø¹Ø¯ Ø§Ù„Ø´Ø§Ù…Ù„
             const opName = op === 'R' ? 'ØªÙ‚Ø±ÙŠØ¨' : op;
             const currentPlayerName = currentPlayer === 1 ? playerName1 : playerName2;
             document.getElementById('feedback').innerHTML = `Ø§Ù„Ø¯ÙˆØ± Ù„Ù€ **${currentPlayerName}** - ğŸ¯ Ø§Ù„Ù‡Ø¯Ù: Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${level.toLocaleString(ARABIC_LOCALE)} (${opName})`;
             
        } else if (currentMode === 'elimination2') {
             op = fixedOperation;
             level = Math.min(currentTournamentRound + 1, MAX_LEVEL); // Ù…Ø³ØªÙˆÙ‰ ØªØµØ§Ø¹Ø¯ÙŠ ÙŠØ¨Ø¯Ø£ Ù…Ù† 1
        } else { // elimination1
             op = document.getElementById('operation-select').value;
             level = document.getElementById('level-select').value;
        }

        let questionData;
        let decimalsToDisplay = 0; 
        
        if (op === 'R') {
             questionData = generateRoundingQuestion(level);
             decimalsToDisplay = questionData.roundingDisplayDecimals;
             currentRoundingDecimals = decimalsToDisplay; 
        } else {
             questionData = generateOperationQuestion(level, op);
             decimalsToDisplay = questionData.requiredDecimals; 
             currentRoundingDecimals = decimalsToDisplay; 
        }
        
        num1 = questionData.n1;
        num2 = questionData.n2;
        correctAnswerValue = questionData.result;
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© (Ø¨Ø¯ÙˆÙ† ÙØ§ØµÙ„Ø© Ø¢Ù„Ø§Ù)
        const formattedNum1 = formatNumberDisplay(num1, (op === '+' || op === '-') ? decimalsToDisplay : 0, op === 'R');
        let formattedNum2 = '';
        let operatorDisplay = op;

        if (op === 'R') {
            operatorDisplay = 'Ù‚Ø±Ø¨ Ø¥Ù„Ù‰:';
            formattedNum2 = num2; 
        } else {
            formattedNum2 = formatNumberDisplay(num2, (op === '+' || op === '-') ? decimalsToDisplay : 0, false);
            operatorDisplay = op === '*' ? 'Ã—' : op === '/' ? 'Ã·' : op;
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„
        document.getElementById('q-num1').textContent = formattedNum1;
        document.getElementById('q-op2').textContent = operatorDisplay;
        document.getElementById('q-num2').textContent = formattedNum2;

        // ØªÙˆÙ„ÙŠØ¯ ÙˆØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØ®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ´ØªÙŠØª
        correctAnswerDisplay = formatNumberDisplay(correctAnswerValue, decimalsToDisplay, op === 'R' && (decimalsToDisplay === 0));
        const distractors = generateDistractors(correctAnswerValue, decimalsToDisplay); 
        
        let options = shuffleArray([...distractors, correctAnswerDisplay]);

        // Ø¹Ø±Ø¶ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙƒØ£Ø²Ø±Ø§Ø±
        const optionsContainer = document.getElementById('answer-options-container');
        optionsContainer.innerHTML = '';
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'answer-btn';
            button.textContent = option;
            button.onclick = () => checkAnswer(button, option);
            optionsContainer.appendChild(button);
        });
        
        // Ù…Ø¤Ø´Ø± Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„ÙˆÙ‚Øª
        const currentName = currentPlayer === 1 ? playerName1 : playerName2;
        document.getElementById('current-player').textContent = currentName;
        
        let time = TIME_LIMIT; 

        document.getElementById('timer-display').style.color = '#333';
        startTimer(time);
    }
    
    function checkAnswer(selectedButton, selectedAnswer) {
        if (isProcessing) return;
        isProcessing = true;
        clearTimer(); 
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙƒÙ†ØµÙˆØµ Ù…Ù†Ø³Ù‚Ø© 
        const isCorrect = selectedAnswer === correctAnswerDisplay;
        const feedbackElement = document.getElementById('feedback');
        
        document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
        
        if (isCorrect) {
            selectedButton.classList.add('correct-answer');
            feedbackElement.innerHTML = `<span class="correct">Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! (+1 ÙÙˆØ² Ù„Ù€ ${currentPlayer === 1 ? playerName1 : playerName2})</span>`;
            
            if (currentPlayer === 1) {
                player1Wins += 1;
            } else {
                player2Wins += 1;
            }
            
        } else {
            selectedButton.classList.add('wrong-answer');
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø²Ø± Ø§Ù„ØµØ­ÙŠØ­ Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡
            document.querySelectorAll('.answer-btn').forEach(btn => {
                if (btn.textContent === correctAnswerDisplay) {
                    btn.classList.add('correct-answer');
                }
            });
            feedbackElement.innerHTML = `<span class="wrong">Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: ${correctAnswerDisplay}</span>`;
        }

        eliminationQuestionsCount += 1; 
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ² Ø§Ù„Ø­Ø§Ù„ÙŠ
        document.getElementById('score1-display').innerHTML = `${playerName1} (ÙÙˆØ²): ${player1Wins.toLocaleString(ARABIC_LOCALE)}`;
        document.getElementById('score2-display').innerHTML = `${playerName2} (ÙÙˆØ²): ${player2Wins.toLocaleString(ARABIC_LOCALE)}`;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø© Ø£Ùˆ Ø§Ù„ØªØ¹Ø§Ø¯Ù„
        if (isTieBreaker && eliminationQuestionsCount >= 2) {
           processEliminationRoundEnd();
           return;
        }
        if (!isTieBreaker && eliminationQuestionsCount >= MAX_ELIMINATION_QUESTIONS) {
           processEliminationRoundEnd();
           return;
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
        currentPlayer = (currentPlayer === 1) ? 2 : 1;
        setTimeout(generateQuestion, 2500); 
    }
    
    // ----------------------------------------------------------------
    // --- Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ---
    // ----------------------------------------------------------------
    window.onload = () => {
        loadGlobalScores();
        toggleOpLevelControls(); 
    };
    
</script>
</body>
</html>
