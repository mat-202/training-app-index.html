<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ุฃุจุทุงู ุงูุนูููุงุช ุงูุญุณุงุจูุฉ (ุชุฎุตูุต ุฌููุน ุงูุนูููุงุช) ุจุงูุฃุฑูุงู ุงูุนุฑุจูุฉ</title>
    <style>
        /* ุงูุฃููุงุท (CSS) */
        body { font-family: 'Arial', sans-serif; text-align: center; margin-top: 30px; background-color: #f9f9ff; }
        
        .main-content { 
            display: flex; 
            justify-content: center;
            max-width: 1000px;
            margin: auto; 
        }
        .container { 
            width: 100%;
            padding: 20px; 
            border: 5px solid #4dabf7;
            border-radius: 15px; 
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 { color: #4dabf7; margin-bottom: 20px; }
        
        /* ูุณู ุฅุฏุฎุงู ุงูุฃุณูุงุก ูุงููุฌูุฏุงุช */
        .names-input-section { margin-bottom: 20px; padding: 15px; border: 1px dashed #ccc; border-radius: 8px; display: flex; justify-content: space-between; gap: 10px; }
        .folder { width: 33%; text-align: right; }
        .folder-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .folder label { font-weight: bold; color: #e63946; display: inline-block; }
        
        /* ๐ ููุท ุญูู ุงูุฅุฏุฎุงู ุงููุชุนุฏุฏ */
        .folder textarea { width: 100%; resize: vertical; margin-bottom: 5px; box-sizing: border-box; }
        .folder button { 
             width: 100%;
             background-color: #4dabf7; 
             color: white; 
             border: none; 
             padding: 5px 10px; 
             cursor: pointer; 
             border-radius: 3px;
             margin-bottom: 10px;
        }

        /* ๐ ููุท ูุงุฆูุฉ ุงููุชุณุงุจููู ุงูุฌุฏูุฏุฉ */
        .contestants-list {
            margin-top: 5px;
            height: 120px;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch; 
            -ms-overflow-style: -ms-autohiding-scrollbar; 
            
            border: 1px solid #4dabf7;
            border-radius: 4px;
            padding: 5px;
            text-align: right;
            box-sizing: border-box;
            background-color: #f8faff;
        }
        .contestant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            border-bottom: 1px dotted #ccc;
        }
        .contestant-item:last-child {
            border-bottom: none;
        }
        .contestant-item input[type="checkbox"] {
            margin-left: 10px; 
        }
        .contestant-item button {
             background: none;
             border: none;
             cursor: pointer;
             font-size: 0.9em;
             color: #e63946;
             padding: 0; 
             width: auto; 
        }

        /* ุฅุนุฏุงุฏุงุช ุงูุฌููุฉ */
        .round-setup { margin-bottom: 20px; padding: 15px; background-color: #f1f3f5; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; }
        .round-setup label { font-weight: bold; }
        .round-setup select { padding: 8px; font-size: 1em; border-radius: 5px; border: 1px solid #ffd43b; }
        
        /* ุฅุฎูุงุก ุฅุนุฏุงุฏุงุช ุงูุนูููุฉ ูุงููุณุชูู ูู ุจุนุถ ุงูุฃูุถุงุน */
        .op-level-control { 
            transition: opacity 0.5s; 
        }
        .hide-op-level .op-level-control {
            opacity: 0.2;
            pointer-events: none;
        }

        .header-section { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
            gap: 15px;
        }
        #turn-indicator { 
            font-size: 1.5em; 
            flex: 1;
            text-align: right;
        }
        
        /* ๐ ุชุตููู ุงููุคูุช ูุงูุนุฏุฏ ุงููุชุจูู ูู ููุณ ุงูุณุทุฑ */
        .timer-and-count-container {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            justify-content: flex-start;
        }
        
        #timer-display { 
            font-size: 2em; 
            font-weight: bold; 
            color: #333; 
            padding: 5px 15px; 
            border: 3px dashed #ffd43b; 
            border-radius: 8px; 
            min-width: 120px;
            text-align: center;
        }
        
        /* ๐ ุชุตููู ุงูุนุฏุฏ ุงููุชุจูู ุจุฌุงูุจ ุงููุคูุช */
        #remaining-count-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #4dabf7;
            padding: 5px 10px;
            border: 2px solid #4dabf7;
            border-radius: 6px;
            background-color: #e7f5ff;
            white-space: nowrap;
            direction: rtl;
            min-width: 60px;
            text-align: center;
        }
        #remaining-count-display .count-number {
            color: #e63946;
            font-size: 1.1em;
            font-weight: bold;
            margin-right: 3px;
        }

        /* ุชุนุฏููุงุช ุงูุณุคุงู ููุตุจุญ ุนููุฏููุง */
        #question { 
            font-size: 3em; 
            margin: 30px auto; 
            color: #333; 
            min-height: 150px; 
            width: 350px; 
            text-align: right; 
        }
        .q-line {
            display: flex;
            justify-content: flex-end; 
            font-size: 1em;
            height: 1.2em;
            line-height: 1.2em;
            flex-wrap: wrap;
        }
        #q-num1, #q-num2 {
            min-width: 150px; 
            text-align: right;
            padding-right: 5px;
            white-space: nowrap; 
        }
        #q-op2 {
             min-width: 120px; 
             text-align: center;
             font-size: 0.8em; 
             font-weight: bold;
             padding-right: 5px;
        }
        #q-line-separator {
            border-bottom: 5px solid #000;
            margin: 5px 0 10px 0;
            width: 100%;
        }

        /* ุญุงููุฉ ุฎูุงุฑุงุช ุงูุฅุฌุงุจุฉ */
        #answer-options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px auto;
            max-width: 700px;
        }

        /* ุฃุฒุฑุงุฑ ุงูุฅุฌุงุจุฉ ุงูุฌุฏูุฏุฉ */
        .answer-btn { 
            background-color: #4dabf7; 
            color: white; 
            padding: 20px 15px; 
            font-size: 2em; 
            border: none; 
            cursor: pointer; 
            border-radius: 10px; 
            transition: background-color 0.3s, transform 0.1s; 
            box-shadow: 0 4px #339af0; 
            min-height: 80px;
        }
        .answer-btn:hover:not(:disabled) { 
            background-color: #339af0; 
            transform: translateY(2px);
            box-shadow: 0 2px #1c7ed6;
        }
        .answer-btn:disabled { 
            cursor: not-allowed; 
            opacity: 0.6;
            box-shadow: none;
        }
        .correct-answer { background-color: #40c057 !important; box-shadow: 0 4px #2f9e44 !important; }
        .wrong-answer { background-color: #e63946 !important; box-shadow: 0 4px #c92a2a !important; }

        /* ุงูุฃููุงุท ุงูุฃุฎุฑู */
        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        #start-btn, #next-round-btn { padding: 12px 25px; font-size: 1.4em; color: white; border: none; cursor: pointer; border-radius: 8px; transition: background-color 0.3s; }
        #start-btn { background-color: #40c057; }
        #next-round-btn { background-color: #4dabf7; display: none; } 

        /* ููุท ููุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ */
        .correct { color: #40c057; font-weight: bold; }
        .wrong { color: #e63946; font-weight: bold; }
        
        /* ๐ ุชูุณูู ูุณู ุงููุชุณุงุจููู ุงููุชุจููู */
        .remaining-contestants-section {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #4dabf7;
            border-radius: 10px;
            background-color: #e7f5ff; 
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            text-align: right;
        }
        .remaining-contestants-section h2 {
            color: #339af0;
            border-bottom: 2px dashed #a5d8ff;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        #remaining-contestants-display {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            line-height: 1.6;
        }
        
        /* ูุณู ุฅุญุตุงุฆูุงุช ุงููุดุงุฑูุงุช */
        .participation-stats-section {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #40c057;
            border-radius: 8px;
            background-color: #ebfbee;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
            text-align: right;
        }
        .participation-stats-section h3 {
            color: #2f9e44;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        #participation-stats-display {
            font-size: 1em;
            color: #333;
            line-height: 1.4;
        }
        
        /* ุชูุณูู ุงูุชุฐููู */
        .footer-text {
            margin-top: 40px;
            padding: 10px 0;
            font-size: 1.1em;
            color: #555;
            text-align: center;
            border-top: 1px solid #ccc;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        /* ุชูุณูู ุงูุฌูุงู ูู ุงููุถุน ุงูุฃููู */
        @media screen and (max-width: 1024px) and (orientation: landscape) {
            .main-content {
                max-width: 100%;
                padding: 10px;
            }
            
            .container {
                padding: 15px;
                width: 100%;
            }
            
            /* ุฌุนู ุงูุฃุฌูุจุฉ ูู ุตู ูุงุญุฏ */
            #answer-options-container {
                grid-template-columns: 1fr 1fr 1fr 1fr;
                gap: 10px;
                max-width: 100%;
                margin: 15px auto;
            }
            
            .answer-btn {
                font-size: 1.5em;
                padding: 15px 10px;
                min-height: 70px;
            }
            
            /* ุชุนุฏูู ุญุฌู ุงูุณุคุงู */
            #question {
                font-size: 2.5em;
                margin: 20px auto;
                min-height: 130px;
                width: 300px;
            }
            
            .q-line {
                font-size: 0.9em;
                height: 1.1em;
                line-height: 1.1em;
            }
            
            /* ุชุนุฏูู ูุณู ุงูุฃุณูุงุก ููููู ุนููุฏูุงู ูู ุงูุดุงุดุงุช ุงูุตุบูุฑุฉ */
            .names-input-section {
                flex-direction: column;
            }
            
            .folder {
                width: 100%;
                margin-bottom: 15px;
            }
            
            .folder:last-child {
                margin-bottom: 0;
            }
            
            /* ุชุนุฏูู ูุณู ุฅุนุฏุงุฏ ุงูุฌููุฉ */
            .round-setup {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .round-setup > * {
                width: 100%;
            }
            
            .round-setup label, 
            .round-setup select {
                width: 100%;
                margin-bottom: 5px;
            }
            
            /* ุชุนุฏูู ุญุฌู ุงูุฎุทูุท */
            h1 {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
            
            #timer-display {
                font-size: 1.5em;
                min-width: 110px;
                padding: 4px 12px;
            }
            
            #remaining-count-display {
                font-size: 1.1em;
                padding: 4px 8px;
            }
            
            #turn-indicator {
                font-size: 1.2em;
            }
            
            /* ุชุนุฏูู ูุณู ุงููุชุณุงุจููู ุงููุชุจููู */
            .remaining-contestants-section {
                padding: 10px;
                margin-top: 20px;
            }
            
            .remaining-contestants-section h2 {
                font-size: 1.1em;
            }
            
            #remaining-contestants-display {
                font-size: 1em;
            }
            
            /* ุชุนุฏูู ุงูุฃุฒุฑุงุฑ */
            #start-btn, #next-round-btn {
                padding: 10px 20px;
                font-size: 1.2em;
            }
        }

        /* ููุดุงุดุงุช ุงูุฃุตุบุฑ ุฌุฏุงู ูู ุงููุถุน ุงูุฃููู */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            #answer-options-container {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            
            .answer-btn {
                font-size: 1.3em;
                padding: 12px 8px;
                min-height: 60px;
            }
            
            #question {
                font-size: 2.2em;
                min-height: 110px;
                width: 280px;
            }
            
            h1 {
                font-size: 1.6em;
            }
        }
        
        /* ููุดุงุดุงุช ุงูุตุบูุฑุฉ ูู ุงููุถุน ุงูุนุงููุฏู */
        @media screen and (max-width: 768px) {
            .header-section {
                flex-direction: column;
                gap: 10px;
            }
            
            #turn-indicator {
                order: 1;
                text-align: center;
                width: 100%;
            }
            
            .timer-and-count-container {
                order: 2;
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>

<div class="main-content">
    <div class="container">
        <h1>ุฃุจุทุงู ุงูุนูููุงุช ุงูุญุณุงุจูุฉ</h1>
        
        <div class="names-input-section" id="names-section">
            <div class="folder">
                <div class="folder-header">
                    <label for="folder-a-name-input">ุงุณู ุงููุฌูุฏ:</label>
                    <input type="text" id="folder-a-name-input" value="ุงููุฌููุนุฉ ุฃ">
                </div>
                <textarea id="bulk-input-A" rows="4" placeholder="ุฃูุตู ูุงุฆูุฉ ุงูุฃุณูุงุก ููุง (ูู ุงุณู ูู ุณุทุฑ)"></textarea>
                <button onclick="updateContestantsFromBulk('A')">ุชุญุฏูุซ ุงููุงุฆูุฉ ูู ููุง</button>
                <hr>
                <div id="contestants-list-A" class="contestants-list">
                    </div>
            </div>
            <div class="folder">
                <div class="folder-header">
                    <label for="folder-b-name-input">ุงุณู ุงููุฌูุฏ:</label>
                    <input type="text" id="folder-b-name-input" value="ุงููุฌููุนุฉ ุจ">
                </div>
                <textarea id="bulk-input-B" rows="4" placeholder="ุฃูุตู ูุงุฆูุฉ ุงูุฃุณูุงุก ููุง (ูู ุงุณู ูู ุณุทุฑ)"></textarea>
                <button onclick="updateContestantsFromBulk('B')">ุชุญุฏูุซ ุงููุงุฆูุฉ ูู ููุง</button>
                <hr>
                <div id="contestants-list-B" class="contestants-list">
                    </div>
            </div>
            <div class="folder">
                <div class="folder-header">
                    <label for="folder-c-name-input">ุงุณู ุงููุฌูุฏ:</label>
                    <input type="text" id="folder-c-name-input" value="ุงููุฌููุนุฉ ุฌ">
                </div>
                <textarea id="bulk-input-C" rows="4" placeholder="ุฃูุตู ูุงุฆูุฉ ุงูุฃุณูุงุก ููุง (ูู ุงุณู ูู ุณุทุฑ)"></textarea>
                <button onclick="updateContestantsFromBulk('C')">ุชุญุฏูุซ ุงููุงุฆูุฉ ูู ููุง</button>
                <hr>
                <div id="contestants-list-C" class="contestants-list">
                    </div>
            </div>
        </div>

        <div class="round-setup" id="round-setup">
            <label for="folder-select">ุงุฎุชุฑ ูุฌูุฏ ุงูููุงูุณุฉ:</label>
            <select id="folder-select">
                <option value="A">ุงููุฌููุนุฉ ุฃ</option>
                <option value="B">ุงููุฌููุนุฉ ุจ</option>
                <option value="C">ุงููุฌููุนุฉ ุฌ</option>
            </select>
            
            <div class="op-level-control">
                <label for="operation-select">ุงุฎุชุฑ ุงูุนูููุฉ:</label>
                <select id="operation-select">
                    <option value="+">ุฌูุน</option>
                    <option value="-">ุทุฑุญ</option>
                    <option value="*">ุถุฑุจ</option>
                    <option value="/">ูุณูุฉ</option>
                    <option value="R">ุชูุฑูุจ</option> 
                </select>
            </div>
            
            <div class="op-level-control">
                <label for="level-select">ุงุฎุชุฑ ุงููุณุชูู:</label>
                <select id="level-select">
                    <option value="1">ุงููุณุชูู 1</option>
                    <option value="2">ุงููุณุชูู 2</option>
                    <option value="3">ุงููุณุชูู 3</option>
                    <option value="4">ุงููุณุชูู 4</option>
                    <option value="5">ุงููุณุชูู 5</option>
                </select>
            </div>
            
            <label for="mode-select">ุงุฎุชุฑ ูุถุน ุงููุณุงุจูุฉ:</label>
            <select id="mode-select" onchange="toggleOpLevelControls()">
                <option value="elimination4">ูุณุงุจูุฉ ุตู ุซุงูุซ (ุชุตุงุนุฏู ุดุงูู - ุญุฏ ุฃูุตู 3)</option>
                <option value="elimination5">ูุณุงุจูุฉ ุตู ุฑุงุจุน (ุชุตุงุนุฏู ุดุงูู - ุญุฏ ุฃูุตู 4)</option>
                <option value="elimination3">ูุณุงุจูุฉ ุตู ุฎุงูุณ ูุฃุนูู (ุชุตุงุนุฏู ุดุงูู - ุญุฏ ุฃูุตู 5)</option>
                <option value="elimination1">ูุณุงุจูุฉ ุนุงูุฉ (ูุณู ููุณุชูู ุซุงุจุช)</option>
                <option value="elimination2">ูุณุงุจูุฉ ุนุงูุฉ (ูุณู ุซุงุจุช ููุณุชูู ุชุตุงุนุฏู)</option>
            </select>
            
            <button id="start-btn" onclick="startGame()">ุจุฏุก ุงููุณุงุจูุฉ</button> 
            <button id="next-round-btn" onclick="startNewRound()" style="display: none;">ุฌููุฉ ุฌุฏูุฏุฉ</button>
        </div>

        <div class="header-section">
            <div id="turn-indicator">
                ุงูุฏูุฑ: <span id="current-player" class="player-turn">ุฃุฏุฎู ุงูุฃุณูุงุก</span>
            </div>
            
            <!-- ๐ ุญุงููุฉ ุงููุคูุช ูุงูุนุฏุฏ ุงููุชุจูู ูู ููุณ ุงูุณุทุฑ -->
            <div class="timer-and-count-container">
                <div id="timer-display">30 ุซูุงูู</div> 
                <div id="remaining-count-display">
                    <span class="count-number">0</span> ูุชุจููู
                </div>
            </div>
        </div>

        <div id="question">
             <div class="q-line" id="q-line-1">
                 <span id="q-op"></span>
                 <span id="q-num1">ุงุถุบุท ุจุฏุก ุงููุณุงุจูุฉ</span>
             </div>
             <div class="q-line" id="q-line-2">
                 <span id="q-op2"></span>
                 <span id="q-num2"></span>
             </div>
             <div id="q-line-separator"></div>
        </div> 
        
        <div id="answer-options-container">
            </div>

        <div id="feedback"></div>

        <div class="score-boards">
            <div id="score1-display" class="score">ุงููุชุณุงุจู 1: 0</div>
            <div id="score2-display" class="score">ุงููุชุณุงุจู 2: 0</div>
        </div>
    </div>
    
</div>

<div class="remaining-contestants-section">
    <h2>ุงููุชุณุงุจููู ุงูุฐูู ูุง ุฒุงููุง ูู ุงูููุงูุณุฉ</h2>
    <p id="remaining-contestants-display" dir="rtl">ุงุถุบุท "ุฌููุฉ ุฅูุตุงุก ุฌุฏูุฏุฉ" ูุนุฑุถ ุงููุชุณุงุจููู ุงููุชุจููู...</p>
</div>

<div class="participation-stats-section">
    <h3>ุฅุญุตุงุฆูุงุช ุงููุดุงุฑูุงุช (ุนุฏุฏ ุงููุฑุงุช ุงูุชู ูุนุจ ูููุง ูู ูุชุณุงุจู)</h3>
    <p id="participation-stats-display" dir="rtl">ุณูุชู ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงููุดุงุฑูุงุช ุจุนุฏ ุจุฏุก ุงููุณุงุจูุฉ...</p>
</div>

<p class="footer-text" dir="rtl">ุฅุนุฏุงุฏ: ุงูุฃุณุชุงุฐ ุนุจุฏุงูุนุฒูุฒ ุงูุญุฌููู</p>

<script>
    let num1, num2, correctAnswerValue; 
    let correctAnswerDisplay; 
    let score1 = 0; 
    let score2 = 0; 
    let currentPlayer = 1; 
    let isProcessing = false;
    let gameStarted = false; 

    let playerName1 = "ุงููุชุณุงุจู 1";
    let playerName2 = "ุงููุชุณุงุจู 2";
    let currentFolderKey = ''; 
    
    let allStudentsByFolder = { A: [], B: [], C: [] }; 
    let folderNames = { A: "ุงููุฌููุนุฉ ุฃ", B: "ุงููุฌููุนุฉ ุจ", C: "ุงููุฌููุนุฉ ุฌ" }; 
    let globalScores = {}; 
    let currentRoundingDecimals = 0; 
    let currentRoundingPlace = ''; 

    const TIME_LIMIT = 30; 
    let timeRemaining = TIME_LIMIT;
    let timerInterval;

    const ARABIC_LOCALE = 'ar-SA'; 
    
    // --- ูุชุบูุฑุงุช ุฎุฑูุฌ ุงููุบููุจ ---
    let currentMode = 'elimination1';
    const MAX_ELIMINATION_QUESTIONS = 2; 
    let eliminationQuestionsCount = 0; 
    let player1Wins = 0;
    let player2Wins = 0;
    let folderStudentsInPlay = []; 
    let isTieBreaker = false; 
    
    // --- ูุชุบูุฑุงุช ุงูุชุตุงุนุฏ (Elimination 2 & 3 & 4 & 5) ---
    let currentTournamentRound = 0; 
    let tournamentSchedule = []; 
    let fixedOperation = ''; 
    const ALL_OPERATIONS = ['+', '-', '*', '/', 'R']; 
    const MAX_LEVEL = 5; 
    
    // --- ูุชุบูุฑุงุช ุฌุฏูุฏุฉ ูุชุชุจุน ุงููุดุงุฑูุงุช ูููุน ุงูุชูุฑุงุฑ ---
    let recentWinners = []; // ูุชุฎุฒูู ุงููุงุฆุฒูู ุงูุฃุฎูุฑูู ูููุน ุชูุฑุงุฑูู
    const MAX_RECENT_WINNERS = 3; // ุนุฏุฏ ุงููุงุฆุฒูู ุงูุฃุฎูุฑูู ุงูุฐูู ูููุน ุชูุฑุงุฑูู
    let playerParticipationCount = {}; // ูุชุชุจุน ุนุฏุฏ ูุฑุงุช ูุดุงุฑูุฉ ูู ุทุงูุจ
    let availablePlayersForNextRound = []; // ุงููุชุณุงุจููู ุงููุชุงุญูู ููุฌููุฉ ุงููุงุฏูุฉ
    
    // ----------------------------------------------------------------
    // --- ุฏูุงู ุงูุชุญูู ูู ุงููุงุฌูุฉ (ุงูุฃุณูุงุก ููุฑุจุนุงุช ุงูุงุฎุชูุงุฑ) ---
    // ----------------------------------------------------------------

    function updateContestantsFromBulk(folderKey) {
        const textarea = document.getElementById(`bulk-input-${folderKey}`);
        if (!textarea) return;

        const newNames = textarea.value.split(/[\n,;]+/)
            .map(name => name.trim())
            .filter(name => name.length > 0);

        let currentContestants = allStudentsByFolder[folderKey] || [];
        let updatedContestants = [...currentContestants];
        let addedCount = 0;

        newNames.forEach(name => {
            const existing = updatedContestants.find(c => c.name === name);
            
            if (!existing) {
                updatedContestants.push({ name: name, selected: true });
                addedCount++;
            } else {
                existing.selected = true;
            }
        });

        allStudentsByFolder[folderKey] = updatedContestants;

        textarea.value = '';
        
        saveContestantsData();
        renderContestantsList(folderKey);
        
        alert(`ุชูุช ุฅุถุงูุฉ ${addedCount.toLocaleString(ARABIC_LOCALE)} ูุชุณุงุจูุงู ุฌุฏูุฏุงู ุฅูู ${folderNames[folderKey]}.`);
    }

    function removeContestant(folderKey, name) {
        allStudentsByFolder[folderKey] = allStudentsByFolder[folderKey].filter(c => c.name !== name);
        saveContestantsData();
        renderContestantsList(folderKey);
    }

    function toggleContestantSelection(folderKey, name) {
        const contestant = allStudentsByFolder[folderKey].find(c => c.name === name);
        if (contestant) {
            contestant.selected = !contestant.selected;
            saveContestantsData(); 
        }
    }

    function renderContestantsList(folderKey) {
        const listContainer = document.getElementById(`contestants-list-${folderKey}`);
        if (!listContainer) return;
        listContainer.innerHTML = '';
        
        allStudentsByFolder[folderKey].forEach(contestant => {
            const item = document.createElement('div');
            item.className = 'contestant-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = contestant.selected;
            checkbox.onchange = () => toggleContestantSelection(folderKey, contestant.name);

            const nameSpan = document.createElement('span');
            nameSpan.textContent = contestant.name;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'โ';
            deleteBtn.title = `ุญุฐู ${contestant.name}`;
            deleteBtn.onclick = () => removeContestant(folderKey, contestant.name);

            const leftSide = document.createElement('div');
            leftSide.style.display = 'flex';
            leftSide.style.alignItems = 'center';
            leftSide.appendChild(checkbox);
            leftSide.appendChild(nameSpan);

            item.appendChild(leftSide);
            item.appendChild(deleteBtn);
            listContainer.appendChild(item);
        });
    }

    function toggleOpLevelControls() {
        const mode = document.getElementById('mode-select').value;
        const roundSetup = document.getElementById('round-setup');
        
        if (mode === 'elimination1' || mode === 'elimination2') {
            roundSetup.classList.remove('hide-op-level');
        } 
        else if (mode === 'elimination3' || mode === 'elimination4' || currentMode === 'elimination5') {
            roundSetup.classList.add('hide-op-level');
        }
    }
    document.addEventListener('DOMContentLoaded', toggleOpLevelControls);

    function updateRemainingContestantsDisplay() {
        const displayElement = document.getElementById('remaining-contestants-display');
        const folderName = folderNames[currentFolderKey] || 'ุงููุฌููุนุฉ ุงูุญุงููุฉ';
        
        if (folderStudentsInPlay.length === 0) {
            displayElement.innerHTML = `ูุง ููุฌุฏ ูุชุณุงุจููู ูุชุจููู ูู **${folderName}**. ุงุถุบุท "ุฌููุฉ ุฅูุตุงุก ุฌุฏูุฏุฉ" ูุจุฏุก ุจุทููุฉ ุฌุฏูุฏุฉ.`;
        } else if (folderStudentsInPlay.length === 1) {
            const champion = folderStudentsInPlay[0];
            displayElement.innerHTML = `**ุงูุจุทู ุงูุญุงูู:** ๐ ${champion} ๐. ุงุถุบุท "ุจุฏุก ุจุทููุฉ ุฌุฏูุฏุฉ" ููุจุฏุก ูู ุฌุฏูุฏ.`;
        } else {
            const listItems = folderStudentsInPlay.map(name => `<span>${name}</span>`).join(' โข ');
            displayElement.innerHTML = `**ุงููุชุจููู (${folderStudentsInPlay.length.toLocaleString(ARABIC_LOCALE)}):** ${listItems}`;
        }
        
        // ๐ ุชุญุฏูุซ ุงูุนุฏุฏ ุงููุชุจูู ุจุฌุงูุจ ุงููุคูุช
        updateRemainingCountDisplay();
    }
    
    // ๐ ุฏุงูุฉ ุฌุฏูุฏุฉ ูุชุญุฏูุซ ุงูุนุฏุฏ ุงููุชุจูู ุจุฌุงูุจ ุงููุคูุช
    function updateRemainingCountDisplay() {
        const countElement = document.getElementById('remaining-count-display');
        const countNumberElement = countElement.querySelector('.count-number');
        
        if (folderStudentsInPlay.length === 0) {
            countNumberElement.textContent = '0';
        } else {
            countNumberElement.textContent = folderStudentsInPlay.length.toLocaleString(ARABIC_LOCALE);
        }
    }
    
    // ๐ ุฏุงูุฉ ุฌุฏูุฏุฉ ูุนุฑุถ ุฅุญุตุงุฆูุงุช ุงููุดุงุฑูุงุช
    function updateParticipationStatsDisplay() {
        const statsElement = document.getElementById('participation-stats-display');
        
        if (Object.keys(playerParticipationCount).length === 0) {
            statsElement.innerHTML = `ูุง ุชูุฌุฏ ุฅุญุตุงุฆูุงุช ูุดุงุฑูุงุช ุญุชู ุงูุขู.`;
            return;
        }
        
        // ุชุญููู ุงูุจูุงูุงุช ุฅูู ูุตูููุฉ ูุชุฑุชูุจูุง ุชูุงุฒููุงู ุญุณุจ ุนุฏุฏ ุงููุดุงุฑูุงุช
        const statsArray = Object.entries(playerParticipationCount)
            .map(([name, count]) => ({ name, count }))
            .sort((a, b) => b.count - a.count);
        
        const statsItems = statsArray.map(stat => 
            `<span>${stat.name}: ${stat.count.toLocaleString(ARABIC_LOCALE)} ูุดุงุฑูุฉ</span>`
        ).join(' โข ');
        
        statsElement.innerHTML = `**ุฅุญุตุงุฆูุงุช ุงููุดุงุฑูุงุช:** ${statsItems}`;
    }

    // ----------------------------------------------------------------
    // --- ุฏูุงู ุชูููุฏ ุงูุฃุฑูุงู ูุงูุฃุณุฆูุฉ ---
    // ----------------------------------------------------------------

    function generateNumberWithRange(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function generateNumberWithDigits(digits, allowDecimals = 0) {
        let number;
        if (digits === 1) { 
             number = Math.floor(Math.random() * 9) + 1;
        } else if (digits > 1) {
             const min = Math.pow(10, digits - 1);
             const max = Math.pow(10, digits) - 1;
             number = Math.floor(Math.random() * (max - min + 1)) + min;
        } else { 
             number = 0; 
        }
        
        if (allowDecimals > 0) {
            const decimalPart = Math.random();
            number = number + decimalPart;
            number = parseFloat(number.toFixed(Math.max(allowDecimals + 4, 10))); 
        }
        return number;
    }

    function getNumberBounds(level, op) {
        level = parseInt(level);
        const d = (digits, decimals = 0) => ({ d: digits, dec: decimals });
        
        const dec = 0; 

        if (op === '+' || op === '-') {
            if (level === 1) return { n1: d(1, dec), n2: d(1, dec) }; 
            if (level === 2) return { n1: d(2, dec), n2: d(2, dec) }; 
            if (level === 3) return { n1: d(3, dec), n2: d(3, dec) }; 
            if (level === 4) return { n1: d(4, dec), n2: d(4, dec) }; 
            if (level === 5) return { n1: d(5, dec), n2: d(5, dec) }; 
            return { n1: d(1, dec), n2: d(1, dec) }; 
        } 
        
        if (op === '*' || op === '/') {
             if (level === 1) return { n1: { min: 1, max: 10 }, n2: { min: 1, max: 3 } }; 
             if (level === 2) return { n1: { min: 1, max: 10 }, n2: { min: 4, max: 6 } }; 
             if (level === 3) return { n1: { min: 1, max: 10 }, n2: { min: 7, max: 10 } }; 
             
             // ๐ ุงูุชุนุฏูู ุนูู ุงููุณุชูู ุงูุฑุงุจุน ูุงูุฎุงูุณ ูุนูููุฉ ุงููุณูุฉ ููุท
             if (op === '/') {
                if (level === 4) return { 
                    n1: { min: 100, max: 9999 }, // ุงูููุณูู ูุจูุฑ (3-4 ุฃุฑูุงู)
                    n2: { min: 2, max: 9 }      // ุงูููุณูู ุนููู ุฑูู ูุงุญุฏ ููุท
                }; 
                
                if (level === 5) return { 
                    n1: { min: 1000, max: 99999 }, // ุงูููุณูู ุฃูุจุฑ (4-5 ุฃุฑูุงู)
                    n2: { min: 2, max: 9 }       // ุงูููุณูู ุนููู ุฑูู ูุงุญุฏ ููุท
                };
             }
             
             // ุฅุฐุง ูุงูุช ุงูุนูููุฉ ุถุฑุจุ ุชุจูู ููุง ูุงูุช (ุถุฑุจ ุนูู ุฑูููู)
             if (level === 4) return { 
                 n1: { min: 10, max: 9999 }, 
                 n2: { min: 2, max: 9 } 
             }; 
             
             if (level === 5) return { 
                 n1: { min: 10, max: 9999 }, 
                 n2: { min: 10, max: 99 }
             };
        }
        
        return { n1: d(1), n2: d(1) }; 
    }

    function generateOperationQuestion(level, op) {
        const bounds = getNumberBounds(level, op);
        let n1, n2, result;
        level = parseInt(level);
        let maxDecimals = 0;

        if (op === '+' || op === '-') {
             const dec1 = bounds.n1.dec;
             const dec2 = bounds.n2.dec;
             maxDecimals = Math.max(dec1, dec2); 
             
             n1 = generateNumberWithDigits(bounds.n1.d, dec1);
             n2 = generateNumberWithDigits(bounds.n2.d, dec2);

             if (op === '+') {
                result = n1 + n2;
             } else if (op === '-') {
                while (n2 >= n1 || n2 === 0) { 
                    n2 = generateNumberWithDigits(bounds.n2.d, dec2);
                    if (n1 <= 1) n1 = generateNumberWithDigits(bounds.n1.d, dec1); 
                }
                
                result = n1 - n2;
             }
             
             result = parseFloat(result.toFixed(maxDecimals)); 
             return { n1, n2, result, requiredDecimals: maxDecimals, isRounding: false, op: op };
        }
        
        if (op === '*' || op === '/') {
             let factor1, factor2, product;

             factor1 = generateNumberWithRange(bounds.n1.min, bounds.n1.max);
             factor2 = generateNumberWithRange(bounds.n2.min, bounds.n2.max);
             product = factor1 * factor2;
             
             if (level >= 1 && level <= 3) {
                 if (factor1 < factor2) [factor1, factor2] = [factor2, factor1];
             }
             
             if (op === '*') {
                 n1 = factor1;
                 n2 = factor2;
                 result = product;
             } else if (op === '/') {
                 n1 = product; 
                 n2 = factor2; 
                 result = factor1; 
             }
             
             return { n1, n2, result, requiredDecimals: 0, isRounding: false, op: op };
        }
        
        return { n1: 1, n2: 1, result: 2, requiredDecimals: 0, isRounding: false, op: op };
    }
    
    // ๐ ูุธููุฉ ูุณุงุนุฏุฉ ูุญุณุงุจ ุงูุชูุฑูุจ (ุชู ุงูุชุนุฏูู ููุง)
    function calculateRounding(number, place) {
        const places = {
            'ุฃูุฑุจ ุนุดุฑุฉ': { value: 10, decimals: 0 },
            'ุฃูุฑุจ ูุฆุฉ': { value: 100, decimals: 0 },
            'ุฃูุฑุจ ุฃูู': { value: 1000, decimals: 0 },
            'ุฃูุฑุจ ุนุดุฑุฉ ุขูุงู': { value: 10000, decimals: 0 },
            'ุฃูุฑุจ ูุฆุฉ ุฃูู': { value: 100000, decimals: 0 },
            'ุฃูุฑุจ ููููู': { value: 1000000, decimals: 0 },
            'ุฌุฒุก ูู ุนุดุฑุฉ': { value: 0.1, decimals: 1 },
            'ุฌุฒุก ูู ูุฆุฉ': { value: 0.01, decimals: 2 },
            'ุฌุฒุก ูู ุฃูู': { value: 0.001, decimals: 3 }
        };

        const { value, decimals } = places[place] || { value: 1, decimals: 0 };

        if (value >= 1) { // ุชูุฑูุจ ุงูุฃุนุฏุงุฏ ุงูุตุญูุญุฉ
            const roundingFactor = value;
            const result = Math.round(number / roundingFactor) * roundingFactor;
            return { result, decimals };
        } else { // ุชูุฑูุจ ุงูุฃุฌุฒุงุก ุงูุนุดุฑูุฉ (ุชู ุงูุชุนุฏูู ูุถูุงู ุงูุชูุฑูุจ ุงูุฑูุงุถู)
            const powerOfTen = Math.pow(10, decimals);
            
            // ๐ก ุงูุญู: ูุณุชุฎุฏู Math.round / powerOfTen ูุจุงุดุฑุฉ
            // ูุชุทุจูู ุงูุชูุฑูุจ ุงูุฑูุงุถู ุงูุตุญูุญ ูุชุฌูุจ ูุดุงูู toFixed()
            const result = Math.round(number * powerOfTen) / powerOfTen;
            
            return { result: result, decimals };
        }
    }

    function generateRoundingQuestion(level) {
        let numberToRound;
        let roundingPlaceKey;
        let finalDecimalPlaces = 0;
        let decimalPlacesToGenerate = 0; 
        level = parseInt(level);

        const wholePlaces = ['ุฃูุฑุจ ุนุดุฑุฉ', 'ุฃูุฑุจ ูุฆุฉ', 'ุฃูุฑุจ ุฃูู', 'ุฃูุฑุจ ุนุดุฑุฉ ุขูุงู', 'ุฃูุฑุจ ูุฆุฉ ุฃูู', 'ุฃูุฑุจ ููููู'];
        const decimalPlacesList = ['ุฌุฒุก ูู ุนุดุฑุฉ', 'ุฌุฒุก ูู ูุฆุฉ', 'ุฌุฒุก ูู ุฃูู'];
        
        if (level === 1) {
            roundingPlaceKey = 'ุฃูุฑุจ ุนุดุฑุฉ';
            numberToRound = generateNumberWithRange(10, 99999); 
            decimalPlacesToGenerate = 0;
        
        } else if (level === 2) {
            const options = ['ุฃูุฑุจ ูุฆุฉ', 'ุฃูุฑุจ ุฃูู'];
            roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
            numberToRound = generateNumberWithRange(100, 999999);
            decimalPlacesToGenerate = 0;
            
        } else if (level === 3) {
            const options = { 'ุฌุฒุก ูู ุนุดุฑุฉ': 1, 'ุฌุฒุก ูู ูุฆุฉ': 2 };
            const keys = Object.keys(options);
            roundingPlaceKey = keys[Math.floor(Math.random() * keys.length)];
            finalDecimalPlaces = options[roundingPlaceKey];
            
            decimalPlacesToGenerate = finalDecimalPlaces + 1 + Math.floor(Math.random() * 2); 
            const wholeDigits = generateNumberWithRange(1, 2); 
            numberToRound = generateNumberWithDigits(wholeDigits, decimalPlacesToGenerate); 
            
        } else { // level 4 & 5
            const wholeOptions = ['ุฃูุฑุจ ุฃูู', 'ุฃูุฑุจ ุนุดุฑุฉ ุขูุงู', 'ุฃูุฑุจ ูุฆุฉ ุฃูู'];
            const randomPlace = wholeOptions[Math.floor(Math.random() * wholeOptions.length)];
            
            if (Math.random() < 0.3 && level === 5) { 
                 roundingPlaceKey = 'ุฌุฒุก ูู ุฃูู';
                 finalDecimalPlaces = 3;
                 decimalPlacesToGenerate = 4 + Math.floor(Math.random() * 2);
                 const wholeDigits = generateNumberWithRange(1, 4);
                 numberToRound = generateNumberWithDigits(wholeDigits, decimalPlacesToGenerate); 
            } else { 
                 roundingPlaceKey = randomPlace;
                 let minBound = randomPlace === 'ุฃูุฑุจ ุฃูู' ? 1000 : randomPlace === 'ุฃูุฑุจ ุนุดุฑุฉ ุขูุงู' ? 10000 : 100000;
                 numberToRound = generateNumberWithRange(minBound * 1.5, minBound * 10);
                 decimalPlacesToGenerate = 0;
            }
        }
        
        const { result: correctAnswerValue, decimals } = calculateRounding(numberToRound, roundingPlaceKey);
        finalDecimalPlaces = decimals;

        return {
            n1: numberToRound,
            n2: roundingPlaceKey,
            result: correctAnswerValue,
            roundingDisplayDecimals: finalDecimalPlaces,
            displayDecimalsForN1: decimalPlacesToGenerate,
            isRounding: true,
            originalRoundingPlace: roundingPlaceKey,
            op: 'R'
        };
    }
    
    function formatNumberDisplay(value, maxDecimals = 0, isRounding = false) {
        if (typeof value === 'string') return value; 
        
        // ุฅุฐุง ูุงู ุงูุชูุฑูุจ ูุนุฏุฏ ุตุญูุญุ ูุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ููุงุฒู ุนุดุฑูุฉ ูู ุงูุนุฑุถ
        if (isRounding && maxDecimals === 0) {
            return Math.round(value).toLocaleString(ARABIC_LOCALE, { useGrouping: false, maximumFractionDigits: 0 });
        }
        
        // ุนุฑุถ ุงูุฃุฑูุงู ุงูุฃุฎุฑู ุจูุง ูู ุฐูู ุงูุฃุฌุฒุงุก ุงูุนุดุฑูุฉ ุจุนุฏ ุงูุชูุฑูุจ
        return value.toLocaleString(ARABIC_LOCALE, {
             useGrouping: false,
             minimumFractionDigits: maxDecimals,
             maximumFractionDigits: maxDecimals 
        });
    }

    
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    
    // ๐ ุฏุงูุฉ ุชูููุฏ ุงูุจุฏุงุฆู ุงููุนุฏูุฉ ูุฌููุน ุงูุนูููุงุช
    function generateDistractors(questionData) {
        const op = questionData.op;
        const correctAnswer = questionData.result;
        const decimalPlaces = questionData.requiredDecimals || questionData.roundingDisplayDecimals || 0; 
        
        let distractors = new Set();
        let correct = parseFloat(correctAnswer.toFixed(decimalPlaces)); 
        let attempts = 0;
        
        const addDistractor = (val) => {
            val = parseFloat(val.toFixed(decimalPlaces));
            if (Math.abs(val - correct) > Math.pow(10, -(decimalPlaces + 1)) && distractors.size < 3) {
                if (correct >= 0 && val < 0) return false; 
                distractors.add(val);
                return true;
            }
            return false;
        };
        
        if (op === '+' || op === '-') {
            // ----------------------------------------------------
            // ๐ฏ ููุทู ุงูุฌูุน ูุงูุทุฑุญ ุงูููุญุณููู (ุฃุฎุทุงุก ุงูุญูู ูุงูุงุณุชูุงู)
            // ----------------------------------------------------
            
            // 1. ุฎุทุฃ ููุฒูุฉ ุงูุขุญุงุฏ (ูุงุฑู 1)
            let smallOffset = decimalPlaces === 0 ? 1 : Math.pow(10, -decimalPlaces);
            if (addDistractor(correct + smallOffset)) {}
            if (addDistractor(correct - smallOffset)) {}
            
            // 2. ุฎุทุฃ ููุฒูุฉ ุงูุนุดุฑุงุช/ุงูุฃุฌุฒุงุก ุงูุนุดุฑูุฉ (ูุงุฑู 10 ุฃู 0.1)
            let mediumOffset = decimalPlaces === 0 ? 10 : Math.pow(10, -(decimalPlaces - 1));
            if (addDistractor(correct + mediumOffset)) {}
            if (addDistractor(correct - mediumOffset)) {}

            // 3. ุฎุทุฃ ููุฒูุฉ ุงููุฆุงุช/ุงูุฃุฌุฒุงุก ุงููุจูุฑุฉ (ูุงุฑู 100 ุฃู 1)
            let largeOffset = decimalPlaces === 0 ? 100 : Math.pow(10, -(decimalPlaces - 2));
             if (largeOffset < correct * 0.5) { 
                 if (distractors.size < 3) addDistractor(correct + largeOffset);
                 if (distractors.size < 3) addDistractor(correct - largeOffset);
             }

            // 4. ููุก ุงููุฑุงุบุงุช ุจุจุฏุงุฆู ุนุดูุงุฆูุฉ ูุฑูุจุฉ (ุฅุฐุง ูู ูููุฃ 3 ุจุนุฏ)
            while (distractors.size < 3 && attempts < 20) {
                 let deviationFactor = (decimalPlaces > 0) ? 0.5 : 10;
                 let deviation = Math.random() * (Math.max(correct / deviationFactor, 10)) + smallOffset; 
                 let sign = Math.random() < 0.5 ? 1 : -1;
                 let potentialAnswer = correct + (sign * deviation);
                 
                 if (potentialAnswer < 0 && correct >= 0) {
                     potentialAnswer = Math.abs(potentialAnswer);
                 }
                 
                 if (addDistractor(potentialAnswer)) {}
                 attempts++;
            }
            while (distractors.size < 3) {
                 let farNumber = generateNumberWithDigits(5, decimalPlaces);
                 addDistractor(farNumber);
            }
        } else if (op === 'R') {
             // ----------------------------------------------------
             // ๐ฏ ููุทู ุงูุชูุฑูุจ ุงูููุญุณููู ูุงูููุทูู
             // ----------------------------------------------------
             const numberToRound = questionData.n1;
             const targetPlace = questionData.originalRoundingPlace;
             
             const placesMapping = {
                 'ุฃูุฑุจ ุนุดุฑุฉ': { value: 10, offset: [1, 100] }, 
                 'ุฃูุฑุจ ูุฆุฉ': { value: 100, offset: [10, 1000] }, 
                 'ุฃูุฑุจ ุฃูู': { value: 1000, offset: [100, 10000] },
                 'ุฃูุฑุจ ุนุดุฑุฉ ุขูุงู': { value: 10000, offset: [1000, 100000] },
                 'ุฃูุฑุจ ูุฆุฉ ุฃูู': { value: 100000, offset: [10000, 1000000] },
                 'ุฃูุฑุจ ููููู': { value: 1000000, offset: [100000, 10000000] },
                 'ุฌุฒุก ูู ุนุดุฑุฉ': { value: 0.1, offset: [0.01, 1] }, 
                 'ุฌุฒุก ูู ูุฆุฉ': { value: 0.01, offset: [0.001, 0.1] },
                 'ุฌุฒุก ูู ุฃูู': { value: 0.001, offset: [0.0001, 0.01] }
             };
             
             const placeInfo = placesMapping[targetPlace];
             const allPlaces = Object.keys(placesMapping);
             const placeValue = placeInfo ? placeInfo.value : 1;

             if (placeInfo) {
                 
                 // 1. ุงูุชูุฑูุจ ุจุงูุงุชุฌุงู ุงููุนุงูุณ (ุฒูุงุฏุฉ/ุฅููุงุต ุฎุงุทุฆุฉ)
                 if (distractors.size < 3) {
                     let wrongRounding;
                     if (correct > numberToRound) {
                         wrongRounding = correct - placeValue; 
                     } else {
                         wrongRounding = correct + placeValue; 
                     }
                     if (wrongRounding > 0) addDistractor(wrongRounding); 
                 }
                 
                 // 2. ุงูุชูุฑูุจ ุงูุฎุงุทุฆ ุฅูู ููุฒูุฉ ุฃุตุบุฑ (ุฎุทุฃ ููุฒูุฉ ุดุงุฆุน)
                 if (distractors.size < 3 && placeInfo.offset[0] !== 0) {
                      const offsetValue = placeInfo.offset[0];
                      // ูุชู ุชุนุฏูู ูุฐู ุงูููุทุฉ ูุชุจุญุซ ุนู ุงุณู ุงูููุฒู ุนุจุฑ ุงููููุฉ ุงูููุงุจูุฉ 
                      const placeName = allPlaces.find(p => {
                          const { result: calcResult } = calculateRounding(1, p);
                          return Math.abs(calcResult - offsetValue) < 0.000001;
                      });
                      if(placeName) {
                           const { result: altAnswer } = calculateRounding(numberToRound, placeName);
                           if (Math.abs(altAnswer - correct) < placeValue * 1.5) { 
                                addDistractor(altAnswer);
                           }
                      }
                 }
                 
                 // 3. ุงูุชูุฑูุจ ุงูุฎุงุทุฆ ุฅูู ููุฒูุฉ ุฃูุจุฑ (ุฃู ุฎุทุฃ ูุณูุงู ุงูุชุตููุฑ)
                 if (distractors.size < 3 && placeValue >= 1 && numberToRound !== correct) {
                     let partToKeep = numberToRound % placeValue; 
                     if (partToKeep > 0) {
                         let mistake = correct + partToKeep;
                         if (Math.abs(mistake - numberToRound) < placeValue * 2) { 
                             addDistractor(Math.round(mistake));
                         }
                     }
                 }
             }
             
             // ููุก ุงูุฎุงูุงุช ุงููุชุจููุฉ ุจุฃุฑูุงู ูุฑูุจุฉ (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
             let fallbackOffset = placeValue / 10;
             if (fallbackOffset < 1) fallbackOffset = 1;
             
             if (distractors.size < 3) addDistractor(correct + fallbackOffset);
             if (distractors.size < 3) addDistractor(correct - fallbackOffset);
             
             // ููุก ุงูุฎุงูุงุช ุงููุชุจููุฉ ุจุฃุฑูุงู ุจุนูุฏุฉ (ุฅุฐุง ูุฒู ุงูุฃูุฑ)
             while (distractors.size < 3) {
                 let farNumber = correct + (Math.random() < 0.5 ? -1 : 1) * Math.max(correct / 5, 20); 
                 if (farNumber < 0) farNumber = correct * 2;
                 addDistractor(farNumber);
             }
             
        } else if (op === '*' || op === '/') {
            // ----------------------------------------------------
            // ๐ฏ ููุทู ุงูุถุฑุจ ูุงููุณูุฉ ุงูููุญุณููู (ุฃุฎุทุงุก ุงูููุฒููุฉ ูุงูุนูุณ)
            // ----------------------------------------------------
            const n1 = questionData.n1;
            const n2 = questionData.n2;
            
            // 1. ุฎุทุฃ ุงูููุฒูุฉ (ุฅุถุงูุฉ/ุญุฐู ุตูุฑ) - ููุทุจู ุนูู ุงูุฃุนุฏุงุฏ ุงูุตุญูุญุฉ ููุท
            if (decimalPlaces === 0 && correct > 10) {
                 if (correct % 10 === 0 && correct / 10 !== 0) addDistractor(correct / 10);
                 addDistractor(correct * 10);
            }
            
            // 2. ุงูุฎุทุฃ ุงูุนูุณู (ุถุฑุจ ุจุฏู ูุณูุฉุ ุฃู ุงูุนูุณ)
            if (op === '/') {
                addDistractor(n1 * n2); // ุฅุฌุงุจุฉ ุงูุถุฑุจ
            } else if (op === '*') {
                addDistractor(Math.round(n1 / n2)); // ุฅุฌุงุจุฉ ุงููุณูุฉ
            }
            
            // 3. ุฎุทุฃ ุงูุฌูุน/ุงูุทุฑุญ ุงููุฑูุจ
            let smallOffset = decimalPlaces === 0 ? 1 : Math.pow(10, -decimalPlaces);
            if (distractors.size < 3) addDistractor(correct + smallOffset * generateNumberWithRange(1, 5));
            if (distractors.size < 3) addDistractor(correct - smallOffset * generateNumberWithRange(1, 5));
            
             // ููุก ุงูุฎุงูุงุช ุงููุชุจููุฉ ุจุฃุฑูุงู ุจุนูุฏุฉ
             while (distractors.size < 3) {
                 let farNumber = correct + (Math.random() < 0.5 ? -1 : 1) * Math.max(correct / 2, 50); 
                 if (farNumber < 0) farNumber = correct + 100;
                 addDistractor(farNumber);
             }

        }
        
        return Array.from(distractors).slice(0, 3).map(d => formatNumberDisplay(d, decimalPlaces));
    }

    // ----------------------------------------------------------------
    // --- ุฏูุงู ุงูุญูุธ ูุงูุชุญููู (ุจุงูู ุงูุฏูุงู ุจุฏูู ุชุบููุฑ) ---
    // ----------------------------------------------------------------

    function saveContestantsData() {
         try {
            localStorage.setItem('mathHeroesNamesData', JSON.stringify(allStudentsByFolder));
        } catch (e) {
            console.error("Could not save names data to localStorage", e);
        }
    }

    function saveGlobalScores() {
        try {
            localStorage.setItem('mathHeroesGlobalScores', JSON.stringify(globalScores));
            localStorage.setItem('mathHeroesFolderNames', JSON.stringify(folderNames));
            localStorage.setItem('mathHeroesParticipationCount', JSON.stringify(playerParticipationCount));
            saveContestantsData(); 
        } catch (e) {
            console.error("Could not save scores/data to localStorage", e);
        }
    }

    function loadContestantsAndScores() {
        try {
            const savedScores = localStorage.getItem('mathHeroesGlobalScores');
            if (savedScores) {
                globalScores = JSON.parse(savedScores);
            } else {
                globalScores = {};
            }

            const savedFolderNames = localStorage.getItem('mathHeroesFolderNames');
            if (savedFolderNames) {
                const loadedNames = JSON.parse(savedFolderNames);
                folderNames = loadedNames;
                document.getElementById('folder-a-name-input').value = folderNames.A;
                document.getElementById('folder-b-name-input').value = folderNames.B;
                document.getElementById('folder-c-name-input').value = folderNames.C;
            }
            
            const savedNamesData = localStorage.getItem('mathHeroesNamesData');
            if (savedNamesData) {
                allStudentsByFolder = JSON.parse(savedNamesData);
            } else {
                allStudentsByFolder = { A: [], B: [], C: [] };
            }
            
            const savedParticipationCount = localStorage.getItem('mathHeroesParticipationCount');
            if (savedParticipationCount) {
                playerParticipationCount = JSON.parse(savedParticipationCount);
            } else {
                playerParticipationCount = {};
            }
            
            renderContestantsList('A');
            renderContestantsList('B');
            renderContestantsList('C');

        } catch (e) {
            console.error("Could not load scores/data from localStorage", e);
            globalScores = {}; 
            allStudentsByFolder = { A: [], B: [], C: [] };
            playerParticipationCount = {};
        }
    }

    // ----------------------------------------------------------------
    // --- ุฏูุงู ุฅุฏุงุฑุฉ ุงููุนุจุฉ (ุจุงูู ุงูุฏูุงู ุจุฏูู ุชุบููุฑ) ---
    // ----------------------------------------------------------------

    function clearTimer() {
        clearInterval(timerInterval);
        document.getElementById('timer-display').style.color = '#333';
    }

    function handleTimeUp() {
        clearTimer();
        isProcessing = true; 
        
        document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
        
        const feedbackElement = document.getElementById('feedback');
        feedbackElement.innerHTML = `<span class="wrong">ุงูุชูู ุงูููุช! (ุตูุฑ ููุฒ ูู ${currentPlayer === 1 ? playerName1 : playerName2}). ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู: ${correctAnswerDisplay}</span>`;
        
        eliminationQuestionsCount += 1; 
        
        currentPlayer = (currentPlayer === 1) ? 2 : 1; 
        
        document.getElementById('score1-display').innerHTML = `${playerName1} (ููุฒ): ${player1Wins.toLocaleString(ARABIC_LOCALE)}`;
        document.getElementById('score2-display').innerHTML = `${playerName2} (ููุฒ): ${player2Wins.toLocaleString(ARABIC_LOCALE)}`;

        if (isTieBreaker && eliminationQuestionsCount >= 2) {
           processEliminationRoundEnd();
           return;
        }
        if (!isTieBreaker && eliminationQuestionsCount >= MAX_ELIMINATION_QUESTIONS) {
           processEliminationRoundEnd();
           return;
        }

        setTimeout(generateQuestion, 2500); 
    }

    function startTimer(duration) {
        clearTimer(); 
        timeRemaining = duration;
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.innerHTML = `${timeRemaining.toLocaleString(ARABIC_LOCALE)} ุซูุงูู`;

        timerInterval = setInterval(() => {
            timeRemaining -= 1;
            timerDisplay.innerHTML = `${timeRemaining.toLocaleString(ARABIC_LOCALE)} ุซูุงูู`;

            if (timeRemaining <= 5) { 
                timerDisplay.style.color = 'red';
            } else {
                timerDisplay.style.color = '#333';
            }

            if (timeRemaining <= 0) {
                handleTimeUp();
            }
        }, 1000); 
    }
    
    // ๐ ุฏุงูุฉ ุฌุฏูุฏุฉ ูุงุฎุชูุงุฑ ูุงุนุจูู ูุน ููุน ุชูุฑุงุฑ ุงููุงุฆุฒูู
    function selectRandomPlayers(folderKey) {
        let students;
        
        if (folderStudentsInPlay.length <= 1) { 
             folderStudentsInPlay = allStudentsByFolder[folderKey]
                .filter(c => c.selected)
                .map(c => c.name);
             
             // ุฅุนุงุฏุฉ ุชููุฆุฉ ุงููุชุงุญูู ููุฌููุฉ ุงููุงุฏูุฉ
             availablePlayersForNextRound = [...folderStudentsInPlay];
        }
        
        students = availablePlayersForNextRound.length > 0 ? availablePlayersForNextRound : folderStudentsInPlay;

        if (students.length < 2) {
            // ุฅุฐุง ูู ููู ููุงู ูุชุณุงุจููู ูุงููููุ ูุนูุฏ ุชุนููู ุงููุชุงุญูู ุจุฌููุน ุงููุชุณุงุจููู
            availablePlayersForNextRound = [...folderStudentsInPlay];
            students = availablePlayersForNextRound;
            
            if (students.length < 2) return null;
        }

        const availableStudents = [...students];
        
        // ุฅุฒุงูุฉ ุงููุงุฆุฒูู ุงูุฃุฎูุฑูู ูู ุงููุงุฆูุฉ ุงููุชุงุญุฉ
        const filteredStudents = availableStudents.filter(student => 
            !recentWinners.includes(student)
        );
        
        const finalCandidates = filteredStudents.length >= 2 ? filteredStudents : availableStudents;
        
        if (finalCandidates.length < 2) {
            // ุฅุฐุง ูุงู ูุง ูุฒุงู ุบูุฑ ูุงูุ ูุณุชุฎุฏู ุฌููุน ุงููุชุณุงุจููู
            const allAvailable = [...folderStudentsInPlay];
            if (allAvailable.length < 2) return null;
            
            const index1 = Math.floor(Math.random() * allAvailable.length);
            const player1 = allAvailable[index1];
            
            const remainingPlayers = allAvailable.filter((_, idx) => idx !== index1);
            const index2 = Math.floor(Math.random() * remainingPlayers.length);
            const player2 = remainingPlayers[index2];
            
            return [player1, player2];
        }
        
        const index1 = Math.floor(Math.random() * finalCandidates.length);
        const player1 = finalCandidates[index1];
        
        const remainingPlayers = finalCandidates.filter((_, idx) => idx !== index1);
        const index2 = Math.floor(Math.random() * remainingPlayers.length);
        const player2 = remainingPlayers[index2];
        
        // ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุดุงุฑูุฉ
        if (!playerParticipationCount[player1]) playerParticipationCount[player1] = 0;
        if (!playerParticipationCount[player2]) playerParticipationCount[player2] = 0;
        
        playerParticipationCount[player1] += 1;
        playerParticipationCount[player2] += 1;
        
        // ุฅุฒุงูุฉ ุงููุงุนุจูู ุงููุฎุชุงุฑูู ูู ุงููุงุฆูุฉ ุงููุชุงุญุฉ ููุฌููุฉ ุงููุงุฏูุฉ
        availablePlayersForNextRound = availablePlayersForNextRound.filter(
            player => player !== player1 && player !== player2
        );
        
        return [player1, player2];
    }
    
    function finishEliminationRound(winnerName, loserName) {
        document.getElementById('feedback').innerHTML = `<span class="correct">ุงูุชูุช ุงูุฌููุฉ: ${winnerName} ูููุฒ!</span> - <span class="wrong">${loserName} ูุฎุฑุฌ ูู ุงูููุงูุณุฉ.</span>`;
        
        // ุชุฃููุฏ ุฅุฒุงูุฉ ุงูุฎุงุณุฑ ูู ุงููุงุฆูุฉ
        folderStudentsInPlay = folderStudentsInPlay.filter(name => {
            const normalizedName = name.trim().toLowerCase();
            const normalizedLoser = loserName.trim().toLowerCase();
            return normalizedName !== normalizedLoser;
        });
        
        // ุชุญุฏูุซ ุงููุงุฆูุฉ ุงููุชุงุญุฉ ููุฌููุฉ ุงููุงุฏูุฉ
        availablePlayersForNextRound = availablePlayersForNextRound.filter(
            player => player !== loserName
        );
        
        // ุฅุถุงูุฉ ุงููุงุฆุฒ ุฅูู ูุงุฆูุฉ ุงููุงุฆุฒูู ุงูุฃุฎูุฑูู ูููุน ุชูุฑุงุฑู
        if (!recentWinners.includes(winnerName)) {
            recentWinners.unshift(winnerName);
            
            // ุงูุญูุงุธ ุนูู ุนุฏุฏ ูุญุฏูุฏ ูู ุงููุงุฆุฒูู ุงูุฃุฎูุฑูู
            if (recentWinners.length > MAX_RECENT_WINNERS) {
                recentWinners.pop();
            }
        }
        
        console.log('ุงููุงุฆุฒูู ุงูุฃุฎูุฑูู (ููููุน ูู ุงูุชูุฑุงุฑ):', recentWinners);
        console.log('ุงููุชุงุญูู ููุฌููุฉ ุงููุงุฏูุฉ:', availablePlayersForNextRound);
        
        eliminationQuestionsCount = 0;
        player1Wins = 0;
        player2Wins = 0;
        isTieBreaker = false;
        fixedOperation = ''; 
        tournamentSchedule = []; 
        currentTournamentRound = 0;
        
        if (folderStudentsInPlay.length === 1) {
             const champion = folderStudentsInPlay[0];
             document.getElementById('feedback').innerHTML = `<h1>๐ ุงูุจุทู ูู: ${champion}! ๐</h1>`;
             globalScores[champion] = (globalScores[champion] || 0) + 1; 
             saveGlobalScores();
             document.getElementById('next-round-btn').textContent = 'ุจุฏุก ุจุทููุฉ ุฌุฏูุฏุฉ';
             document.getElementById('next-round-btn').style.display = 'block';
             document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
             
             // ุฅุนุงุฏุฉ ุชุนููู ุงููุงุฆุฒูู ุงูุฃุฎูุฑูู ุนูุฏ ูุฌูุฏ ุจุทู
             recentWinners = [];
        } else {
             document.getElementById('next-round-btn').style.display = 'block';
             document.getElementById('next-round-btn').textContent = 'ุฌููุฉ ุฅูุตุงุก ุฌุฏูุฏุฉ';
        }
        
        // ุญูุธ ุฅุญุตุงุฆูุงุช ุงููุดุงุฑูุฉ
        saveGlobalScores();
        
        updateRemainingContestantsDisplay();
        updateParticipationStatsDisplay();
    }
    
    function setupTournamentSchedule() {
        tournamentSchedule = [];
        let availableOps = shuffleArray([...ALL_OPERATIONS]);

        let modeMaxLevel = MAX_LEVEL; 
        const mode = document.getElementById('mode-select').value;
        
        if (mode === 'elimination4') { 
             modeMaxLevel = 3;
        } else if (mode === 'elimination5') { 
             modeMaxLevel = 4;
        }
        
        for (let i = 1; i <= modeMaxLevel; i++) {
            const op = availableOps.pop() || shuffleArray([...ALL_OPERATIONS]).pop(); 
            tournamentSchedule.push({ level: i, operation: op });
        }

        const remainingOps = availableOps; 
        remainingOps.forEach(op => {
             tournamentSchedule.push({ level: modeMaxLevel, operation: op });
        });
        
        let cycleOps = shuffleArray([...ALL_OPERATIONS]);
        while (tournamentSchedule.length < 10) { 
            const op = cycleOps.pop();
            tournamentSchedule.push({ level: modeMaxLevel, operation: op });
            if (cycleOps.length === 0) {
                 cycleOps = shuffleArray([...ALL_OPERATIONS]); 
            }
        }
        
        currentTournamentRound = 0; 
    }
    
    function processEliminationRoundEnd() {
        
        if (player1Wins === player2Wins) {
            
            if (currentMode === 'elimination2' || currentMode === 'elimination3' || currentMode === 'elimination4' || currentMode === 'elimination5') {
                 currentTournamentRound += 1;
                 
                 let newLevel, opName;
                 
                 if (currentMode === 'elimination2') {
                     newLevel = Math.min(currentTournamentRound + 1, MAX_LEVEL);
                     opName = fixedOperation === 'R' ? 'ุชูุฑูุจ' : fixedOperation;
                 } else { 
                      const nextRound = tournamentSchedule[Math.min(currentTournamentRound, tournamentSchedule.length - 1)];
                      newLevel = nextRound.level;
                      opName = nextRound.operation === 'R' ? 'ุชูุฑูุจ' : nextRound.operation;
                 }
                 
                 const statusMsg = `<span class="wrong">ุชุนุงุฏู! ุชุฑููุฉ ุฅูู ุงููุณุชูู ${newLevel.toLocaleString(ARABIC_LOCALE)} ูุงูุนูููุฉ: ${opName}</span>`;
                 document.getElementById('feedback').innerHTML = statusMsg;
            } else { 
                document.getElementById('feedback').innerHTML = `<span class="wrong">ุชุนุงุฏู! ุณุคุงู ูุงุตู ุฅุถุงูู (ููู ูุชุณุงุจู)...</span>`;
            }
            
            isTieBreaker = true; 
            
            eliminationQuestionsCount = 0; 
            currentPlayer = 1; 
            
            setTimeout(generateQuestion, 2500);
            return; 
        }
        
        if (player1Wins !== player2Wins) {
            const winner = player1Wins > player2Wins ? playerName1 : playerName2;
            const loser = player1Wins > player2Wins ? playerName2 : playerName1;
            finishEliminationRound(winner, loser);
            return;
        }
    }

    function startNewRound() {
        if (!gameStarted) {
             alert('ูุฑุฌู ุจุฏุก ุงููุณุงุจูุฉ ุฃููุงู ูุชุญููู ุงูุฃุณูุงุก.');
             return;
        }
        
        currentFolderKey = document.getElementById('folder-select').value;
        currentMode = document.getElementById('mode-select').value;
        const selectedFolderName = folderNames[currentFolderKey];
        
        if (folderStudentsInPlay.length <= 1) { 
             folderStudentsInPlay = allStudentsByFolder[currentFolderKey]
                .filter(c => c.selected)
                .map(c => c.name);

             if (folderStudentsInPlay.length < 2) {
                 alert(`ูุฌุจ ุฃู ูููู ูุฏูู ูุชุณุงุจูุงู ุนูู ุงูุฃูู ุชู ุงุฎุชูุงุฑููุง ูู ${selectedFolderName} ูุจุฏุก ุจุทููุฉ ุงูุฅูุตุงุก.`);
                 document.getElementById('next-round-btn').textContent = 'ุฌููุฉ ุฌุฏูุฏุฉ';
                 document.getElementById('next-round-btn').style.display = 'block';
                 updateRemainingContestantsDisplay(); 
                 return;
             }
             
             // ุฅุนุงุฏุฉ ุชููุฆุฉ ุงููุชุงุญูู ููุฌููุฉ ุงููุงุฏูุฉ
             availablePlayersForNextRound = [...folderStudentsInPlay];
        }

        const selectedPlayers = selectRandomPlayers(currentFolderKey);
        
        if (!selectedPlayers) {
            const count = allStudentsByFolder[currentFolderKey].filter(c => c.selected).length;
            document.getElementById('q-num1').textContent = `ุชุฃูุฏ ูู ูุฌูุฏ ุงุณููู ุนูู ุงูุฃูู ุชู ุงุฎุชูุงุฑููุง ูู ${selectedFolderName}. (${count.toLocaleString(ARABIC_LOCALE)} ูุชุณุงุจููู ุญุงูููุง)`;
            document.getElementById('q-num2').textContent = '';
            document.getElementById('q-op2').textContent = '';
            document.getElementById('next-round-btn').style.display = 'block'; 
            document.getElementById('next-round-btn').textContent = 'ุฌููุฉ ุฌุฏูุฏุฉ';
            updateRemainingContestantsDisplay();
            return;
        }

        playerName1 = selectedPlayers[0];
        playerName2 = selectedPlayers[1];
        
        player1Wins = 0;
        player2Wins = 0;
        eliminationQuestionsCount = 0;
        isTieBreaker = false;
        currentTournamentRound = 0; 
        
        let modeDisplay = document.getElementById('mode-select').options[document.getElementById('mode-select').selectedIndex].text;
        
        if (currentMode === 'elimination2') {
             fixedOperation = document.getElementById('operation-select').value;
             document.getElementById('feedback').innerHTML = `ุงูุขู ูุชูุงูุณ: ${playerName1} vs ${playerName2} ูู ${selectedFolderName} (${modeDisplay} - ุงูุนูููุฉ ุงูุซุงุจุชุฉ: ${fixedOperation === 'R' ? 'ุชูุฑูุจ' : fixedOperation})`;
        } else if (currentMode === 'elimination3' || currentMode === 'elimination4' || currentMode === 'elimination5') {
             setupTournamentSchedule(); 
             document.getElementById('feedback').innerHTML = `ุงูุขู ูุชูุงูุณ: ${playerName1} vs ${playerName2} ูู ${selectedFolderName} (${modeDisplay})`;
        } else { // elimination1
             document.getElementById('feedback').innerHTML = `ุงูุขู ูุชูุงูุณ: ${playerName1} vs ${playerName2} ูู ${selectedFolderName} (${modeDisplay})`;
        }

        document.getElementById('score1-display').innerHTML = `${playerName1} (ููุฒ): ${player1Wins.toLocaleString(ARABIC_LOCALE)}`;
        document.getElementById('score2-display').innerHTML = `${playerName2} (ููุฒ): ${player2Wins.toLocaleString(ARABIC_LOCALE)}`;

        document.getElementById('next-round-btn').style.display = 'none'; 
        
        currentPlayer = 1;
        document.getElementById('answer-options-container').innerHTML = ''; 
        
        updateRemainingContestantsDisplay(); 
        updateParticipationStatsDisplay();

        setTimeout(generateQuestion, 2000); 
    }

    function startGame() {
        
        folderNames.A = document.getElementById('folder-a-name-input').value.trim() || "ุงููุฌููุนุฉ ุฃ";
        folderNames.B = document.getElementById('folder-b-name-input').value.trim() || "ุงููุฌููุนุฉ ุจ";
        folderNames.C = document.getElementById('folder-c-name-input').value.trim() || "ุงููุฌููุนุฉ ุฌ";
        
        saveGlobalScores(); 

        currentFolderKey = document.getElementById('folder-select').value;
        
        const selectedContestants = allStudentsByFolder[currentFolderKey]
            .filter(c => c.selected)
            .map(c => c.name); 

        if (selectedContestants.length < 2) {
             alert(`ูุฌุจ ุฃู ูููู ูุฏูู ูุชุณุงุจูุงู ุนูู ุงูุฃูู ุชู ุงุฎุชูุงุฑููุง (ูุถุน ุนูุงูุฉ ุตุญ) ูู ${folderNames[currentFolderKey]} ูุจุฏุก ุงููุณุงุจูุฉ.`);
             return;
        }

        gameStarted = true;
        document.getElementById('start-btn').textContent = 'ุฅุนุงุฏุฉ ุชุญููู ุงูุฃุณูุงุก ูุงูุจุฏุก';
        document.getElementById('next-round-btn').style.display = 'block'; 
        document.getElementById('next-round-btn').textContent = 'ุฌููุฉ ุฅูุตุงุก ุฌุฏูุฏุฉ';
        document.getElementById('names-section').style.opacity = 0.5; 
        
        folderStudentsInPlay = selectedContestants;
        
        // ุฅุนุงุฏุฉ ุชููุฆุฉ ุงููุชุบูุฑุงุช ุงูุฎุงุตุฉ ุจููุน ุงูุชูุฑุงุฑ
        recentWinners = [];
        availablePlayersForNextRound = [...folderStudentsInPlay];
        
        document.getElementById('feedback').innerHTML = `ุชู ุชุญููู ุงูุฃุณูุงุก (**${selectedContestants.length.toLocaleString(ARABIC_LOCALE)}** ูุชุณุงุจููู ุชู ุงุฎุชูุงุฑูู). ุงุถุบุท "ุฌููุฉ ุฅูุตุงุก ุฌุฏูุฏุฉ" ููุจุฏุก ุจูู ูุชุณุงุจููู ุนุดูุงุฆููู ูู ${folderNames[currentFolderKey]}.`;
        document.getElementById('q-num1').textContent = 'ุฌุงูุฒูู ููุงูุทูุงู!';
        document.getElementById('q-num2').textContent = '';
        document.getElementById('q-op2').textContent = '';
        document.getElementById('answer-options-container').innerHTML = ''; 
        
        updateRemainingContestantsDisplay();
        updateParticipationStatsDisplay();
    }
    
    function generateQuestion() {
        if (!gameStarted) return;
        
        clearTimer();
        isProcessing = false;
        document.getElementById('feedback').innerHTML = '';
        document.getElementById('answer-options-container').innerHTML = ''; 
        
        let op, level;
        
        if (currentMode === 'elimination3' || currentMode === 'elimination4' || currentMode === 'elimination5') {
             const roundInfo = tournamentSchedule[Math.min(currentTournamentRound, tournamentSchedule.length - 1)];
             op = roundInfo.operation;
             level = roundInfo.level;
             
             const opName = op === 'R' ? 'ุชูุฑูุจ' : op;
             const currentPlayerName = currentPlayer === 1 ? playerName1 : playerName2;
             document.getElementById('feedback').innerHTML = `ุงูุฏูุฑ ูู **${currentPlayerName}** - ๐ฏ ุงููุฏู: ุงููุณุชูู ${level.toLocaleString(ARABIC_LOCALE)} (${opName})`;
             
        } else if (currentMode === 'elimination2') {
             op = fixedOperation;
             level = Math.min(currentTournamentRound + 1, MAX_LEVEL); 
             const opName = op === 'R' ? 'ุชูุฑูุจ' : op;
             const currentPlayerName = currentPlayer === 1 ? playerName1 : playerName2;
             document.getElementById('feedback').innerHTML = `ุงูุฏูุฑ ูู **${currentPlayerName}** - ๐ฏ ุงููุฏู: ุงููุณุชูู ${level.toLocaleString(ARABIC_LOCALE)} (${opName})`;
             
        } else { 
             op = document.getElementById('operation-select').value;
             level = document.getElementById('level-select').value;
        }

        let questionData;
        let decimalsToDisplay = 0; 
        let n1DisplayDecimals = 0; 
        let isRoundingQuestion = false;

        if (op === 'R') {
             questionData = generateRoundingQuestion(level);
             decimalsToDisplay = questionData.roundingDisplayDecimals;
             currentRoundingDecimals = decimalsToDisplay; 
             n1DisplayDecimals = questionData.displayDecimalsForN1; 
             currentRoundingPlace = questionData.originalRoundingPlace;
             isRoundingQuestion = true;
        } else {
             questionData = generateOperationQuestion(level, op);
             decimalsToDisplay = questionData.requiredDecimals; 
             currentRoundingDecimals = decimalsToDisplay; 
             n1DisplayDecimals = decimalsToDisplay; 
        }
        
        num1 = questionData.n1;
        num2 = questionData.n2;
        correctAnswerValue = questionData.result;
        
        const formattedNum1 = formatNumberDisplay(num1, (op === 'R') ? n1DisplayDecimals : decimalsToDisplay, op === 'R'); 
        let formattedNum2 = '';
        let operatorDisplay = op;

        if (op === 'R') {
            operatorDisplay = 'ูุฑุจ ุฅูู:';
            formattedNum2 = num2; 
        } else {
            formattedNum2 = formatNumberDisplay(num2, (op === '+' || op === '-') ? decimalsToDisplay : 0, false);
            operatorDisplay = op === '*' ? 'ร' : op === '/' ? 'รท' : op;
        }

        document.getElementById('q-num1').textContent = formattedNum1;
        document.getElementById('q-op2').textContent = operatorDisplay;
        document.getElementById('q-num2').textContent = formattedNum2;

        correctAnswerDisplay = formatNumberDisplay(correctAnswerValue, decimalsToDisplay, op === 'R' && (decimalsToDisplay === 0));
        
        const distractors = generateDistractors({
            isRounding: isRoundingQuestion,
            result: correctAnswerValue,
            requiredDecimals: decimalsToDisplay,
            n1: num1,
            n2: num2, 
            op: op, 
            originalRoundingPlace: currentRoundingPlace
        }); 
        
        let options = shuffleArray([...distractors, correctAnswerDisplay]);

        const optionsContainer = document.getElementById('answer-options-container');
        optionsContainer.innerHTML = '';
        options.forEach(option => {
            const button = document.createElement('button');
            button.className = 'answer-btn';
            button.textContent = option;
            button.onclick = () => checkAnswer(button, option);
            optionsContainer.appendChild(button);
        });
        
        const currentName = currentPlayer === 1 ? playerName1 : playerName2;
        document.getElementById('current-player').textContent = currentName;
        
        let time = TIME_LIMIT; 

        document.getElementById('timer-display').style.color = '#333';
        startTimer(time);
    }
    
    function checkAnswer(selectedButton, selectedAnswer) {
        if (isProcessing) return;
        isProcessing = true;
        clearTimer(); 
        
        const isCorrect = selectedAnswer === correctAnswerDisplay;
        const feedbackElement = document.getElementById('feedback');
        
        document.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
        
        if (isCorrect) {
            selectedButton.classList.add('correct-answer');
            feedbackElement.innerHTML = `<span class="correct">ุฅุฌุงุจุฉ ุตุญูุญุฉ! (+1 ููุฒ ูู ${currentPlayer === 1 ? playerName1 : playerName2})</span>`;
            
            if (currentPlayer === 1) {
                player1Wins += 1;
            } else {
                player2Wins += 1;
            }
            
        } else {
            selectedButton.classList.add('wrong-answer');
            document.querySelectorAll('.answer-btn').forEach(btn => {
                if (btn.textContent === correctAnswerDisplay) {
                    btn.classList.add('correct-answer');
                }
            });
            feedbackElement.innerHTML = `<span class="wrong">ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ! ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู: ${correctAnswerDisplay}</span>`;
        }

        eliminationQuestionsCount += 1; 
        
        document.getElementById('score1-display').innerHTML = `${playerName1} (ููุฒ): ${player1Wins.toLocaleString(ARABIC_LOCALE)}`;
        document.getElementById('score2-display').innerHTML = `${playerName2} (ููุฒ): ${player2Wins.toLocaleString(ARABIC_LOCALE)}`;
        
        if (isTieBreaker && eliminationQuestionsCount >= 2) {
           processEliminationRoundEnd();
           return;
        }
        if (!isTieBreaker && eliminationQuestionsCount >= MAX_ELIMINATION_QUESTIONS) {
           processEliminationRoundEnd();
           return;
        }

        currentPlayer = (currentPlayer === 1) ? 2 : 1;
        setTimeout(generateQuestion, 2500); 
    }
    
    // ----------------------------------------------------------------
    // --- ุงูุชุญููู ุนูุฏ ุจุฏุก ุงูุชุดุบูู ---
    // ----------------------------------------------------------------
    window.onload = () => {
        loadContestantsAndScores();
        toggleOpLevelControls(); 
        
        // ๐ ุชุญุฏูุซ ุงูุนุฏุฏ ุงููุชุจูู ุนูุฏ ุงูุชุญููู
        updateRemainingCountDisplay();
    };
    
</script>
</body>
</html>
