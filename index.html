<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (ÙØ±Ø¯ÙŠ)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <style>
        /* CSS Ù…ÙØ®ÙÙ ÙˆÙ…ÙÙ†Ø¸Ù… (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚) */
        body { font-family: 'Arial', sans-serif; text-align: center; margin-top: 20px; background-color: #f4f4f9; }
        .initiative-header {
            margin: 15px auto 30px auto; padding: 15px 20px; background-color: #f7f9fc; 
            border: 1px solid #ddd; border-left: 8px solid #007BFF; border-radius: 6px;
            max-width: 95%; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); 
        }
        .initiative-header .title-line { font-size: 1.4em; font-weight: bold; color: #007BFF; margin: 0; }
        .main-content { display: flex; justify-content: center; max-width: 100%; margin: auto; }
        .container { 
            width: 98%; padding: 20px; border: 5px solid #28a745; border-radius: 15px; 
            background-color: #fff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); margin: 0 5px;
        }
       
        h1 { color: #28a745; margin-bottom: 20px; font-size: 1.6em; }
        
        .names-input-section { 
            margin-bottom: 20px; padding: 15px; border: 1px dashed #ccc; border-radius: 8px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px;
        }
        #student-name-input, #opponent-name-input { 
            padding: 10px; font-size: 1.1em; border: 2px solid #28a745; border-radius: 6px; 
            width: 90%; max-width: 350px; text-align: right; 
        }
        .names-input-section label { margin-right: 0; font-weight: bold; }
        
        .round-setup { margin-bottom: 20px; padding: 15px; background-color: #e9ecef; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; }
        .round-setup label { font-weight: bold; font-size: 1em; }
        .round-setup select { padding: 8px; font-size: 1em; border-radius: 5px; border: 1px solid #FFC107; }

        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 3px solid #eee; padding-bottom: 10px; }
        #timer-display { 
             font-size: 2.5em; font-weight: bold; color: #333; padding: 5px 15px; border: 3px dashed #FFC107; border-radius: 10px; min-width: 100px; 
             direction: ltr; 
        }

        #question { font-size: 2.0em; margin: 20px auto; color: #333; min-height: 120px; width: 95%; text-align: center; font-weight: bold; direction: rtl; }
        #expression-display { font-size: 1em; padding: 10px; display: block; text-align: center; direction: rtl; } 
        
        #answer-choices { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px; }
        .choice-btn {
            padding: 10px; font-size: 1.5em; width: 45%; border: 3px solid #007BFF;
            border-radius: 10px; background-color: #e9f4ff; color: #007BFF;
            cursor: pointer; transition: background-color 0.3s, transform 0.1s; font-weight: bold;
            display: flex; justify-content: center; align-items: center; min-height: 80px;
            box-sizing: border-box; 
        }
        .choice-btn:hover { background-color: #cce0ff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3); }
        .choice-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: #eee; }
        
        .correct { color: #28a745; font-weight: bold; font-size: 1.5em; }
        .wrong { color: #dc3545; font-weight: bold; font-size: 1.5em; }

        #activate-training-btn { padding: 12px 25px; font-size: 1.3em; color: white; border: none; cursor: pointer; border-radius: 8px; transition: background-color 0.3s; background-color: #007BFF; margin-top: 10px;} 
        
        #level-navigation { 
            display: none; 
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px dashed #ccc;
        }
        .nav-btn {
            padding: 10px 20px; 
            font-size: 1.3em; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 8px; 
            transition: background-color 0.3s;
        }
        #next-level-btn { background-color: #28a745; } 
        #repeat-level-btn { background-color: #FFC107; color: #333; } 

        .fraction-display {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.1em;
            margin: 0 3px;
            padding: 0 1px;
            vertical-align: middle;
            direction: ltr; 
        }
        .numerator {
            border-bottom: 2px solid #333;
            line-height: 1.1;
            padding: 0 3px;
        }
        .denominator {
            line-height: 1.1;
            padding: 0 3px;
        }
        .mixed-number {
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 3px;
             direction: ltr;
        }
        
    </style>
</head>
<body>

<div class="initiative-header">
    <p class="title-line">Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (ÙØ±Ø¯ÙŠ)</p>
</div>
<div class="main-content">
    <div class="container" id="game-container">
        <h1>Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
        
        <div class="names-input-section" id="names-input-section">
             <label for="student-name-input">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</label>
             <input type="text" id="student-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨">
             
             <label for="opponent-name-input" style="display: none;">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ 2 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
             <input type="text" id="opponent-name-input" style="display: none;" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ">
        </div>

        <div class="round-setup" id="training-setup">
            
            <label for="initial-level-select">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„ÙŠ:</label>
            <select id="initial-level-select">
                <option value="1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</option>
                <option value="2">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2</option>
                <option value="3">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3</option>
            </select>
            
            <label for="operation-select">Ø§Ù„Ù‚Ø³Ù…:</label>
            <select id="operation-select"> 
                <option value="STATS" selected>Ø§Ù„Ø¥Ø­ØµØ§Ø¡ (Ù….Ø­ØŒ Ù…Ù†ÙˆØ§Ù„ØŒ Ù…Ø¯Ù‰ØŒ ÙˆØ³ÙŠØ·)</option>
                <option value="FRACTIONS">Ø§Ù„ÙƒØ³ÙˆØ± ÙˆØ§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</option>
                <option value="METRIC">Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªØ±ÙŠØ© (Ø·ÙˆÙ„ØŒ Ø³Ø¹Ø©ØŒ ÙƒØªÙ„Ø©)</option>
            </select>

            <label for="time-limit-select">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©:</label>
            <select id="time-limit-select">
                <option value="30">30 Ø«Ø§Ù†ÙŠØ©</option>
                <option value="60">Ø¯Ù‚ÙŠÙ‚Ø©</option>
                <option value="90">Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ†ØµÙ</option>
                <option value="120">Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†</option>
            </select>
            
            <button id="activate-training-btn">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</button> 
            
            <div id="level-navigation">
                <button id="next-level-btn" class="nav-btn" onclick="startNewLevel(true)">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button id="repeat-level-btn" class="nav-btn" onclick="startNewLevel(false)">Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
            </div>
        </div>

        <div class="header-section">
            <div id="turn-indicator">
                Ø§Ù„Ù…ØªØ¯Ø±Ø¨: <span id="current-player" class="player-turn">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</span>
            </div>
            <div id="timer-display">30 Ø«ÙˆØ§Ù†Ù</div> 
        </div>

        <div id="question">
             <div id="expression-display">Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
        </div> 
        
        <div id="answer-choices">
            </div>

        <div id="feedback"></div>

        <div class="score-boards">
            <div id="progress-display"></div>
        </div>
    </div>

</div>

<div class="footer">
    Ø¥Ø¹Ø¯Ø§Ø¯: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø­Ø¬ÙŠÙ„ÙŠ
</div>

<script>
    let correctAnswer = null; 
    let isProcessingClick = false; 
    let gameStarted = false; 

    let currentStudent = ""; 
    
    // ğŸ”¥ ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© (Ù„Ø£Ù†Ù†Ø§ Ù„Ø§ Ù†Ø³ØªØ·ÙŠØ¹ Ø­ÙØ¸Ù‡Ø§ ÙÙŠ iOS)
    let globalScores = {}; 

    let TIME_LIMIT = 30; 
    let timeRemaining = TIME_LIMIT;
    let timerInterval = null; 
    let timerStartTime = null; 
    
    const TRAINING_MASTER_THRESHOLD = 8; 
    const QUESTIONS_PER_LEVEL = 10; 
    
    // Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ±ÙŠØ© 
    const METRIC_UNITS = {
        'LENGTH': { 'ÙƒÙ…': 1000000, 'Ù…': 1000, 'Ø³Ù…': 10, 'Ù…Ù„Ù…': 1, 'ÙƒÙ…_name': 'ÙƒÙŠÙ„ÙˆÙ…ØªØ±', 'Ù…_name': 'Ù…ØªØ±', 'Ø³Ù…_name': 'Ø³Ù†ØªÙŠÙ…ØªØ±', 'Ù…Ù„Ù…_name': 'Ù…Ù„Ù„ÙŠÙ…ØªØ±' },
        'VOLUME': { 'ÙƒØ¬Ù…': 1000, 'Ø¬Ù…': 1, 'Ù…Ù„Ø¬Ù…': 0.001, 'ÙƒØ¬Ù…_name': 'ÙƒÙŠÙ„ÙˆØ¬Ø±Ø§Ù…', 'Ø¬Ù…_name': 'Ø¬Ø±Ø§Ù…', 'Ù…Ù„Ø¬Ù…_name': 'Ù…Ù„Ù„ÙŠØ¬Ø±Ø§Ù…' },
        'CAPACITY': { 'ÙƒÙ„': 1000, 'Ù„ØªØ±': 1, 'Ù…Ù„': 0.001, 'ÙƒÙ„_name': 'ÙƒÙŠÙ„ÙˆÙ„ØªØ±', 'Ù„ØªØ±_name': 'Ù„ØªØ±', 'Ù…Ù„_name': 'Ù…Ù„Ù„ÙŠÙ„ØªØ±' }
    };
    
    // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©
    const SECTION_OPERATIONS = {
        'STATS': ['MEAN', 'MODE', 'RANGE', 'MEDIAN'],
        'FRACTIONS': ['SIMPLIFY', 'DEC_TO_FRAC', 'FRAC_TO_DEC', 'DEC_TO_PER', 'PER_TO_DEC', 'MIXED_TO_IMPROP', 'IMPROP_TO_MIXED'], 
        'METRIC': ['LENGTH', 'VOLUME', 'CAPACITY']
    };
    
    let currentLevel = 1; 
    let levelCorrectAnswers = 0;
    let levelQuestionsAnswered = 0;
    
    let currentQuestionQueue = []; 
    let questionData = {}; 

    const encouragingPhrases = [
        "Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù…ØªØ§Ø²Ø©! Ø£Ù†Øª Ø¹Ø¨Ù‚Ø±ÙŠ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨! ğŸš€", "Ù…Ø°Ù‡Ù„! Ù‡Ø°Ù‡ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„ØµÙ…ÙŠÙ…! âœ¨",
        "Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙ…ÙŠØ². ğŸ’ª", "Ø¥ØªÙ‚Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ! Ø£Ù†Øª Ø³Ø±ÙŠØ¹ ÙˆØ°ÙƒÙŠ. ğŸ§ ",
        "ÙŠØ§ Ù„Ù‡ Ù…Ù† ØªØ±ÙƒÙŠØ²! Ø¥Ø¬Ø§Ø¨ØªÙƒ ØµØ­ÙŠØ­Ø© 100%. âœ…", "Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹! Ø®Ø·ÙˆØ§ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ø¥ØªÙ‚Ø§Ù† Ø«Ø§Ø¨ØªØ©. ğŸŒŸ",
        "Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©ØŒ ØªÙ‚Ø¯Ù… Ù…Ù…ØªØ§Ø²! ğŸ‘", "Ø£Ø¯Ø§Ø¡ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¥Ø´Ø§Ø¯Ø©! Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù‚Ù…Ø©. ğŸ†"
    ];

    function getRandomInt(min, max, exclude = []) {
        min = Math.ceil(min);
        max = Math.floor(max);
        let num;
        do {
            num = Math.floor(Math.random() * (max - min + 1)) + min;
        } while (exclude.includes(num));
        return num;
    }

    function getRandomElement(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    // =======================================================
    // ğŸ¨ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
    // =======================================================
    
    function formatArabicNumerals(num) {
        if (typeof num !== 'number' || isNaN(num)) return num;
        
        const arabicFormatted = new Intl.NumberFormat('ar', { 
            useGrouping: false,
            minimumFractionDigits: 0,
            maximumFractionDigits: 4,
            numberingSystem: 'arab' 
        }).format(num);

        if (num > 9999 || num < -9999) {
             return new Intl.NumberFormat('ar', { 
                 useGrouping: true,
                 minimumFractionDigits: 0,
                 maximumFractionDigits: 0,
                 numberingSystem: 'arab' 
             }).format(num);
        }

        return arabicFormatted;
    }
    
    function formatResult(res) {
         if (typeof res === 'number') {
            if (res === Math.floor(res)) {
                 return formatArabicNumerals(res);
            }
            return formatArabicNumerals(parseFloat(res.toFixed(3)));
        }
        
        let strRes = res.toString();
        
        if (strRes.endsWith('%')) {
            const numPart = strRes.substring(0, strRes.length - 1);
            if (!isNaN(parseFloat(numPart))) {
                const numVal = parseFloat(numPart).toFixed(1).replace(/\.?0+$/, ''); 
                return `${formatArabicNumerals(parseFloat(numVal))}%`;
            }
        }
        
        const arabicMap = { '0': 'Ù ', '1': 'Ù¡', '2': 'Ù¢', '3': 'Ù£', '4': 'Ù¤', '5': 'Ù¥', '6': 'Ù¦', '7': 'Ù§', '8': 'Ù¨', '9': 'Ù©' };
        
        if (!isNaN(parseFloat(strRes)) && parseFloat(strRes) === Math.floor(parseFloat(strRes)) && parseFloat(strRes) >= 10000) {
             return formatArabicNumerals(parseFloat(strRes));
        }

        return strRes.replace(/[0-9]/g, match => arabicMap[match] || match); 
    }
    
    function formatFractionForDisplay(fractionStr) {
         if (typeof fractionStr !== 'string') return formatResult(fractionStr);
        
        fractionStr = fractionStr.replace(/\s+/g, ' ').trim();

        if (fractionStr.endsWith('%')) {
            const numPart = fractionStr.substring(0, fractionStr.length - 1);
            if (!isNaN(parseFloat(numPart))) {
                 return `${formatArabicNumerals(parseFloat(numPart))}%`;
            }
            return fractionStr;
        }

        const parts = fractionStr.split(' ');
        
        if (parts.length === 2) {
            const whole = formatArabicNumerals(parseFloat(parts[0]));
            const fracParts = parts[1].split('/');
            if (fracParts.length === 2) {
                const numerator = formatArabicNumerals(parseFloat(fracParts[0]));
                const denominator = formatArabicNumerals(parseFloat(fracParts[1]));
                return `<div class="mixed-number"><span>${whole}</span><div class="fraction-display"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></div></div>`;
            }
        } else if (parts.length === 1 && fractionStr.includes('/')) {
            const fracParts = fractionStr.split('/');
             if (fracParts.length === 2) {
                const numerator = formatArabicNumerals(parseFloat(fracParts[0]));
                const denominator = formatArabicNumerals(parseFloat(fracParts[1]));
                return `<div class="fraction-display"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></div>`;
            }
        }
        
        return formatResult(fractionStr);
    }
    
    function convertArabicToStandard(str) {
         if (typeof str !== 'string') return str;
        
        str = str.replace(/[,ØŒ]/g, '');

        const arabicMap = {
            'Ù ': '0', 'Ù¡': '1', 'Ù¢': '2', 'Ù£': '3', 'Ù¤': '4',
            'Ù¥': '5', 'Ù¦': '6', 'Ù§': '7', 'Ù¨': '8', 'Ù©': '9',
            'Ù«': '.', 'ØŒ': '.'
        };
        return str.replace(/[Ù -Ù©Ù«ØŒ]/g, match => arabicMap[match] || match);
    }

    // =======================================================
    // ğŸ’¾ Ø¯ÙˆØ§Ù„ Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø¹Ø·Ù„Ø©)
    // =======================================================
    function saveGlobalScores() { /* Ù„Ø§ ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ iOS */ }
    function loadGlobalScores() { globalScores = {}; } 
    function saveAppState() { /* Ù„Ø§ ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ iOS */ }

    // =======================================================
    // âŒš Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ§Ù„ØªØ­Ù‚Ù‚ (ØªÙ… ØªØ¨Ø³ÙŠØ·Ù‡Ø§ Ù„Ù€ iOS)
    // =======================================================

    function clearTimer() {
        if (timerInterval !== null) {
            clearInterval(timerInterval);
            timerInterval = null; 
        }
        document.getElementById('timer-display').style.color = '#333';
        timeRemaining = TIME_LIMIT; // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚ÙŠÙ…Ø©
    }
    
    function handleTimeUp() {
        clearTimer(); 
        isProcessingClick = true; 
        document.getElementById('timer-display').innerHTML = `${formatArabicNumerals(0)} Ø«ÙˆØ§Ù†Ù`;
        disableChoices(true); 
        const formattedCorrect = formatFractionForDisplay(correctAnswer || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'); 
        document.getElementById('feedback').innerHTML = `<span class="wrong">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: **${formattedCorrect}**</span>`;
        handleTrainingAnswer(false); 
    }
    
    // ğŸ”¥ ØªØ¨Ø³ÙŠØ· Ø¢Ù„ÙŠØ© Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ØªÙ‚Ù„ÙŠÙ„ ØªØ­Ø¯ÙŠØ« DOM Ø§Ù„Ù…ØªÙƒØ±Ø±
    function startTimer(duration) {
        clearTimer(); 
        TIME_LIMIT = duration;
        timeRemaining = duration;
        timerStartTime = Date.now(); 
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.innerHTML = `${formatArabicNumerals(timeRemaining)} Ø«ÙˆØ§Ù†Ù`;

        const updateTimer = () => {
             const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
             timeRemaining = TIME_LIMIT - elapsed;

             if (timeRemaining <= 0) {
                 handleTimeUp();
                 return;
             }
             
             // Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø£Ùˆ ÙÙŠ Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ Ø§Ù„Ø®Ù…Ø³ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
             if (elapsed % 1 === 0 || timeRemaining <= 5) {
                 timerDisplay.innerHTML = `${formatArabicNumerals(timeRemaining)} Ø«ÙˆØ§Ù†Ù`;
                 timerDisplay.style.color = timeRemaining <= 5 ? 'red' : '#333';
             }
        };

        timerInterval = setInterval(updateTimer, 500); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 500 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„

        // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ ÙÙˆØ±Ø§Ù‹
        updateTimer();
    }
    
    function updateTrainingProgressDisplay() {
        const opType = document.getElementById('operation-select').value;
        const opName = document.querySelector(`#operation-select option[value="${opType}"]`).textContent;
        
        const totalQuestionsForLevel = QUESTIONS_PER_LEVEL; 
        
        const activePlayer = currentStudent;
        
        let details = `Ø§Ù„Ù‚Ø³Ù…: **${opName}** | Ø§Ù„Ù…Ø³ØªÙˆÙ‰: **${formatArabicNumerals(currentLevel)}**`;
        let remaining = totalQuestionsForLevel - levelQuestionsAnswered;
        let thresholdInfo = `(Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: **${formatArabicNumerals((remaining > 0 ? remaining : 0))}** Ø³Ø¤Ø§Ù„)`;
        
        document.getElementById('progress-display').innerHTML = 
            `Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ: **${activePlayer}** | ${details}<br>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${formatArabicNumerals(levelCorrectAnswers)} / ${formatArabicNumerals(levelQuestionsAnswered)}<br>
             ${thresholdInfo}<br>
             Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© Ù„Ù€ ${activePlayer}: **${formatArabicNumerals(globalScores[activePlayer] || 0)}**`;
    }
    
    function handleTrainingAnswer(isCorrect) {
        
        levelQuestionsAnswered++;
        
        const activePlayerName = currentStudent;
        
        if (isCorrect) {
            levelCorrectAnswers++;
            globalScores[activePlayerName] = (globalScores[activePlayerName] || 0) + 1; 
            saveGlobalScores(); 
        }
        
        // ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù…Ù†Ø·Ù‚ ØªÙ†Ø§ÙˆØ¨ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
        
        saveAppState(); 

        updateTrainingProgressDisplay();
        
        const totalQuestions = QUESTIONS_PER_LEVEL; 

        if (levelQuestionsAnswered >= totalQuestions) {
            processTrainingLevelEnd();
        } else {
            setTimeout(() => {
                isProcessingClick = false; 
                generateQuestion();
            }, 2000); 
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙØ±Ø¯ÙŠ)
        document.getElementById('current-player').innerHTML = `**${currentStudent}** (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${formatArabicNumerals(currentLevel)})`;
    }
    
    function processTrainingLevelEnd() {
        clearTimer(); 
        isProcessingClick = false; 
        
        const totalQuestions = QUESTIONS_PER_LEVEL; 
        const mastered = levelCorrectAnswers >= TRAINING_MASTER_THRESHOLD;
        
        document.getElementById('level-navigation').style.display = 'flex';
        disableChoices(true);
        
        if (mastered) {
             if (currentLevel < 3) {
                 document.getElementById('feedback').innerHTML = `<h1>ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ØªÙ‚Ù†Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${formatArabicNumerals(currentLevel)}**! ğŸ‰</h1>`;
                 const nextLevel = currentLevel + 1;
                 document.getElementById('next-level-btn').textContent = `âœ… Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${formatArabicNumerals(nextLevel)}`;
                 document.getElementById('repeat-level-btn').textContent = `ğŸ”„ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${formatArabicNumerals(currentLevel)}`;
             } else {
                 let finalMsg = `ğŸ† ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£ØªÙ‚Ù†Øª Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…!`;
                 document.getElementById('feedback').innerHTML = `<h1>${finalMsg}</h1>
                                                                 <h2>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨.</h2>`;
                 resetGameDisplay();
                 document.getElementById('activate-training-btn').style.display = 'block';
                 return;
             }

             document.getElementById('next-level-btn').style.display = 'inline-block'; 
             document.getElementById('repeat-level-btn').style.display = 'inline-block'; 
             
        } else {
             let failMsg = `<h1>ğŸ¤” Ù„Ù… ØªØªÙ‚Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${formatArabicNumerals(currentLevel)}** ( ${formatArabicNumerals(levelCorrectAnswers)}/${formatArabicNumerals(totalQuestions)} ).</h1>`;
             document.getElementById('feedback').innerHTML = failMsg;
             
             document.getElementById('next-level-btn').style.display = 'none'; 
             document.getElementById('repeat-level-btn').textContent = `ğŸ”„ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${formatArabicNumerals(currentLevel)}`;
             document.getElementById('repeat-level-btn').style.display = 'inline-block';
        }
        
        document.getElementById('expression-display').textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©...';
    }
    
    function startNewLevel(moveToNext = false) {
        let opType = document.getElementById('operation-select').value;
        TIME_LIMIT = parseInt(document.getElementById('time-limit-select').value);
        
        const nameInput = document.getElementById('student-name-input').value.trim();
        if (!nameInput) {
            document.getElementById('feedback').innerHTML = `<span class="wrong">âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨. Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø£ÙˆÙ„Ø§Ù‹.</span>`;
            return;
        }
        currentStudent = nameInput; 

        if (moveToNext && levelCorrectAnswers >= TRAINING_MASTER_THRESHOLD) {
            currentLevel++; 
        } else if (levelQuestionsAnswered === 0 || opType !== document.getElementById('operation-select').value || !moveToNext) {
            currentLevel = parseInt(document.getElementById('initial-level-select').value);
        }

        
        if (currentLevel > 3) {
            resetGameDisplay();
            document.getElementById('activate-training-btn').style.display = 'block';
            return;
        }
        
        generateQuestionQueue(opType, currentLevel);
        document.getElementById('initial-level-select').value = currentLevel; 
        document.getElementById('level-navigation').style.display = 'none';
        
        
        const activePlayer = currentStudent;
        let playerDisplay = `**${activePlayer}** (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${formatArabicNumerals(currentLevel)})`;
        
        document.getElementById('current-player').innerHTML = playerDisplay;
        document.getElementById('current-player').style.color = '#28a745';
        
        levelCorrectAnswers = 0;
        levelQuestionsAnswered = 0;
        
        disableChoices(false);
        updateTrainingProgressDisplay(); 
        
        const opName = document.querySelector(`#operation-select option[value="${opType}"]`).textContent;
        document.getElementById('feedback').innerHTML = `<span class="correct">Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${formatArabicNumerals(currentLevel)}** ÙÙŠ Ù‚Ø³Ù… **${opName}** Ù„Ù€ **${currentStudent}**... Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚!</span>`;
        
        saveAppState(); 

        setTimeout(generateQuestion, 500); 
    }
    
    function resetGameDisplay() {
        clearTimer();
        gameStarted = false;
        isProcessingClick = false; 
        
        document.getElementById('activate-training-btn').style.display = 'block'; 
        document.getElementById('level-navigation').style.display = 'none'; 
        
        document.getElementById('names-input-section').style.display = 'flex';
        disableChoices(true);
        
        document.getElementById('current-player').innerHTML = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ';
        document.getElementById('current-player').style.color = '#333';
        
        const selectedTime = document.getElementById('time-limit-select').value;
        TIME_LIMIT = parseInt(selectedTime);
        document.getElementById('timer-display').innerHTML = `${formatArabicNumerals(TIME_LIMIT)} Ø«ÙˆØ§Ù†Ù`;
        
        document.getElementById('feedback').innerHTML = '';
        document.getElementById('progress-display').innerHTML = '';
        
        document.getElementById('expression-display').textContent = 'Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
        document.getElementById('answer-choices').innerHTML = '';
        
        currentQuestionQueue = []; 

        currentLevel = 1; 
        
        globalScores = {};
        
        saveAppState(); 
    }

    function startTrainingProcess() { 
        
        const nameInput = document.getElementById('student-name-input').value.trim().replace(/^['"]|['"]$/g, '');
        
        if (nameInput.length === 0) { 
            document.getElementById('feedback').innerHTML = `<span class="wrong">âŒ Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ **Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨** Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨.</span>`;
            document.getElementById('activate-training-btn').style.display = 'block'; 
            document.getElementById('names-input-section').style.display = 'flex'; 
            return;
        }
        
        currentStudent = nameInput;
        // Ø¥Ù„ØºØ§Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ù†Ø§ÙØ³
        
        document.getElementById('student-name-input').value = currentStudent; 
        
        globalScores = {};
        globalScores[currentStudent] = 0;
        
        saveGlobalScores(); 
        
        gameStarted = true;
        currentLevel = parseInt(document.getElementById('initial-level-select').value); 
        TIME_LIMIT = parseInt(document.getElementById('time-limit-select').value);

        document.getElementById('activate-training-btn').style.display = 'none'; 
        document.getElementById('names-input-section').style.display = 'flex'; // Ù†Ø¹Ø±Ø¶Ù‡ ÙƒØ¬Ø²Ø¡ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…

        document.getElementById('level-navigation').style.display = 'flex'; 
        
        const opType = document.getElementById('operation-select').value;
        document.getElementById('next-level-btn').textContent = `âœ… Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${formatArabicNumerals(currentLevel)}`;
        document.getElementById('repeat-level-btn').style.display = 'none';
        
        let playerDisplay = `**${currentStudent}** (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${formatArabicNumerals(currentLevel)})`;
        document.getElementById('current-player').innerHTML = playerDisplay;
        document.getElementById('current-player').style.color = '#007BFF';
        
        levelCorrectAnswers = 0;
        levelQuestionsAnswered = 0;
        currentQuestionQueue = [];
        
        updateTrainingProgressDisplay();
        saveAppState();

        let startMessage = `âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù€ **${currentStudent}** ÙÙŠ Ù‚Ø³Ù… **${document.querySelector(`#operation-select option[value="${opType}"]`).textContent}**. Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†!`;
        
        document.getElementById('feedback').innerHTML = `<span class="correct">${startMessage}</span>`;
        
        startNewLevel(true); 
    }
    
    // =======================================================
    // ğŸ§® Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©
    // =======================================================
    
    function generateQuestionQueue(section, level) {
        currentQuestionQueue = [];
        const operations = SECTION_OPERATIONS[section];
        
        for (let i = 0; i < QUESTIONS_PER_LEVEL; i++) {
             let op;
             if (section === 'METRIC') {
                  op = getRandomElement(operations); // Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø·ÙˆÙ„ØŒ Ø³Ø¹Ø©ØŒ ÙƒØªÙ„Ø©)
             } else {
                  op = getRandomElement(operations); // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©/Ø§Ù„ÙƒØ³Ø±ÙŠØ©
             }
             currentQuestionQueue.push({ op: op, level: level });
        }

        // Ø®Ù„Ø· Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        for (let i = currentQuestionQueue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [currentQuestionQueue[i], currentQuestionQueue[j]] = [currentQuestionQueue[j], currentQuestionQueue[i]];
        }
    }
    
    // Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØ³ÙˆØ± ÙˆØ§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¡
    function gcd(a, b) {
        return b === 0 ? a : gcd(b, a % b);
    }

    function simplifyFraction(numerator, denominator) {
        if (numerator === 0) return [0, 1];
        const common = gcd(Math.abs(numerator), Math.abs(denominator));
        return [numerator / common, denominator / common];
    }
    
    function generateProperFraction(level) {
        let maxDenom = 10;
        if (level === 2) maxDenom = 15;
        if (level === 3) maxDenom = 20;

        let d, n;
        do {
            d = getRandomInt(2, maxDenom);
            n = getRandomInt(1, d - 1);
            [n, d] = simplifyFraction(n, d);
        } while (d === 1 || n === 0);
        return { n, d };
    }
    
    function generateFractionChoices(correctAnswer, opType) {
        let choices = [];
        let correctAnswerString = correctAnswer.toString();
        const correctNum = parseFloat(convertArabicToStandard(correctAnswerString));

        choices.push(correctAnswerString);

        while (choices.length < 4) {
             let distractor;
             if (opType.includes('DEC_TO_FRAC') || opType.includes('SIMPLIFY') || opType.includes('MIXED_TO_IMPROP') || opType.includes('IMPROP_TO_MIXED')) {
                  // ØªÙˆÙ„ÙŠØ¯ Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø¶Ù„Ù„Ø© Ù„Ù„ÙƒØ³ÙˆØ±
                  let n1, d1;
                  do {
                      ({ n: n1, d: d1 } = generateProperFraction(1));
                      distractor = `${n1}/${d1}`;
                  } while (choices.includes(distractor) || distractor === correctAnswerString);
                  
                  if (opType === 'MIXED_TO_IMPROP' || opType === 'IMPROP_TO_MIXED') {
                      let wholePart = Math.floor(correctNum);
                      let fracPart = correctNum - wholePart;
                      
                      if (opType === 'MIXED_TO_IMPROP') {
                           // Ø®ÙŠØ§Ø± Ù‚Ø±ÙŠØ¨ Ø¨Ø®Ø·Ø£ ÙÙŠ Ø¶Ø±Ø¨ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­
                           distractor = `${(wholePart + 1) * d1 + n1}/${d1}`;
                           
                      } else if (opType === 'IMPROP_TO_MIXED') {
                           // Ø®ÙŠØ§Ø± Ù‚Ø±ÙŠØ¨ Ø¨Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
                           if (Math.random() < 0.5) {
                                distractor = `${wholePart} ${n1 + 1}/${d1}`;
                           } else {
                                distractor = `${wholePart - 1} ${n1}/${d1}`;
                           }
                      }
                  }

             } else {
                  // ØªÙˆÙ„ÙŠØ¯ Ù‚ÙŠÙ…Ø© Ø¹Ø´Ø±ÙŠØ©/Ù…Ø¦ÙˆÙŠØ© Ù‚Ø±ÙŠØ¨Ø©
                  let offset = getRandomInt(1, 10) * (getRandomElement([0.01, 0.05, 0.1])); 
                  offset *= getRandomElement([1, -1]);
                  distractor = correctNum + offset;
                  
                  if (opType.includes('DEC_TO_PER') || opType.includes('PER_TO_DEC')) {
                      distractor = (distractor * 100).toFixed(1).replace(/\.?0+$/, '') + '%';
                  } else {
                      distractor = distractor.toFixed(2);
                  }
             }
             
             distractor = distractor.toString().replace(/\s/g, ''); 
             if (!choices.includes(distractor) && !choices.includes(formatFractionForDisplay(distractor))) {
                 choices.push(distractor);
             }
        }
        
        // Ø®Ù„Ø· ÙˆØªØ±ØªÙŠØ¨
        for (let i = choices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [choices[i], choices[j]] = [choices[j], choices[i]];
        }
        
        return choices.map(formatFractionForDisplay);
    }
    
    function generateStatsData(level, count) {
        let maxVal = 100;
        let minVal = 10;
        if (level === 2) { maxVal = 200; minVal = 50; }
        if (level === 3) { maxVal = 500; minVal = 100; }
        
        let data = [];
        for (let i = 0; i < count; i++) {
            data.push(getRandomInt(minVal, maxVal));
        }
        return data.sort((a, b) => a - b);
    }
    
    function calculateStats(data, opType) {
        data.sort((a, b) => a - b);
        const n = data.length;

        if (opType === 'RANGE') {
            return data[n - 1] - data[0];
        } else if (opType === 'MEAN') {
            const sum = data.reduce((a, b) => a + b, 0);
            const mean = sum / n;
            return Math.round(mean * 10) / 10; // ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ Ù…Ù†Ø²Ù„Ø© Ø¹Ø´Ø±ÙŠØ©
        } else if (opType === 'MEDIAN') {
            if (n % 2 === 1) {
                return data[Math.floor(n / 2)];
            } else {
                return (data[n / 2 - 1] + data[n / 2]) / 2;
            }
        } else if (opType === 'MODE') {
            const counts = {};
            data.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
            let mode = [];
            let maxCount = 0;
            for (const key in counts) {
                if (counts[key] > maxCount) {
                    maxCount = counts[key];
                    mode = [parseInt(key)];
                } else if (counts[key] === maxCount) {
                    mode.push(parseInt(key));
                }
            }
            return (maxCount === 1 || mode.length === n) ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯" : mode.join(', ');
        }
    }
    
    function generateStatsQuestion(level, opType) {
        let count = getRandomInt(4, 7);
        if (level >= 2) count = getRandomInt(6, 9);
        
        const data = generateStatsData(level, count);
        const question = `Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${data.map(formatArabicNumerals).join(', ')}<br> Ù…Ø§ Ù‡Ùˆ ${opType === 'RANGE' ? 'Ø§Ù„Ù…Ø¯Ù‰' : opType === 'MEAN' ? 'Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠ' : opType === 'MODE' ? 'Ø§Ù„Ù…Ù†ÙˆØ§Ù„' : 'Ø§Ù„ÙˆØ³ÙŠØ·'}ØŸ`;
        const result = calculateStats(data, opType);
        
        return { question: question, result: result };
    }
    
    function generateFractionQuestion(level, opType) {
        let q = '', r = '';
        const { n: n1, d: d1 } = generateProperFraction(level);
        
        if (opType === 'SIMPLIFY') {
            let common = getRandomInt(2, 5);
            if (level >= 2) common = getRandomInt(5, 12);
            const num = n1 * common;
            const den = d1 * common;
            q = `Ø¨ÙØ³Ù‘ÙØ· Ø§Ù„ÙƒØ³Ø±: ${formatFractionForDisplay(`${num}/${den}`)} Ø¥Ù„Ù‰ Ø£Ø¨Ø³Ø· ØµÙˆØ±Ø©.`;
            r = `${n1}/${d1}`;
        } else if (opType === 'DEC_TO_FRAC') {
            let maxDenom = 10; 
            if (level >= 2) maxDenom = 20;
            const d = getRandomElement([10, 100]);
            const num = getRandomInt(1, d - 1);
            const decimal = (num / d);
            
            q = `Ø­ÙˆÙ‘Ù„ Ø§Ù„ÙƒØ³Ø± Ø§Ù„Ø¹Ø´Ø±ÙŠ: ${formatArabicNumerals(decimal)} Ø¥Ù„Ù‰ ÙƒØ³Ø± Ø§Ø¹ØªÙŠØ§Ø¯ÙŠ ÙÙŠ Ø£Ø¨Ø³Ø· ØµÙˆØ±Ø©.`;
            r = simplifyFraction(num, d).join('/');
        } else if (opType === 'FRAC_TO_DEC') {
            const num = getRandomInt(1, 9);
            const den = getRandomElement([2, 4, 5, 8, 10]);
            q = `Ø­ÙˆÙ‘Ù„ Ø§Ù„ÙƒØ³Ø±: ${formatFractionForDisplay(`${num}/${den}`)} Ø¥Ù„Ù‰ Ø¹Ø¯Ø¯ Ø¹Ø´Ø±ÙŠ.`;
            r = (num / den).toString();
        } else if (opType === 'DEC_TO_PER') {
            const dec = getRandomInt(10, 99) / 100;
            q = `Ø­ÙˆÙ‘Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø´Ø±ÙŠ: ${formatArabicNumerals(dec)} Ø¥Ù„Ù‰ Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ©.`;
            r = `${(dec * 100).toFixed(1).replace(/\.?0+$/, '')}%`;
        } else if (opType === 'PER_TO_DEC') {
            const per = getRandomInt(10, 99);
            q = `Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: ${formatArabicNumerals(per)}% Ø¥Ù„Ù‰ Ø¹Ø¯Ø¯ Ø¹Ø´Ø±ÙŠ.`;
            r = (per / 100).toFixed(2);
        } else if (opType === 'MIXED_TO_IMPROP') {
            const whole = getRandomInt(1, 5);
            const n = getRandomInt(1, 5);
            const d = getRandomInt(2, 6);
            q = `Ø­ÙˆÙ‘Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ³Ø±ÙŠ: ${formatFractionForDisplay(`${whole} ${n}/${d}`)} Ø¥Ù„Ù‰ ÙƒØ³Ø± ØºÙŠØ± ÙØ¹Ù„ÙŠ.`;
            r = `${whole * d + n}/${d}`;
        } else if (opType === 'IMPROP_TO_MIXED') {
            const d = getRandomInt(2, 6);
            const num = getRandomInt(d + 1, d * 3);
            q = `Ø­ÙˆÙ‘Ù„ Ø§Ù„ÙƒØ³Ø± ØºÙŠØ± Ø§Ù„ÙØ¹Ù„ÙŠ: ${formatFractionForDisplay(`${num}/${d}`)} Ø¥Ù„Ù‰ Ø¹Ø¯Ø¯ ÙƒØ³Ø±ÙŠ.`;
            const whole = Math.floor(num / d);
            const remainder = num % d;
            const [sn, sd] = simplifyFraction(remainder, d);
            r = `${whole} ${sn}/${sd}`;
            if (remainder === 0) r = whole.toString();
        } else {
             q = `Ù…Ø§ Ù‡Ùˆ Ù†Ø§ØªØ¬ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ`;
             r = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }
        
        return { question: q, result: r };
    }
    
    function generateMetricConversion(unitCategory, level) {
        const units = METRIC_UNITS[unitCategory];
        const keys = Object.keys(units).filter(k => k.length < 4); // ['ÙƒÙ…', 'Ù…', 'Ø³Ù…', 'Ù…Ù„Ù…']

        let fromUnit, toUnit;
        
        // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1: ØªØ­ÙˆÙŠÙ„Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© (ÙƒÙ… -> Ù…ØŒ Ù… -> Ø³Ù…)
        if (level === 1) {
            do {
                fromUnit = getRandomElement(keys);
                toUnit = getRandomElement(keys);
            } while (Math.abs(keys.indexOf(fromUnit) - keys.indexOf(toUnit)) > 1 || fromUnit === toUnit); 
        } 
        // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2: ØªØ­ÙˆÙŠÙ„Ø§Øª Ø®Ø·ÙˆØªÙŠÙ† (ÙƒÙ… -> Ø³Ù…)
        else if (level === 2) {
             do {
                fromUnit = getRandomElement(keys);
                toUnit = getRandomElement(keys);
            } while (Math.abs(keys.indexOf(fromUnit) - keys.indexOf(toUnit)) <= 1 || fromUnit === toUnit); 
        } 
        // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3: Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ø£ØµØ¹Ø¨ ÙˆØ§Ù„ÙƒØ³ÙˆØ±
        else {
             fromUnit = getRandomElement(keys);
             toUnit = getRandomElement(keys);
        }

        const conversionFactor = units[fromUnit] / units[toUnit];
        
        let initialValue;
        if (level === 1) { initialValue = getRandomInt(1, 100); }
        else if (level === 2) { initialValue = getRandomInt(10, 500); }
        else { initialValue = getRandomInt(1, 500) / (getRandomElement([1, 10, 100])); } // Ù‚ÙŠÙ… Ø¹Ø´Ø±ÙŠØ©

        const result = initialValue * conversionFactor;
        
        const question = `Ø­ÙˆÙ‘Ù„ ${formatArabicNumerals(initialValue)} ${units[`${fromUnit}_name`]} Ø¥Ù„Ù‰ ${units[`${toUnit}_name`]}.`;
        
        return { 
            question: question, 
            result: parseFloat(result.toFixed(4)), // ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ø£Ø±Ø¨Ø¹ Ù…Ù†Ø§Ø²Ù„
            from: fromUnit, 
            to: toUnit 
        };
    }
    
    function generateGenericChoices(correctAnswer) {
        let choices = [correctAnswer.toString()];
        const correctNum = parseFloat(convertArabicToStandard(correctAnswer.toString()));

        while (choices.length < 4) {
            let offset;
            if (correctNum > 100) {
                 offset = getRandomInt(1, 50) * getRandomElement([1, -1]);
            } else if (correctNum > 10) {
                 offset = getRandomInt(1, 10) * getRandomElement([1, -1]);
            } else {
                 offset = getRandomElement([0.1, 0.5, 1, 2]) * getRandomElement([1, -1]);
            }
            
            let distractor = correctNum + offset;
            distractor = Math.round(distractor * 100) / 100; // Ù„Ø¶Ù…Ø§Ù† Ø±Ù‚Ù…ÙŠÙ† Ø¹Ø´Ø±ÙŠÙŠÙ†

            if (distractor <= 0 && correctNum > 0 && correctNum > 1) continue; 
            
            const distractorStr = formatResult(distractor).toString();

            if (!choices.includes(distractorStr)) {
                choices.push(distractorStr);
            }
        }

        for (let i = choices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [choices[i], choices[j]] = [choices[j], choices[i]];
        }
        return choices.map(c => formatFractionForDisplay(c.toString()));
    }

    // =======================================================
    // ğŸ–¥ï¸ Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„
    // =======================================================
    
    function renderChoices(choices) {
        const choicesDiv = document.getElementById('answer-choices');
        choicesDiv.innerHTML = '';
        choices.forEach(choice => {
            const button = document.createElement('button');
            button.className = 'choice-btn';
            button.innerHTML = choice; 
            button.onclick = () => checkAnswer(button);
            choicesDiv.appendChild(button);
        });
    }

    function disableChoices(disabled) {
        document.querySelectorAll('.choice-btn').forEach(button => {
            button.disabled = disabled;
        });
    }

    function checkAnswer(selectedButton) {
        if (isProcessingClick) return; 
        isProcessingClick = true; 
        clearTimer(); 
        disableChoices(true);

        const selectedAnswerText = selectedButton.textContent.trim();
        let isCorrect = false;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        const formattedCorrect = formatFractionForDisplay(correctAnswer);

        // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ³ÙˆØ± Ø§Ù„Ù…Ø±Ø¦ÙŠ)
        const selectedStandard = convertArabicToStandard(selectedAnswerText.replace(/<[^>]*>?/gm, ''));
        const correctStandard = convertArabicToStandard(correctAnswer);
        
        if (selectedStandard.toLowerCase() === correctStandard.toLowerCase()) {
             isCorrect = true;
        } else {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ù‚Ø§Ø±Ù†Ø© Ø¹Ø¯Ø¯ÙŠØ© Ù„Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© ÙˆØ§Ù„ÙƒØ³ÙˆØ±
            const numSelected = parseFloat(selectedStandard);
            const numCorrect = parseFloat(correctStandard);
            if (!isNaN(numSelected) && !isNaN(numCorrect) && Math.abs(numSelected - numCorrect) < 0.001) {
                isCorrect = true;
            }
        }
        
        if (isCorrect) {
            selectedButton.style.backgroundColor = '#d4edda';
            selectedButton.style.border = '3px solid #28a745';
            document.getElementById('feedback').innerHTML = `<span class="correct">ØµØ­ÙŠØ­! ${getRandomElement(encouragingPhrases)}</span>`;
        } else {
            selectedButton.style.backgroundColor = '#f8d7da';
            selectedButton.style.border = '3px solid #dc3545';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„ØµØ­ÙŠØ­
            document.querySelectorAll('.choice-btn').forEach(btn => {
                if (btn.innerHTML === formattedCorrect) {
                    btn.style.backgroundColor = '#fff3cd'; 
                    btn.style.border = '3px solid #FFC107'; 
                    btn.innerHTML = `âœ… ${formattedCorrect}`;
                }
            });

            document.getElementById('feedback').innerHTML = `<span class="wrong">âŒ Ø®Ø·Ø£. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: **${formattedCorrect}**</span>`;
        }

        handleTrainingAnswer(isCorrect);
    }
    
    function generateQuestion() {
        const opType = document.getElementById('operation-select').value;
        
        if (currentQuestionQueue.length === 0) {
            generateQuestionQueue(opType, currentLevel);
            if (currentQuestionQueue.length === 0) {
                 document.getElementById('feedback').innerHTML = `<span class="wrong">âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰.</span>`;
                 return;
            }
        }
        
        clearTimer(); 
        
        const nextQuestion = currentQuestionQueue.shift();
        const operation = nextQuestion.op;
        const level = nextQuestion.level;
        
        questionData = {};

        if (opType === 'STATS') {
             questionData = generateStatsQuestion(level, operation);
        } else if (opType === 'FRACTIONS') {
             questionData = generateFractionQuestion(level, operation);
        } else if (opType === 'METRIC') {
             questionData = generateMetricConversion(operation, level);
        } else {
             document.getElementById('feedback').innerHTML = `<span class="wrong">âŒ Ø®Ø·Ø£: Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….</span>`;
             return;
        }
        
        if (!questionData || questionData.result === undefined || questionData.result === null) {
            document.getElementById('feedback').innerHTML = `<span class="wrong">âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø³Ø¤Ø§Ù„.</span>`;
            return;
        }

        document.getElementById('expression-display').innerHTML = questionData.question;
        correctAnswer = questionData.result.toString(); 

        let choices;
        if (opType === 'FRACTIONS') {
             choices = generateFractionChoices(correctAnswer, operation);
        } else {
             choices = generateGenericChoices(correctAnswer);
        }
        
        renderChoices(choices);
        
        document.getElementById('feedback').innerHTML = ``; // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©

        startTimer(TIME_LIMIT); 
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadGlobalScores(); 
        document.getElementById('activate-training-btn').onclick = startTrainingProcess; 
        
        TIME_LIMIT = parseInt(document.getElementById('time-limit-select').value);
        document.getElementById('timer-display').innerHTML = `${formatArabicNumerals(TIME_LIMIT)} Ø«ÙˆØ§Ù†Ù`;
        
        disableChoices(true);
        document.getElementById('level-navigation').style.display = 'none';
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ 1 ÙÙ‚Ø·
        document.getElementById('current-player').innerHTML = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ';
    });
</script>
</body>
</html>
