<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <style>
        :root {
            --participation: #2980b9; --good: #27ae60; --absent: #f1c40f;
            --talking: #e74c3c; --bad: #8e44ad; --book: #d35400; --writing: #7f8c8d;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; min-height: 100vh; }
        .app-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .main-card { background: white; border-radius: 25px; box-shadow: 0 25px 60px rgba(0,0,0,0.2); overflow: hidden; }
        .app-header { background: #2c3e50; color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        .class-tabs { display: flex; background: #f8f9fa; cursor: pointer; }
        .class-tab { flex: 1; text-align: center; padding: 15px; font-weight: bold; color: #7f8c8d; border-bottom: 4px solid transparent; }
        .class-tab.active { color: #2c3e50; border-bottom-color: #2c3e50; background: white; }
        .class-content { padding: 20px; display: none; }
        .class-content.active { display: block; }
        .student-row { display: grid; grid-template-columns: 1.5fr 1fr 3fr; padding: 15px; border-bottom: 1px solid #eee; align-items: center; }
        .percentage-circle {
            width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; position: relative; margin: 0 auto;
            background: conic-gradient(#4caf50 0% var(--percentage), #f0f0f0 var(--percentage) 100%);
        }
        .percentage-circle::before { content: attr(data-percentage) '%'; position: absolute; width: 55px; height: 55px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        .btn-action { border: none; padding: 10px; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; font-size: 0.8rem; transition: 0.2s; min-width: 60px; }
        .btn-action:hover { transform: translateY(-2px); opacity: 0.9; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 500px; margin: 50px auto; border-radius: 20px; padding: 20px; }
        .history-item { 
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-right: 4px solid;
            transition: transform 0.2s;
        }
        .history-item:hover { transform: translateX(-5px); }
        .control-panel { background: #f8f9fa; padding: 15px; border-radius: 15px; margin-top: 20px; border: 2px dashed #ccc; }
        textarea { width: 100%; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
        .time-badge { background: #2c3e50; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8rem; display: inline-block; margin-left: 5px; }
        .date-badge { background: #3498db; color: white; padding: 3px 8px; border-radius: 15px; font-size: 0.8rem; display: inline-block; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="main-card">
        <div class="app-header">
            <div><h1>ğŸ“Š Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h1><p>ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ | Ù†Ø³Ø¨Ø© Ø¯Ù‚ÙŠÙ‚Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¶ØºØ·Ø§Øª</p></div>
            <button onclick="resetSystem()" style="background:#e74c3c; color:white; border:none; padding:10px; border-radius:10px; cursor:pointer;">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
        <div class="class-tabs">
            <div class="class-tab active" onclick="switchClass('class1')">Ø§Ù„Ø£ÙˆÙ„ (<span id="count-class1">0</span>)</div>
            <div class="class-tab" onclick="switchClass('class2')">Ø§Ù„Ø«Ø§Ù†ÙŠ (<span id="count-class2">0</span>)</div>
            <div class="class-tab" onclick="switchClass('class3')">Ø§Ù„Ø«Ø§Ù„Ø« (<span id="count-class3">0</span>)</div>
        </div>
        <div id="class1-content" class="class-content active"></div>
        <div id="class2-content" class="class-content"></div>
        <div id="class3-content" class="class-content"></div>
    </div>
</div>

<div id="reportModal" class="modal">
    <div class="modal-content">
        <h2 id="reportName">Ø§Ù„Ø³Ø¬Ù„</h2>
        <div id="reportDetails"></div>
        <button onclick="closeModal()" style="width:100%; padding:10px; margin-top:10px; border-radius:10px; border:none; background:#2c3e50; color:white; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script>
    const ACTIONS = {
        P: { name: 'Ù…Ø´Ø§Ø±ÙƒØ©', val: 2, color: '#2980b9' },
        G: { name: 'Ø³Ù„ÙˆÙƒ Ø­Ø³Ù†', val: 1, color: '#27ae60' },
        A: { name: 'ØºÙŠØ§Ø¨', val: 0, color: '#f1c40f' },
        T: { name:' Ø§Ù„ØªØ­Ø¯Ø« ', val: -1, color: '#e74c3c' },
        B: { name: 'Ø³Ù„ÙˆÙƒ Ø³ÙŠØ¡', val: -2, color: '#8e44ad' },
        BK: { name: 'Ø¨Ø¯ÙˆÙ† ÙƒØªØ§Ø¨', val: -1, color: '#d35400' },
        W: { name: 'Ù„Ù… ÙŠÙƒØªØ¨', val: -1, color: '#7f8c8d' }
    };

    let db = JSON.parse(localStorage.getItem('eduDB_v3')) || { class1: {}, class2: {}, class3: {} };
    let currentClass = 'class1';

    function save() { localStorage.setItem('eduDB_v3', JSON.stringify(db)); }

    function switchClass(id) {
        currentClass = id;
        document.querySelectorAll('.class-tab').forEach((t, i) => t.classList.toggle('active', `class${i+1}` === id));
        document.querySelectorAll('.class-content').forEach((c, i) => c.classList.toggle('active', `class${i+1}` === id));
        render();
    }

    // Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    function calculateSmartPercentage(score, clicks) {
        if (clicks === 0) return 50;
        let avg = score / clicks;
        let percentage;
        
        if (avg >= 0) {
            // Ù…Ù† 0 Ø¥Ù„Ù‰ 2 ØªØªØ±Ø¬Ù… Ù…Ù† 50% Ø¥Ù„Ù‰ 100%
            percentage = 50 + (avg * 25); 
        } else {
            // Ù…Ù† 0 Ø¥Ù„Ù‰ -2 ØªØªØ±Ø¬Ù… Ù…Ù† 50% Ø¥Ù„Ù‰ 0%
            percentage = 50 + (avg * 25);
        }
        return Math.round(Math.max(0, Math.min(100, percentage)));
    }

    function addAction(name, key) {
        const act = ACTIONS[key];
        const student = db[currentClass][name];
        const now = new Date();
        
        student.history.push({
            id: Date.now(),
            name: act.name,
            val: act.val,
            color: act.color,
            time: now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }),
            date: now.toLocaleDateString('ar-SA', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }),
            timestamp: now.toISOString()
        });
        
        student.score += act.val;
        save(); 
        render();
    }

    function deleteAction(studentName, id) {
        const s = db[currentClass][studentName];
        const idx = s.history.findIndex(a => a.id === id);
        if (idx > -1) {
            s.score -= s.history[idx].val;
            s.history.splice(idx, 1);
            save(); 
            render(); 
            openReport(studentName);
        }
    }

    function render() {
        const container = document.getElementById(`${currentClass}-content`);
        const students = db[currentClass];
        const names = Object.keys(students).sort((a, b) => a.localeCompare(b, 'ar'));
        document.getElementById(`count-${currentClass}`).textContent = names.length;

        if (names.length === 0) {
            container.innerHTML = `<div class="control-panel"><textarea id="in-${currentClass}" rows="4" placeholder="Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§..."></textarea><button onclick="importNames()">Ø¥Ø¶Ø§ÙØ©</button></div>`;
            return;
        }

        let html = `<div style="background:#f9f9f9; padding:10px; font-weight:bold; display:grid; grid-template-columns:1.5fr 1fr 3.5fr;"><div>Ø§Ù„Ø·Ø§Ù„Ø¨</div><div style="text-align:center">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div><div>Ø§Ù„Ø±ØµØ¯</div></div>`;
        names.forEach(name => {
            const s = students[name];
            const perc = calculateSmartPercentage(s.score, s.history.length);
            html += `
            <div class="student-row">
                <div>
                    <div style="font-weight:bold">${name}</div>
                    <button onclick="openReport('${name}')" style="border:none; background:none; color:blue; cursor:pointer; font-size:0.7rem;">Ø§Ù„Ø³Ø¬Ù„ / ØªØ±Ø§Ø¬Ø¹</button>
                </div>
                <div style="text-align:center">
                    <div class="percentage-circle" style="--percentage:${perc}%" data-percentage="${perc}"></div>
                    <small>Ù†Ù‚Ø§Ø·: ${s.score} | Ø¶ØºØ·Ø§Øª: ${s.history.length}</small>
                </div>
                <div style="display:flex; gap:4px; flex-wrap:wrap;">
                    <button class="btn-action" style="background:${ACTIONS.P.color}" onclick="addAction('${name}','P')">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                    <button class="btn-action" style="background:${ACTIONS.G.color}" onclick="addAction('${name}','G')">Ø³Ù„ÙˆÙƒ +</button>
                    <button class="btn-action" style="background:${ACTIONS.BK.color}" onclick="addAction('${name}','BK')">ÙƒØªØ§Ø¨ âŒ</button>
                    <button class="btn-action" style="background:${ACTIONS.W.color}" onclick="addAction('${name}','W')">Ù„Ù… ÙŠÙƒØªØ¨</button>
                    <button class="btn-action" style="background:${ACTIONS.T.color}" onclick="addAction('${name}','T')">ÙƒÙ„Ø§Ù…</button>
                    <button class="btn-action" style="background:${ACTIONS.B.color}" onclick="addAction('${name}','B')">Ø³Ù„ÙˆÙƒ -</button>
                    <button class="btn-action" style="background:${ACTIONS.A.color}" onclick="addAction('${name}','A')">ØºÙŠØ§Ø¨</button>
                </div>
            </div>`;
        });
        html += `<div class="control-panel"><textarea id="in-${currentClass}" placeholder="Ø£Ø³Ù…Ø§Ø¡ Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea><button onclick="importNames()">Ø¥Ø¶Ø§ÙØ©</button></div>`;
        container.innerHTML = html;
    }

    function importNames() {
        const val = document.getElementById(`in-${currentClass}`).value;
        val.split('\n').forEach(n => { 
            if(n.trim() && !db[currentClass][n.trim()]) {
                db[currentClass][n.trim()] = { score: 0, history: [] }; 
            }
        });
        save(); 
        render();
    }

    function openReport(name) {
        const s = db[currentClass][name];
        document.getElementById('reportName').textContent = `Ø³Ø¬Ù„ ${name}`;
        
        let h = '';
        if (s.history.length === 0) {
            h = '<div style="text-align:center; padding:20px; color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</div>';
        } else {
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø¯Ù…
            h = s.history.slice().reverse().map(a => `
                <div class="history-item" style="border-right-color:${a.color};">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong style="color:${a.color}">${a.name}</strong>
                        <span style="font-weight:bold; color:${a.val > 0 ? '#27ae60' : a.val < 0 ? '#e74c3c' : '#f39c12'}">
                            ${a.val > 0 ? '+' : ''}${a.val}
                        </span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.85rem; color:#666;">
                        <span>ğŸ“… ${a.date}</span>
                        <span>ğŸ•’ ${a.time}</span>
                    </div>
                    <div style="text-align:left; margin-top:5px;">
                        <button onclick="deleteAction('${name}',${a.id})" 
                                style="background:#e74c3c; color:white; border:none; border-radius:5px; padding:4px 8px; cursor:pointer; font-size:0.8rem;">
                            Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø²Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„
        h += `
        <div style="margin-top:20px; text-align:center;">
            <button onclick="exportHistory('${name}')" 
                    style="background:#27ae60; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">
                ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„
            </button>
        </div>`;
        
        document.getElementById('reportDetails').innerHTML = h;
        document.getElementById('reportModal').style.display = 'block';
    }

    function exportHistory(name) {
        const student = db[currentClass][name];
        let csv = 'Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„ÙˆÙ‚Øª,Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡,Ø§Ù„Ù‚ÙŠÙ…Ø©\n';
        
        student.history.forEach(action => {
            csv += `${action.date},${action.time},${action.name},${action.val}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `Ø³Ø¬Ù„_${name}_${new Date().toLocaleDateString('ar-SA')}.csv`);
        link.click();
    }

    function closeModal() { 
        document.getElementById('reportModal').style.display = 'none'; 
    }
    
    function resetSystem() { 
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) { 
            localStorage.clear(); 
            location.reload(); 
        } 
    }
    
    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    window.onload = render;
</script>
</body>
</html>
