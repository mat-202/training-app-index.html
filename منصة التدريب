<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙØ±Ø¯ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ (Ù…Ø­Ø¯Ø«)</title>
    <style>
        /* CSS Ù…ÙØ®ÙÙ ÙˆÙ…ÙÙ†Ø¸Ù… Ø£ÙƒØ«Ø± */
        body { font-family: 'Arial', sans-serif; text-align: center; margin-top: 30px; background-color: #f4f4f9; }
        .initiative-header {
            margin: 20px auto 35px auto; padding: 18px 25px; background-color: #f7f9fc; 
            border: 1px solid #ddd; border-left: 8px solid #007BFF; border-radius: 6px;
            max-width: 1200px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); 
        }
        .initiative-header .title-line { font-size: 1.5em; font-weight: bold; color: #007BFF; margin: 0; }
        .main-content { display: flex; justify-content: center; max-width: 1200px; margin: auto; }
        .container { 
            width: 95%; padding: 25px; border: 5px solid #28a745; border-radius: 15px; 
            background-color: #fff; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); margin: 0;
        }
       
        h1 { color: #28a745; margin-bottom: 25px; }
        
        .names-input-section { margin-bottom: 25px; padding: 18px; border: 1px dashed #ccc; border-radius: 8px; display: flex; justify-content: center; align-items: center; gap: 15px;}
        #student-name-input { padding: 12px; font-size: 1.2em; border: 2px solid #28a745; border-radius: 6px; width: 350px; text-align: right; }
        
        .round-setup { margin-bottom: 25px; padding: 18px; background-color: #e9ecef; border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; }
        .round-setup label { font-weight: bold; font-size: 1.1em; }
        .round-setup select { padding: 10px; font-size: 1.1em; border-radius: 5px; border: 1px solid #FFC107; }

        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 3px solid #eee; padding-bottom: 15px; }
        #timer-display { font-size: 3.0em; font-weight: bold; color: #333; padding: 8px 20px; border: 3px dashed #FFC107; border-radius: 10px; min-width: 150px; }

        #question { font-size: 4.5em; margin: 30px auto; color: #333; min-height: 170px; width: 90%; text-align: center; font-weight: bold; }
        #expression-display { font-size: 1em; padding: 20px; display: block; text-align: center; direction: rtl; } 
        
        /* Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø£Ø³ÙŠ Ø§Ù„Ø¹Ø±Ø¨ÙŠ: RTL ÙˆÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
        .q-line { 
             display: flex; 
             /* Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø§ØªØ¬Ø§Ù‡ RTL) */
             justify-content: flex-end; 
             direction: rtl; 
             padding-bottom: 5px; 
             /* Ù„ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¶ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ù† 90% */
             max-width: 450px; 
             margin: 0 auto; 
        }
        
        #q-op { display: none !important; } 
        
        /* q-op2: Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±Ø£Ø³ÙŠØ© */
        #q-op2 { 
             display: block !important; 
             font-size: 1em; 
             font-weight: bold; 
             width: auto; 
             text-align: right; 
             /* Ù…Ø³Ø§ÙØ© Ø¨Ø³ÙŠØ·Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ø±Ù‚Ù… */
             margin-left: 5px; 
        } 

        #q-line-separator { 
            width: 70%; 
            /* Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ø¹ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
            max-width: 450px;
            height: 3px; 
            background-color: #333; 
            margin: 5px auto 10px auto; 
            align-self: flex-end; 
        }
        
        /* CSS Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø±Ø£Ø³ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø· Ø«Ø§Ø¨Øª Ø§Ù„Ø¹Ø±Ø¶ */
        .vertical-aligned-number {
             direction: ltr; 
             display: inline-block; 
             font-family: monospace, 'Courier New', monospace; 
             white-space: pre; 
             text-align: right; 
             align-self: flex-end;
        }

        #answer-choices { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 30px; }
        .choice-btn {
            padding: 25px 35px; font-size: 2.2em; width: 45%; border: 3px solid #007BFF;
            border-radius: 12px; background-color: #e9f4ff; color: #007BFF;
            cursor: pointer; transition: background-color 0.3s, transform 0.1s; font-weight: bold;
        }
        .choice-btn:hover { background-color: #cce0ff; transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0, 123, 255, 0.3); }
        .choice-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: #eee; }
        
        .correct { color: #28a745; font-weight: bold; font-size: 1.8em; }
        .wrong { color: #dc3545; font-weight: bold; font-size: 1.8em; }

        #activate-training-btn { padding: 14px 30px; font-size: 1.5em; color: white; border: none; cursor: pointer; border-radius: 8px; transition: background-color 0.3s; background-color: #007BFF; } 
        
        /* Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª */
        #level-navigation { 
            display: none; 
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .nav-btn {
            padding: 14px 30px; 
            font-size: 1.5em; 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 8px; 
            transition: background-color 0.3s;
        }
        #next-level-btn { background-color: #28a745; } /* Ø²Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ */
        #repeat-level-btn { background-color: #FFC107; color: #333; } /* Ø²Ø± Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© */
        
    </style>
</head>
<body>

<div class="initiative-header">
    <p class="title-line">Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ÙØ±Ø¯ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ</p>
</div>
<div class="main-content">
    <div class="container" id="game-container">
        <h1>Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</h1>
        
        <div class="names-input-section" id="names-input-section">
             <label for="student-name-input">Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨:</label>
             <input type="text" id="student-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">
        </div>

        <div class="round-setup" id="training-setup">
            
            <label for="initial-level-select">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£ÙˆÙ„ÙŠ:</label>
            <select id="initial-level-select">
                <option value="1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</option>
                <option value="2">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2</option>
                <option value="3">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 3</option>
                <option value="4">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 4</option>
                <option value="5">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5</option>
            </select>
            
            <label for="operation-select">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</label>
            <select id="operation-select">
                <option value="+">Ø¬Ù…Ø¹</option>
                <option value="-">Ø·Ø±Ø­</option>
                <option value="*">Ø¶Ø±Ø¨</option>
                <option value="/">Ù‚Ø³Ù…Ø©</option>
                <option value="R">ØªÙ‚Ø±ÙŠØ¨</option>
                <option value="EVAL">ØªÙ‚ÙˆÙŠÙ… (20 Ø³Ø¤Ø§Ù„)</option> </select>

            <label for="time-limit-select">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©:</label>
            <select id="time-limit-select">
                <option value="30">30 Ø«Ø§Ù†ÙŠØ©</option>
                <option value="60">Ø¯Ù‚ÙŠÙ‚Ø©</option>
                <option value="90">Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ†ØµÙ</option>
                <option value="120">Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†</option>
            </select>
            
            <button id="activate-training-btn" onclick="initializeGame()">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</button> 
            
            <div id="level-navigation">
                <button id="next-level-btn" class="nav-btn" onclick="startNewLevel(true)">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button id="repeat-level-btn" class="nav-btn" onclick="startNewLevel(false)">Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
            </div>
        </div>

        <div class="header-section">
            <div id="turn-indicator">
                Ø§Ù„Ù…ØªØ¯Ø±Ø¨: <span id="current-player" class="player-turn">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</span>
            </div>
            <div id="timer-display">30 Ø«ÙˆØ§Ù†Ù</div> 
        </div>

        <div id="question">
             <div id="expression-display">Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
             
             <div class="q-line" id="q-line-1" style="display: none;">
                 <span id="q-num1"></span>
                 <span id="q-op"></span> 
             </div>
             <div class="q-line" id="q-line-2" style="display: none;">
                 </div>
             <div id="q-line-separator" style="display: none;"></div>
        </div> 
        
        <div id="answer-choices">
            </div>

        <div id="feedback"></div>

        <div class="score-boards">
            <div id="progress-display"></div>
        </div>
    </div>

</div>

<div class="footer">
    Ø¥Ø¹Ø¯Ø§Ø¯: Ø§Ù„Ø£Ø³ØªØ§Ø° Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø§Ù„Ø­Ø¬ÙŠÙ„ÙŠ
</div>

<script>
    let correctAnswer = 0;
    let isProcessing = false;
    let gameStarted = false; 

    let currentStudent = ""; 
    let globalScores = {}; 

    let TIME_LIMIT = 30; 
    let timeRemaining = TIME_LIMIT;
    let timerInterval;

    const ARABIC_LOCALE = 'ar-SA'; 
    
    const TRAINING_MASTER_THRESHOLD = 8; 
    
    // âœ… ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰ Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨
    const LEVEL_QUESTIONS = {
        1: 30, // 3 Ø¬Ø¯Ø§ÙˆÙ„ * 10 Ø£Ø³Ø¦Ù„Ø© (1, 2, 3)
        2: 30, // 3 Ø¬Ø¯Ø§ÙˆÙ„ * 10 Ø£Ø³Ø¦Ù„Ø© (4, 5, 6)
        3: 40, // 4 Ø¬Ø¯Ø§ÙˆÙ„ * 10 Ø£Ø³Ø¦Ù„Ø© (7, 8, 9, 10)
        4: 10, // Ø£Ø³Ø¦Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        5: 10  // Ø£Ø³Ø¦Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    }; 

    const EVALUATION_QUESTIONS_TOTAL = 20; 
    const EVALUATION_OPS = ['+', '-', '*', '/', 'R']; 
    const OPS_SEQUENCE = ['+', '-', '*', '/', 'R']; 
    let evaluationQuestionsQueue = []; 
    
    let currentLevel = 1; 
    let levelCorrectAnswers = 0;
    let levelQuestionsAnswered = 0;
    
    // âœ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©) Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ - ØªØ³ØªØ®Ø¯Ù… Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª 1-3 ÙÙŠ Ø§Ù„Ø¶Ø±Ø¨ ÙˆØ§Ù„Ù‚Ø³Ù…Ø©
    let currentQuestionQueue = []; 
    
    const encouragingPhrases = [
        "Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù…ØªØ§Ø²Ø©! Ø£Ù†Øª Ø¹Ø¨Ù‚Ø±ÙŠ ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨! ğŸš€",
        "Ù…Ø°Ù‡Ù„! Ù‡Ø°Ù‡ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„ØµÙ…ÙŠÙ…! âœ¨",
        "Ø¹Ù…Ù„ Ø±Ø§Ø¦Ø¹! Ø§Ø³ØªÙ…Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙ…ÙŠØ². ğŸ’ª",
        "Ø¥ØªÙ‚Ø§Ù† Ø­Ù‚ÙŠÙ‚ÙŠ! Ø£Ù†Øª Ø³Ø±ÙŠØ¹ ÙˆØ°ÙƒÙŠ. ğŸ§ ",
        "ÙŠØ§ Ù„Ù‡ Ù…Ù† ØªØ±ÙƒÙŠØ²! Ø¥Ø¬Ø§Ø¨ØªÙƒ ØµØ­ÙŠØ­Ø© 100%. âœ…",
        "Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹! Ø®Ø·ÙˆØ§ØªÙƒ Ù†Ø­Ùˆ Ø§Ù„Ø¥ØªÙ‚Ø§Ù† Ø«Ø§Ø¨ØªØ©. ğŸŒŸ",
        "Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©ØŒ ØªÙ‚Ø¯Ù… Ù…Ù…ØªØ§Ø²! ğŸ‘",
        "Ø£Ø¯Ø§Ø¡ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø¥Ø´Ø§Ø¯Ø©! Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù‚Ù…Ø©. ğŸ†"
    ];

    function getRandomEncouragingPhrase() {
        const index = Math.floor(Math.random() * encouragingPhrases.length);
        return encouragingPhrases[index];
    }

    function saveGlobalScores() {
        try {
            localStorage.setItem('mathHeroesTrainingScores', JSON.stringify(globalScores));
            localStorage.setItem('mathHeroesCurrentStudentName', document.getElementById('student-name-input').value); 
        } catch (e) {
            console.error("Could not save scores to localStorage", e);
        }
    }

    function loadGlobalScores() {
        try {
            const savedScores = localStorage.getItem('mathHeroesTrainingScores');
            if (savedScores) {
                globalScores = JSON.parse(savedScores);
            } else {
                globalScores = {};
            }
            
            const savedName = localStorage.getItem('mathHeroesCurrentStudentName');
            if (savedName) {
                document.getElementById('student-name-input').value = savedName;
                currentStudent = savedName; 
            }
        } catch (e) {
            console.error("Could not load scores from localStorage", e);
            globalScores = {}; 
        }
    }
    
    function clearTimer() {
        clearInterval(timerInterval);
        document.getElementById('timer-display').style.color = '#333';
    }
    
    function handleTimeUp() {
        if (!gameStarted || isProcessing) return;

        clearTimer();
        isProcessing = true; 
        
        disableChoices(true);
        
        const roundedCorrect = parseFloat(correctAnswer.toFixed(4));
        document.getElementById('feedback').innerHTML = `<span class="wrong">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: **${formatResult(roundedCorrect)}**</span>`;
        
        handleTrainingAnswer(false); 

        isProcessing = false;
    }

    function startTimer(duration) {
        clearTimer(); 
        timeRemaining = duration;
        const timerDisplay = document.getElementById('timer-display');
        timerDisplay.innerHTML = `${timeRemaining.toLocaleString(ARABIC_LOCALE)} Ø«ÙˆØ§Ù†Ù`;

        timerInterval = setInterval(() => {
            timeRemaining -= 1;
            timerDisplay.innerHTML = `${timeRemaining.toLocaleString(ARABIC_LOCALE)} Ø«ÙˆØ§Ù†Ù`;

            if (timeRemaining <= 5) { 
                timerDisplay.style.color = 'red';
            } else {
                timerDisplay.style.color = '#333';
            }

            if (timeRemaining <= 0) {
                handleTimeUp();
            }
        }, 1000); 
    }
    
    function updateTrainingProgressDisplay() {
        const opType = document.getElementById('operation-select').value;
        // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ
        const totalQuestionsForLevel = LEVEL_QUESTIONS[currentLevel] || 10; 
        
        let details = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰: **${currentLevel}**`;
        let thresholdInfo = `(Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¥ØªÙ‚Ø§Ù†: ${TRAINING_MASTER_THRESHOLD.toLocaleString(ARABIC_LOCALE)})`;

        if (opType === 'EVAL') {
             details = `ØªÙ‚ÙˆÙŠÙ… Ø´Ø§Ù…Ù„`;
             thresholdInfo = `(Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${(EVALUATION_QUESTIONS_TOTAL - levelQuestionsAnswered).toLocaleString(ARABIC_LOCALE)})`;
        } else {
             // âœ… ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª 1-3
             thresholdInfo = `(Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: **${(totalQuestionsForLevel - levelQuestionsAnswered).toLocaleString(ARABIC_LOCALE)}** Ø³Ø¤Ø§Ù„)`;
        }

        document.getElementById('progress-display').innerHTML = 
            `Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ: **${currentStudent}** | ${details}<br>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${levelCorrectAnswers.toLocaleString(ARABIC_LOCALE)} / ${levelQuestionsAnswered.toLocaleString(ARABIC_LOCALE)}<br>
             ${thresholdInfo}<br>
             Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ©: **${(globalScores[currentStudent] || 0).toLocaleString(ARABIC_LOCALE)}**`;
    }
    
    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠ Ø§Ù„ØªØ³Ù„Ø³Ù„
    function getNextOperation(currentOp) {
        const currentIndex = OPS_SEQUENCE.indexOf(currentOp);
        if (currentIndex === -1 || currentIndex === OPS_SEQUENCE.length - 1) {
            return null; // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ© ØªØ§Ù„ÙŠØ© (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ³Ù„Ø³Ù„)
        }
        return OPS_SEQUENCE[currentIndex + 1];
    }


    function handleTrainingAnswer(isCorrect) {
        levelQuestionsAnswered++;
        if (isCorrect) {
            levelCorrectAnswers++;
            globalScores[currentStudent] = (globalScores[currentStudent] || 0) + 1; 
            saveGlobalScores();
        }

        updateTrainingProgressDisplay();
        
        const opType = document.getElementById('operation-select').value;
        const totalQuestions = LEVEL_QUESTIONS[currentLevel] || 10; 

        if (opType === 'EVAL') {
             if (levelQuestionsAnswered >= EVALUATION_QUESTIONS_TOTAL) {
                processEvaluationEnd();
             } else {
                setTimeout(generateQuestion, 2000); 
             }
        } else {
            // âœ… ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±Ø· Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙ‰
            if (levelQuestionsAnswered >= totalQuestions) {
                processTrainingLevelEnd();
            } else {
                setTimeout(generateQuestion, 2000); 
            }
        }
    }
    
    function processEvaluationEnd() {
        clearTimer(); 
        disableChoices(true);
        document.getElementById('level-navigation').style.display = 'flex';
        document.getElementById('next-level-btn').textContent = `Ø§Ø¨Ø¯Ø£ Ù…Ø³ØªÙˆÙ‰ ØªØ¯Ø±ÙŠØ¨ Ø¬Ø¯ÙŠØ¯`;
        document.getElementById('repeat-level-btn').textContent = `Ø£Ø¹Ø¯ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…`;
        document.getElementById('repeat-level-btn').style.display = 'inline-block';
        
        const percentage = (levelCorrectAnswers / EVALUATION_QUESTIONS_TOTAL) * 100;
        
        let message = `<h1>âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…! Ù†ØªØ§Ø¦Ø¬ **${currentStudent}** Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</h1>
                       <h2>Ø§Ù„Ù†ØªÙŠØ¬Ø©: **${levelCorrectAnswers.toLocaleString(ARABIC_LOCALE)}/${EVALUATION_QUESTIONS_TOTAL.toLocaleString(ARABIC_LOCALE)}** (${percentage.toFixed(1).toLocaleString(ARABIC_LOCALE)}%)</h2>`;
        
        document.getElementById('feedback').innerHTML = message;
        document.getElementById('expression-display').textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©...';
    }

    function processTrainingLevelEnd() {
        clearTimer(); 
        const totalQuestions = LEVEL_QUESTIONS[currentLevel] || 10; // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø«Ø§Ø¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const mastered = levelCorrectAnswers >= TRAINING_MASTER_THRESHOLD;
        const currentOp = document.getElementById('operation-select').value;
        
        document.getElementById('level-navigation').style.display = 'flex';
        disableChoices(true);
        
        if (mastered) {
             
             if (currentLevel >= 5) {
                 const nextOp = getNextOperation(currentOp);
                 
                 if (nextOp) {
                      document.getElementById('feedback').innerHTML = `<h1>ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ØªÙ‚Ù†Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${currentLevel}** Ù„Ø¹Ù…Ù„ÙŠØ© ${currentOp === 'R' ? 'Ø§Ù„ØªÙ‚Ø±ÙŠØ¨' : currentOp} !</h1>
                                                                     <h2>ØªÙ†ØªÙ‚Ù„ Ø§Ù„Ø¢Ù† Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1 Ù„Ø¹Ù…Ù„ÙŠØ© ${nextOp === 'R' ? 'Ø§Ù„ØªÙ‚Ø±ÙŠØ¨' : nextOp}.</h2>`;
                      document.getElementById('next-level-btn').textContent = `âœ… Ø§Ø¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© ${nextOp === 'R' ? 'Ø§Ù„ØªÙ‚Ø±ÙŠØ¨' : nextOp} - Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1`;
                      document.getElementById('repeat-level-btn').style.display = 'none'; // Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
                 } else {
                      document.getElementById('feedback').innerHTML = `<h1>ğŸ† ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ØªÙ‚Ù†Øª Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙˆÙŠØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª!</h1>`;
                      resetGameDisplay();
                      document.getElementById('activate-training-btn').style.display = 'block';
                      return;
                 }
             } else {
                 document.getElementById('feedback').innerHTML = `<h1>ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø£ØªÙ‚Ù†Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${currentLevel}**! ğŸ‰</h1>`;
                 const nextLevel = currentLevel + 1;
                 document.getElementById('next-level-btn').textContent = `âœ… Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${nextLevel}`;
                 document.getElementById('repeat-level-btn').textContent = `ğŸ”„ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel}`;
             }

             document.getElementById('next-level-btn').style.display = 'inline-block'; 
             document.getElementById('repeat-level-btn').style.display = 'inline-block'; 
             
        } else {
             // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø«Ø§Ø¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø®ÙØ§Ù‚
             document.getElementById('feedback').innerHTML = `<h1>ğŸ¤” Ù„Ù… ØªØªÙ‚Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${currentLevel}** ( ${levelCorrectAnswers}/${totalQuestions} ).</h1>`;
             
             document.getElementById('next-level-btn').style.display = 'none'; // Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
             document.getElementById('repeat-level-btn').textContent = `ğŸ”„ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel}`;
             document.getElementById('repeat-level-btn').style.display = 'inline-block';
        }
        
        document.getElementById('expression-display').textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©...';
    }
    
    function initializeEvaluationQueue(level) {
        evaluationQuestionsQueue = [];
        const questionsPerOp = EVALUATION_QUESTIONS_TOTAL / EVALUATION_OPS.length; 
        
        EVALUATION_OPS.forEach(op => {
            for (let i = 0; i < questionsPerOp; i++) {
                evaluationQuestionsQueue.push(op);
            }
        });
        
        for (let i = evaluationQuestionsQueue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [evaluationQuestionsQueue[i], evaluationQuestionsQueue[j]] = [evaluationQuestionsQueue[j], evaluationQuestionsQueue[i]];
        }
    }
    
    // âœ… Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø§Ù„Ù…ÙƒØ±Ø±Ø© Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª 1-3)
    function generateTableQuestionQueue(level, op) {
        let queue = [];
        
        // ØªØ­Ø¯ÙŠØ¯ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙŠ Ø³ØªÙƒÙˆÙ† Ø«Ø§Ø¨ØªØ© (Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡ Ø£Ùˆ Ø£Ø­Ø¯ Ø¹ÙˆØ§Ù…Ù„ÙŠ Ø§Ù„Ø¶Ø±Ø¨)
        const ranges = {
            1: [1, 2, 3],       // Ù„Ø¬Ø¯ÙˆÙ„ 1ØŒ 2ØŒ 3
            2: [4, 5, 6],       // Ù„Ø¬Ø¯ÙˆÙ„ 4ØŒ 5ØŒ 6
            3: [7, 8, 9, 10]    // Ù„Ø¬Ø¯ÙˆÙ„ 7ØŒ 8ØŒ 9ØŒ 10
        };

        const fixedNumbers = ranges[level]; 
        
        // Ù†Ø¶Ù…Ù† 10 Ø£Ø³Ø¦Ù„Ø© Ù„ÙƒÙ„ Ø¹Ø¯Ø¯ Ø«Ø§Ø¨Øª (10 Ã— 3 Ø£Ùˆ 10 Ã— 4)
        fixedNumbers.forEach(fixedNum => {
            for (let i = 1; i <= 10; i++) { // Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¢Ø®Ø± Ø³ÙŠÙƒÙˆÙ† Ù…Ù† 1 Ø¥Ù„Ù‰ 10
                if (op === '*') {
                    // Ø§Ù„Ø¶Ø±Ø¨: Ù†1 Ø«Ø§Ø¨ØªØŒ Ù†2 Ù…ØªØºÙŠØ±
                    queue.push({ n1: fixedNum, n2: i, op: '*' }); 
                } else if (op === '/') {
                    // Ø§Ù„Ù‚Ø³Ù…Ø©: Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡ Ø«Ø§Ø¨ØªØŒ Ø§Ù„Ù†Ø§ØªØ¬ Ù…ØªØºÙŠØ±
                    const n2 = fixedNum;       // Ø§Ù„Ù…Ù‚Ø³ÙˆÙ… Ø¹Ù„ÙŠÙ‡
                    const result = i;          // Ø®Ø§Ø±Ø¬ Ø§Ù„Ù‚Ø³Ù…Ø©
                    const n1 = fixedNum * i;   // Ø§Ù„Ù…Ù‚Ø³ÙˆÙ…
                    queue.push({ n1: n1, n2: n2, op: '/' });
                }
            }
        });

        // Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ±ØªÙŠØ¨: Ù†Ø®Ù„Ø· Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        for (let i = queue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [queue[i], queue[j]] = [queue[j], queue[i]];
        }
        
        return queue;
    }
    
    function startNewLevel(moveToNext = false) {
        let opType = document.getElementById('operation-select').value;
        const initialSelectedLevel = parseInt(document.getElementById('initial-level-select').value); 
        TIME_LIMIT = parseInt(document.getElementById('time-limit-select').value);
        
        // ğŸ”„ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5 
        if (moveToNext && opType !== 'EVAL' && currentLevel >= 5 && levelCorrectAnswers >= TRAINING_MASTER_THRESHOLD) {
             const nextOp = getNextOperation(opType);
             if (nextOp) {
                 document.getElementById('operation-select').value = nextOp;
                 document.getElementById('initial-level-select').value = 1;
                 currentLevel = 1;
                 opType = nextOp; // ØªØ­Ø¯ÙŠØ« opType Ù„Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
             } else {
                 return;
             }
        } 

        if (opType !== 'EVAL') {
             if (moveToNext && levelQuestionsAnswered > 0) {
                 currentLevel++; 
             } else if (levelQuestionsAnswered === 0 || opType !== document.getElementById('operation-select').value) { 
                 currentLevel = parseInt(document.getElementById('initial-level-select').value);
             } 
             
             if (currentLevel > 5) {
                return; 
             }
             
             // âœ… ØªÙˆÙ„ÙŠØ¯ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª 1-3 ÙÙŠ Ø§Ù„Ø¶Ø±Ø¨ ÙˆØ§Ù„Ù‚Ø³Ù…Ø©)
             if (currentLevel <= 3 && (opType === '*' || opType === '/')) {
                 currentQuestionQueue = generateTableQuestionQueue(currentLevel, opType);
             } else {
                 currentQuestionQueue = []; // Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª 4 Ùˆ 5 ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
             }
             
             document.getElementById('initial-level-select').value = currentLevel; 
        } else {
             currentLevel = initialSelectedLevel;
             initializeEvaluationQueue(currentLevel);
        }
        
        document.getElementById('level-navigation').style.display = 'none';

        document.getElementById('current-player').innerHTML = `**${currentStudent}** (Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel})`;
        document.getElementById('current-player').style.color = '#28a745';
        
        levelCorrectAnswers = 0;
        levelQuestionsAnswered = 0;
        
        disableChoices(false);
        updateTrainingProgressDisplay(); 
        
        document.getElementById('feedback').innerHTML = `<span class="correct">Ø¨Ø¯Ø¡ ${opType === 'EVAL' ? 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø´Ø§Ù…Ù„' : `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ **${currentLevel}**`} Ù„Ù€ **${currentStudent}**... Ø¨Ø§Ù„ØªÙˆÙÙŠÙ‚!</span>`;
        
        setTimeout(generateQuestion, 500); 
    }
    
    function resetGameDisplay() {
        clearTimer();
        gameStarted = false;
        
        document.getElementById('activate-training-btn').style.display = 'block'; 
        document.getElementById('level-navigation').style.display = 'none'; 
        
        document.getElementById('names-input-section').style.display = 'flex';
        disableChoices(true);
        
        document.getElementById('current-player').innerHTML = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ';
        document.getElementById('current-player').style.color = '#333';
        
        const selectedTime = document.getElementById('time-limit-select').value;
        TIME_LIMIT = parseInt(selectedTime);
        document.getElementById('timer-display').innerHTML = `${TIME_LIMIT.toLocaleString(ARABIC_LOCALE)} Ø«ÙˆØ§Ù†Ù`;
        
        document.getElementById('feedback').innerHTML = '';
        document.getElementById('progress-display').innerHTML = '';
        
        document.getElementById('expression-display').textContent = 'Ø§Ø¶ØºØ· Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
        
        currentQuestionQueue = []; // âœ… Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©

        currentLevel = 1; 
    }

    function initializeGame() { 
        
        const nameInput = document.getElementById('student-name-input').value.trim();
        
        if (nameInput.length === 0) { 
            document.getElementById('feedback').innerHTML = `<span class="wrong">âŒ Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ **Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨** Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨.</span>`;
            document.getElementById('activate-training-btn').style.display = 'block'; 
            return;
        }
        
        currentStudent = nameInput;
        
        if (globalScores[currentStudent] === undefined) {
             globalScores[currentStudent] = 0;
        }
        saveGlobalScores(); 
        
        gameStarted = true;
        currentLevel = parseInt(document.getElementById('initial-level-select').value); 
        TIME_LIMIT = parseInt(document.getElementById('time-limit-select').value);

        document.getElementById('activate-training-btn').style.display = 'none'; 
        document.getElementById('level-navigation').style.display = 'flex'; 
        
        const opType = document.getElementById('operation-select').value;
        if (opType === 'EVAL') {
             document.getElementById('next-level-btn').textContent = `âœ… Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…`;
             document.getElementById('repeat-level-btn').style.display = 'none';
        } else {
             document.getElementById('next-level-btn').textContent = `âœ… Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel}`;
             document.getElementById('repeat-level-btn').style.display = 'none';
        }

        document.getElementById('names-input-section').style.display = 'none';
        
        document.getElementById('current-player').innerHTML = 'Ø¬Ø§Ù‡Ø² Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
        document.getElementById('current-player').style.color = '#007BFF';
        
        updateTrainingProgressDisplay();

        let startMessage = `âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù€ **${currentStudent}**. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± **Ø§Ù„Ø¨Ø¯Ø¡**!`;
        document.getElementById('feedback').innerHTML = `<span class="correct">${startMessage}</span>`;
    }

    // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function getRandomElement(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }
    
    function alignVertical(n1, n2) {
        const space = ' '; 
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… formatResult Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø£Ø±Ù‚Ø§Ù…
        const n1String = formatResult(n1, false); 
        const n2String = formatResult(n2, false); 
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ (Ù…Ø¹ Ø¥Ù‡Ù…Ø§Ù„ Ø§Ù„ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ',' Ù„ØªØ¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø§Ù†Ø§Øª)
        const length1 = n1String.replace(/,/g, '').length;
        const length2 = n2String.replace(/,/g, '').length;
        
        const maxLength = Math.max(length1, length2);
        
        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø´Ùˆ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù†Ø³Ù‚
        const padFormattedNumber = (numStr, targetLength) => {
            // Ø¥Ø²Ø§Ù„Ø© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù Ù…Ø¤Ù‚ØªÙ‹Ø§ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø®Ø§Ù†Ø§Øª
            const currentLength = numStr.replace(/,/g, '').length;
            const paddingNeeded = targetLength - currentLength;
            
            // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù†Ø³Ù‚Ø© (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù)
            let paddedString = numStr;
            for (let i = 0; i < paddingNeeded; i++) {
                paddedString = space + paddedString;
            }
            return paddedString;
        };

        const padded_final1 = padFormattedNumber(n1String, maxLength);
        const padded_final2 = padFormattedNumber(n2String, maxLength);

        const style = ``; 

        return {
            n1Display: `<span class="vertical-aligned-number" style="${style}">${padded_final1}</span>`,
            n2Display: `<span class="vertical-aligned-number" style="${style}">${padded_final2}</span>`, 
        };
    }
    
    function generateNumberWithDigits(maxDigits, maxDecimals = 0) {
        if (maxDigits <= 0) return 0;
        
        let integerDigits = maxDigits; 
        
        let decimalDigits = 0;
        if (maxDecimals > 0) {
            const remainingDigits = Math.max(0, maxDigits - integerDigits);
            decimalDigits = getRandomInt(0, Math.min(maxDecimals, remainingDigits));
        }

        let minInt = (integerDigits === 1) ? 1 : Math.pow(10, integerDigits - 1);
        let maxInt = Math.pow(10, integerDigits) - 1;
        
        if (maxInt > 99999) maxInt = 99999; 
        
        let number = Math.floor(Math.random() * (maxInt - minInt + 1)) + minInt;
        
        if (decimalDigits > 0) {
            let decimalPart = Math.random();
            number = parseFloat((number + decimalPart).toFixed(decimalDigits));
        }
        
        return number;
    }
    
    function getNumberBounds(level, op) {
        const MAX_TOTAL_DIGITS = 5; 
        
        switch (op) {
            case '+': 
            case '-':
                // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ù…Ø¹ ÙˆØ§Ù„Ø·Ø±Ø­ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ
                const numDigits = Math.min(level, MAX_TOTAL_DIGITS);
                return { d1: numDigits, d2: numDigits, dec: 0 }; 
                
            case '*':
                 // Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª 1-3 ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„ØªÙ‡Ø§ Ù…Ù† generateTableQuestionQueue
                if (level === 4) return { d1: getRandomInt(2, 3), d2: 1, dec: 0 }; // 2-3 Ù…Ù†Ø§Ø²Ù„ * 1 Ù…Ù†Ø²Ù„Ø©
                if (level === 5) return { d1: getRandomInt(2, 4), d2: 2, dec: 0 }; // 2-4 Ù…Ù†Ø§Ø²Ù„ * 2 Ù…Ù†Ø²Ù„Ø©
                break;
                
            case '/':
                 // Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª 1-3 ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„ØªÙ‡Ø§ Ù…Ù† generateTableQuestionQueue
                 if (level === 4) return { d1: getRandomInt(2, 3), d2: 1, dec: 0 }; // 2-3 Ù…Ù†Ø§Ø²Ù„ / 1 Ù…Ù†Ø²Ù„Ø© (Ù‚Ø³Ù…Ø© Ù…Ø·ÙˆÙ„Ø©)
                 if (level === 5) return { d1: getRandomInt(2, 4), d2: 2, dec: 0 }; // 2-4 Ù…Ù†Ø§Ø²Ù„ / 2 Ù…Ù†Ø²Ù„Ø© (Ù‚Ø³Ù…Ø© Ù…Ø·ÙˆÙ„Ø©)
                break;
        }
        return { d1: 1, d2: 1, dec: 0 };
    }
    
    function generateOperationQuestion(level, op) {
        // ØªØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª 4 Ùˆ 5 ÙˆØ§Ù„Ø¬Ù…Ø¹ ÙˆØ§Ù„Ø·Ø±Ø­ (ØªÙˆÙ„ÙŠØ¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ)
        const bounds = getNumberBounds(level, op);
        let n1, n2, result;
        
        const maxDigits1 = bounds.d1;
        const maxDigits2 = bounds.d2;
        const maxDecimals = bounds.dec || 0; 
        
        let attempts = 0;
        const maxAttempts = 20;

        do {
            attempts++;
            
            n1 = generateNumberWithDigits(maxDigits1, maxDecimals);
            n2 = generateNumberWithDigits(maxDigits2, maxDecimals);
            
            // ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø¯Ø£: Ø§Ù„Ø£ØµØºØ± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ (n2 Ù‡Ùˆ Ø§Ù„Ø£ØµØºØ± ÙÙŠ Ø§Ù„Ø¶Ø±Ø¨ ÙˆØ§Ù„Ù‚Ø³Ù…Ø©)
            if ((op === '*' || op === '/') && (n1 < n2)) {
                [n1, n2] = [n2, n1]; 
            }
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            if (op === '/') {
                if (n2 === 0) continue; 
                
                // Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„Ù„Ù‚Ø³Ù…Ø© Ø§Ù„Ù…Ø·ÙˆÙ„Ø© (Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª 4, 5 ÙÙŠ Ø§Ù„Ù‚Ø³Ù…Ø©) - Ù†Ø¶Ù…Ù† Ù†Ø§ØªØ¬ ØµØ­ÙŠØ­
                let factor = Math.abs(Math.round(n1 / n2));
                if (factor === 0) factor = 1; 
                n1 = factor * Math.abs(n2); 
                n2 = Math.abs(n2);
                result = factor;
                
            } else if (op === '*') {
                result = n1 * n2;
            } else if (op === '-') {
                 if (n1 <= n2) {
                     let tempN1, tempN2;
                     do {
                          tempN1 = generateNumberWithDigits(bounds.d1, maxDecimals);
                          tempN2 = generateNumberWithDigits(bounds.d2, maxDecimals);
                     } while (tempN1 <= tempN2);
                     n1 = tempN1;
                     n2 = tempN2;
                 }
                result = (maxDecimals === 0) ? Math.round(n1 - n2) : n1 - n2;
            } else { // Ø§Ù„Ø¬Ù…Ø¹ 
                result = (maxDecimals === 0) ? Math.round(n1 + n2) : n1 + n2;
            }
            
        } while (attempts < maxAttempts && op !== 'R' && (result <= 0 || (op === '*' && result === 0) ));


        // Ø¶Ø¨Ø· Ø¯Ù‚Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
        if (op === '*' && level === 5) result = parseFloat(result.toFixed(4));
        if (op === '+' || op === '-') {
             if (level >= 4 && maxDecimals > 0) result = parseFloat(result.toFixed(4));
        }

        return { n1, n2, result };
    }

    // âœ… Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…ÙØ¹Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹
    function generateOperationQuestionFromParams(n1, n2, op) {
         let result;
         if (op === '*') {
             result = n1 * n2;
         } else if (op === '/') {
             result = n1 / n2;
         }
         return { n1, n2, result: Math.round(result) };
    }
    
    function generateRoundingQuestion(level) {
        let numberToRound;
        let roundingPlaceKey;
        let correctAnswerValue;
        
        const generateNumberForRounding = (maxIntDigits, minDecimals, maxDecimals) => {
            const totalDigitsAvailable = 5; 
            
            const actualMaxIntDigits = Math.min(maxIntDigits, totalDigitsAvailable - minDecimals);
            
            if (actualMaxIntDigits <= 0) {
                 const num = Math.random();
                 return parseFloat(num.toFixed(maxDecimals));
            }

            const maxInt = Math.pow(10, actualMaxIntDigits) - 1;
            const minInt = (actualMaxIntDigits === 1) ? 1 : Math.pow(10, actualMaxIntDigits - 1);
            
            const integerPart = getRandomInt(minInt, maxInt);
            
            let decimalPart = Math.random();
            let number = parseFloat((integerPart + decimalPart).toFixed(maxDecimals));

            let numStr = number.toFixed(maxDecimals);
            
            return parseFloat(numStr); 
        };
        
        const MAX_TOTAL_DIGITS = 5; 
        
        if (level === 1) {
            const options = ['Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©', 'Ø£Ù‚Ø±Ø¨ Ù…Ø¦Ø©'];
            roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
            
            let maxDigits;
            if (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©') maxDigits = 4; 
            else maxDigits = 5; 
            
            numberToRound = Math.floor(Math.random() * (Math.pow(10, maxDigits) - 10) + 10); 
            
            const value = (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ø¹Ø´Ø±Ø©') ? 10 : 100;
            correctAnswerValue = Math.round(numberToRound / value) * value;

        } else if (level === 2) {
             const options = ['Ø£Ù‚Ø±Ø¨ Ø£Ù„Ù', 'Ø£Ù‚Ø±Ø¨ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­'];
            roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
            
            if (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­') {
                 const maxIntDigits = MAX_TOTAL_DIGITS - 1; 
                 numberToRound = generateNumberForRounding(maxIntDigits, 1, 2); 
                 correctAnswerValue = Math.round(numberToRound);
            } else {
                 numberToRound = Math.floor(Math.random() * (99999 - 1000) + 1000); 
                 correctAnswerValue = Math.round(numberToRound / 1000) * 1000;
            }
        
        } else if (level === 3) {
            const options = ['Ø£Ù‚Ø±Ø¨ Ø¬Ø²Ø¡ Ù…Ù† Ø¹Ø´Ø±Ø©', 'Ø£Ù‚Ø±Ø¨ Ø¬Ø²Ø¡ Ù…Ù† Ù…Ø¦Ø©'];
            roundingPlaceKey = options[Math.floor(Math.random() * options.length)];
            
            if (roundingPlaceKey === 'Ø£Ù‚Ø±Ø¨ Ø¬Ø²Ø¡ Ù…Ù† Ø¹Ø´Ø±Ø©') {
                 const minDecimals = 2;
                 const maxIntDigits = MAX_TOTAL_DIGITS - minDecimals; 
                 numberToRound = generateNumberForRounding(maxIntDigits, minDecimals, 3);
                 correctAnswerValue = parseFloat(numberToRound.toFixed(1));
            } else { 
                 const minDecimals = 3;
                 const maxIntDigits = MAX_TOTAL_DIGITS - minDecimals; 
                 numberToRound = generateNumberForRounding(maxIntDigits, minDecimals, 4); 
                 correctAnswerValue = parseFloat(numberToRound.toFixed(2));
            }
        
        } else if (level === 4) {
           
